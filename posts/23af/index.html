<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>从阿里规约谈起 - Arrays.asList 三坑</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>归档</a></li><li><a href=https://blog.io01.xyz/about>关于</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>从阿里规约谈起 - Arrays.asList 三坑</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2019-09-24</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#series"/></svg><a href=https://blog.io01.xyz/series/%E9%98%BF%E9%87%8C%E8%A7%84%E7%BA%A6/ class=text-gray-500>阿里规约</a></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/java/ class="text-gray-500 mr-1">Java</a></div></div></div></header><h2 id=前言>前言</h2><p>将数组转换成 List 是日常开发十分常见的操作，对此 JDK 提供了一个非常好用的工具类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>List list <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>但是如果操纵 List 的内容的话，阿里规约会给出一个提示：</p><p><img alt="使用 asList 的问题" title src=https://static.fori.fun/blog/posts/static/p3c_aslist_error.png></p><p>于是深入看了下，发现 <code>Arrays.asList</code> 有三个日常开发中容易坑人的地方。</p><h2 id=坑一>坑一</h2><p>如阿里规约所述，不支持 <code>add/remove/clear</code> 方法。</p><p>当对其使用这三个方法时，会抛出 <code>UnsupportedOperationException</code> 异常，如果没有捕获异常还好，程序运行崩溃，很容易测试出来，如果恰巧捕获了异常，而且直接用的 <code>Exception</code> 来捕获的所有异常，那么只是会造成和预期结果不符而不会崩溃，使得问题十分难以排查。</p><p>我们来看看为什么明明返回是 List，却无法使用 <code>add/remove/clear</code> 方法。</p><p>首先看看 <code>asList()</code> 源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>@SafeVarargs
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>@SuppressWarnings<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;varargs&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> List<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>T<span style=color:#ff79c6>...</span> a<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;(</span>a<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>返回了一个 <code>ArrayList</code>，符合逻辑，一切都很正常。但是，众所周知 ArrayList 当然是支持 <code>add/remove/clear</code> 方法的，那么哪里出了问题呢？点进 <code>ArrayList</code> 才能发现，根本不是我们日常用的 <code>java.util.ArrayList</code> 而是 <code>java.util.Arrays.ArrayList</code>，只是 <code>Arrays</code> 的一个内部类。由于名称完全相同，极具迷惑性，很难发现，这个命名我认为是 JDK 一处设计败笔。</p><p>理顺了这个点，剩下的就很简单了。<code>Arrays.ArrayList</code> 继承自 <code>AbstractList</code> 这个抽象类，如下是 <code>AbstractList</code> 方法中 <code>add</code> 和 <code>remove</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> index<span style=color:#ff79c6>,</span> E element<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> UnsupportedOperationException<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#8be9fd;font-style:italic>public</span> E <span style=color:#50fa7b>remove</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> index<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> UnsupportedOperationException<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>Arrays.ArrayList</code> 并没有具体实现 <code>add/remove/clear</code> 方法，所以当使用 <code>add/remove</code> 方法时，会直接根据 <code>AbstractList</code> 的代码抛出异常，<code>clear</code> 方法也会由于 <code>AbstractList</code> 实现中调用了 <code>remove</code> 方法而出现同样的异常。</p><h2 id=坑二>坑二</h2><p>当改变原数组的值时，List 同样发生变化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>String<span style=color:#ff79c6>[]</span> stringData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;a&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;b&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;c&#34;</span><span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>List stringList <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>stringData<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>stringData<span style=color:#ff79c6>[</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;A&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;stringList: &#34;</span> <span style=color:#ff79c6>+</span> stringList<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>//输出：stringList: [A, b, c]
</span></span></span></code></pre></div><p>根据 <code>Arrays.ArrayList</code> 构造函数可以看到，只是将原数组赋值给了一个内部变量，所以改变原数组的值，List 自然而然也会发生变化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>ArrayList<span style=color:#ff79c6>(</span>E<span style=color:#ff79c6>[]</span> array<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    a <span style=color:#ff79c6>=</span> Objects<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requireNonNull</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=坑三>坑三</h2><p>不适用于基本类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> intData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>2</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>3</span><span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>List intList <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>intData<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;intList: &#34;</span> <span style=color:#ff79c6>+</span> intList<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;intListSize: &#34;</span> <span style=color:#ff79c6>+</span> intList<span style=color:#ff79c6>.</span><span style=color:#50fa7b>size</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>//输出：intList: [[I@7bf40ec]
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4>//输出：intListSize: 1
</span></span></span></code></pre></div><p>通过上面的源码可知，<code>Arrays.asList</code> 接受的是一个变长对象参数。基本类型并不是对象，所以按常规需要装箱操作，但是由于 <code>int[]</code> 本身是一个引用类型，所以 <code>Arrays.asList</code> 得到了一个 <code>int[]</code> 类型的参数，于是可以很容易得出 size 为 1。</p><h2 id=解决方案>解决方案</h2><p>如果不包含基本数据类型，可以转成真正的 ArrayList。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>List list <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;(</span>Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>asList</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>));</span>
</span></span></code></pre></div><p>如果是数组是基本类型的数组，需要自己写循环来转换了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> intData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>2</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>3</span><span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>List intList <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>(</span>intData<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> intDatum <span style=color:#ff79c6>:</span> intData<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    intList<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>intDatum<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>如果开发环境能够使用 Java8 语法，可以使用 stream 操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> intData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>2</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>3</span><span style=color:#ff79c6>};</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>List intList <span style=color:#ff79c6>=</span> Arrays<span style=color:#ff79c6>.</span><span style=color:#50fa7b>stream</span><span style=color:#ff79c6>(</span>intData<span style=color:#ff79c6>).</span><span style=color:#50fa7b>boxed</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>collect</span><span style=color:#ff79c6>(</span>Collectors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>toList</span><span style=color:#ff79c6>());</span>
</span></span></code></pre></div><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/27fg/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>有趣的算法 - 布隆过滤器</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/6tf9/>从阿里规约谈起 - HashMap 初始化和扩容相关<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#坑一>坑一</a></li><li><a href=#坑二>坑二</a></li><li><a href=#坑三>坑三</a></li><li><a href=#解决方案>解决方案</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>