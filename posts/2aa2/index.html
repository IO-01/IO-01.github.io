<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>ğŸ§‘â€ğŸ’»</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>éµå¾ª Google åº”ç”¨æŒ‡å—çš„ Retrofit + Coroutine å°è£…</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>å½’æ¡£</a></li><li><a href=https://blog.io01.xyz/about>å…³äº</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>éµå¾ª Google åº”ç”¨æŒ‡å—çš„ Retrofit + Coroutine å°è£…</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2021-06-18</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/kotlin/ class="text-gray-500 mr-1">Kotlin</a>
<a href=https://blog.io01.xyz/tags/android/ class="text-gray-500 mr-1">Android</a></div></div></div></header><h2 id=å‰è¨€>å‰è¨€</h2><p>Retrofit ä» 2.6.0 ä»¥åå¯¹ Kotlin åç¨‹æä¾›äº†åŸç”Ÿæ”¯æŒï¼Œä½¿å¾—å¼‚æ­¥è¯·æ±‚ä»å†™æ³•ä¸Šæ›´åƒåŒæ­¥è°ƒç”¨ï¼Œé…åˆ Google å‡ºçš„ Jetpack å…¨å®¶æ¡¶å¯ä»¥ä½¿å¾—ç½‘ç»œè¯·æ±‚æ›´åŠ ä¼˜é›…ç®€å•ï¼Œè€Œä¸”å¯ä»¥å®Œå…¨éµå¾ª Google ç»™å‡ºçš„åº”ç”¨æ¶æ„æŒ‡å—ã€‚</p><p>å¦å¤–æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´åŠ å¤šæ ·çš„éœ€æ±‚ï¼šæˆ‘ä»¬çš„åº”ç”¨ä½¿ç”¨äº†å¤šå¥—æœåŠ¡æ¥å£ï¼Œæ¯å¥—æ¥å£è¿”å›çš„å‚æ•°æ¨¡æ¿ä¸åŒï¼ŒbaseUrl åˆ™æ›´å¤šæ ·åŒ–ï¼Œå› æ­¤å¸¦æ¥äº†æ›´å¤æ‚çš„å°è£…é€»è¾‘ã€‚</p><h2 id=åº”ç”¨æ¶æ„æŒ‡å—>åº”ç”¨æ¶æ„æŒ‡å—</h2><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ Google ç»™å‡ºçš„åº”ç”¨æ¶æ„æŒ‡å—ï¼š</p><p><img alt=åº”ç”¨æ¶æ„ title src=https://static.fori.fun/blog/posts/static/application_architecture.svg></p><p>æ¯ä¸ªç»„ä»¶ä»…ä¾èµ–äºå…¶ä¸‹ä¸€çº§çš„ç»„ä»¶ï¼Œå¯ä»¥é¿å… Activity ä¸­å†—ä½™äº†å¤§é‡é€»è¾‘ï¼ŒçœŸæ­£è®© View å±‚åªè¿›è¡Œè§†å›¾ç›¸å…³å¤„ç†ï¼Œå¯ä»¥éå¸¸çµæ´»å˜æ›´ä¸Šå±‚ UIï¼Œæ•°æ®å¤„ç†åˆ™èƒ½å¤Ÿå¤šå¤„å¤ç”¨ã€‚</p><p>ä¸ºè¾¾æˆè¿™ä¸ªæ¶æ„ï¼Œå°±éœ€è¦å°†æ•°æ®è¯·æ±‚å’Œåˆæ­¥å¤„ç†å·¥ä½œå°è£…åœ¨ Repository ä¸­ï¼ŒViewModel ä¸­åšè¯·æ±‚çš„å‘èµ·å’Œå°†ç½‘ç»œè¯·æ±‚ååºåˆ—åŒ–åçš„ç»“æœä½¿ç”¨ LiveData äº¤ç»™ View å±‚è¿›è¡Œæ˜¾ç¤ºã€‚</p><h2 id=äº†è§£åç¨‹>äº†è§£åç¨‹</h2><p>æœ¬æ–‡åŸºäºåç¨‹å¯¹ Retrofit è¿›è¡Œå°è£…ï¼Œæ‰€ä»¥éœ€è¦å¯¹åç¨‹æœ‰åˆæ­¥äº†è§£ã€‚</p><h3 id=åç¨‹çš„æ„æˆå’ŒåŸºæœ¬ä½¿ç”¨>åç¨‹çš„æ„æˆå’ŒåŸºæœ¬ä½¿ç”¨</h3><p>é¦–å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„åç¨‹ä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#50fa7b>GlobalScope</span>.launch(<span style=color:#50fa7b>Dispatchers</span>.Main) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>val</span> result = requestNetWork()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    updateUI(result)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>requestNetWork</span>() = withContext(<span style=color:#50fa7b>Dispatchers</span>.IO) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    delay(<span style=color:#bd93f9>1000</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#50fa7b>System</span>.currentTimeMillis().toString()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>updateUI</span>(nowTime: String) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    textView.text = nowTime
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>è¿™ä¸ªä¾‹å­ä½¿ç”¨ä¸€ä¸ª GlobalScope å¯åŠ¨äº†ä¸€ä¸ªä½äºä¸»çº¿ç¨‹çš„åç¨‹ï¼Œåˆ‡æ¢åˆ° IO çº¿ç¨‹å»¶æ—¶äº† 1 ç§’æ¥æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚ï¼Œç„¶åè¿”å›å½“å‰æ—¶é—´åè‡ªåŠ¨åˆ‡å›äº†ä¸»çº¿ç¨‹ï¼Œæœ€åä¸»çº¿ç¨‹è¿›è¡Œ UI æ›´æ–°æ“ä½œã€‚</p><p>ç”±æ­¤å¯è§åç¨‹ç”±å¦‚ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>CoroutineScopeï¼ˆåç¨‹ä½œç”¨åŸŸï¼‰ï¼šç”¨äºç®¡ç†åç¨‹çš„å¯åŠ¨å–æ¶ˆæ‰§è¡ŒèŒƒå›´ç­‰ã€‚<code>GlobalScope</code> æ˜¯ CoroutineScope çš„ä¸€ä¸ªå•ä¾‹å®ç°ç±»ï¼Œä¸ä¸ç”Ÿå‘½å‘¨æœŸç»„ä»¶ç›¸å…³è”ã€‚</li><li>CoroutineContextï¼ˆåç¨‹ä¸Šä¸‹æ–‡ï¼‰ï¼šåç¨‹çš„é…ç½®å‚æ•°ï¼Œä¾‹å¦‚åç¨‹åç§°ã€å·¥ä½œçº¿ç¨‹ç­‰ï¼Œä½¿ç”¨ <code>plus</code> è¿ç®—ç¬¦ç›¸è¿æ¥ã€‚<code>Dispatchers.Main</code> å³ä¸ºå…¶å®ç°ï¼Œç”¨äºæŒ‡å®šä¸»çº¿ç¨‹è¿è¡Œåç¨‹ã€‚</li><li>CoroutineBuilderï¼ˆåç¨‹æ„å»ºå™¨ï¼‰ï¼šåˆ›å»ºå’Œå¯åŠ¨åç¨‹ã€‚<code>launch</code>ã€<code>async</code>ã€<code>runBlocking</code> éƒ½æ˜¯åç¨‹æ„å»ºå™¨ã€‚</li><li>suspend functionï¼ˆæŒ‚èµ·å‡½æ•°ï¼‰ï¼šä½¿ç”¨ <code>suspend</code> å…³é”®å­—æ ‡è¯†çš„å‡½æ•°ã€‚å¯¹è°ƒç”¨è€…å£°æ˜å¯èƒ½å­˜åœ¨è€—æ—¶æ“ä½œï¼ŒæŒ‚èµ·å‡½æ•°åªèƒ½åœ¨å…¶ä»–æŒ‚èµ·å‡½æ•°å†…æˆ–é€šè¿‡åç¨‹æ„å»ºå™¨è°ƒç”¨ã€‚</li></ul><h3 id=åç¨‹çš„åŸç†å’Œä½œç”¨>åç¨‹çš„åŸç†å’Œä½œç”¨</h3><p>Kotlin åç¨‹ä»åŸç†ä¸Šè®²ï¼Œç¼–è¯‘å™¨é€šè¿‡ <code>suspend</code> å…³é”®å­—å¯¹å‡½æ•°è¿›è¡Œäº† CPSï¼ˆContinuation Passing Styleï¼‰å˜æ¢ï¼Œä»è€Œé¿å…äº†æˆ‘ä»¬æ‰‹å†™ CallBack çš„ç¹çã€‚æ¯ä¸ª suspend å‡½æ•°è°ƒç”¨å¤„ Kotlin ç§°ä¹‹ä¸ºâ€œæŒ‚èµ·ç‚¹â€ï¼Œæ ¹æ®â€œæŒ‚èµ·ç‚¹â€å°†ä»£ç åˆ†å‰²æˆä¸åŒçš„ä»£ç å—ï¼Œä½¿ç”¨çŠ¶æ€æœºå¯¹çŠ¶æ€çš„æµè½¬è€Œæ‰§è¡Œä¸åŒçš„ä»£ç å—æ¥å®ç°â€œæŒ‚èµ·â€å’Œâ€œæ¢å¤â€ï¼Œè§„é¿äº† CPS å˜æ¢ååˆ›å»ºå¤§é‡ CallBack å¯¹è±¡ã€‚</p><p>è™½ç„¶åœ¨æŸç§ç¨‹åº¦ä¸Šå¯ä»¥ç®€å•è®¤ä¸ºåç¨‹æ˜¯ä¼˜åŒ–ç‰ˆ CallBack çš„è¯­æ³•ç³–ï¼Œå¹¶é€šè¿‡ä¸€äº›åº“å‡½æ•°å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿çš„åˆ‡æ¢çº¿ç¨‹ã€‚ä½†æ˜¯å®ƒæ”¹å˜äº†æˆ‘ä»¬è¿›è¡Œå¼‚æ­¥å¤„ç†çš„ç¼–ç¨‹æ–¹å¼ï¼Œä»¥ä¸€ç§åŒæ­¥çš„æ–¹å¼è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p><h2 id=ä½¿ç”¨-retrofit>ä½¿ç”¨ Retrofit</h2><h3 id=æ„å»º-okhttp>æ„å»º OkHttp</h3><p>Retrofit æ˜¯åŸºäº OkHttp çš„å°è£…ï¼Œæ‰€ä»¥é¦–å…ˆæ„å»º OkHttpClientã€‚æ­¤å¤„è¿˜å¯ä»¥æ·»åŠ  cookieã€user-agentï¼Œé…ç½®å„ç§æ‹¦æˆªå™¨ç­‰å¸¸è§„æ“ä½œï¼Œå¦‚ä¸‹ä»…æ„å»ºä¸€ä¸ªç®€å•çš„ OkHttpClient ä½œä¸ºç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>HttpClient</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> okHttpClient: OkHttpClient <span style=color:#ff79c6>by</span> lazy {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#50fa7b>OkHttpClient</span>.Builder()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>            .addInterceptor(HttpLoggingInterceptor().apply {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>                level = <span style=color:#ff79c6>if</span> (<span style=color:#50fa7b>BuildConfig</span>.DEBUG) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                    <span style=color:#50fa7b>HttpLoggingInterceptor</span>.<span style=color:#50fa7b>Level</span>.BODY
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                    <span style=color:#50fa7b>HttpLoggingInterceptor</span>.<span style=color:#50fa7b>Level</span>.BASIC
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            .build()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>é€šè¿‡å•ä¾‹å’Œ <code>lazy</code> å§”æ‰˜ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ª OkHttpClient è¢«æ„å»ºã€‚</p><h3 id=æ„å»º-retrofit>æ„å»º Retrofit</h3><p>é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ„å»º Retrofit æ—¶ baseUrl æœ‰å¤šä¸ªï¼Œè§£å†³æ–¹æ¡ˆå¤šç§å¤šæ ·ï¼Œæ¯”å¦‚é€šè¿‡æ‹¦æˆªå™¨è§£å†³ã€é€šè¿‡ <code>@Url</code> æ³¨è§£ä¼ å®Œæ•´ url ç­‰ï¼Œæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯æœ€å¸¸è§çš„â€”â€”ä¸ºæ¯ä¸ª baseUrl æ„å»ºä¸€ä¸ª Retrofit å®ä¾‹ï¼Œå› ä¸ºè™½ç„¶æœ‰å¤šä¸ª Retrofit å¯¹è±¡ï¼Œä½†æ˜¯å¦‚ä¸Šä»£ç æœ€åå‘èµ·è¯·æ±‚çš„ OkHttpClient å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¹¶ä¸ä¼šé€ æˆå†…å­˜æ–¹é¢çš„æ‹…å¿§ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>HttpClient</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> retrofits = HashMap&lt;String, Retrofit&gt;(<span style=color:#bd93f9>8</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>S</span>&gt; <span style=color:#50fa7b>getService</span>(service: Class&lt;S&gt;, baseUrl: String): S {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>return</span> retrofits.getOrPut(baseUrl) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#50fa7b>Retrofit</span>.Builder()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                .client(okHttpClient)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                .baseUrl(baseUrl)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                .addConverterFactory(<span style=color:#50fa7b>GsonConverterFactory</span>.create())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                .build()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        }.create(service)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>inline</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#ff79c6>reified</span> <span style=color:#50fa7b>S</span>&gt; <span style=color:#50fa7b>getService</span>(baseUrl: String): S = getService(S<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java, baseUrl)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Gson ä½œä¸º json ååºåˆ—åŒ–åº“ï¼Œä½¿ç”¨ HashMap çš„æ‰©å±•æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°è·å–å’Œç¼“å­˜ Retrofit å¯¹è±¡ï¼Œç¬¬äºŒä¸ªé‡è½½æ–¹æ³•é€šè¿‡ <code>inline</code> å’Œ <code>reified</code> å…³é”®å­—ç®€åŒ–äº†è°ƒç”¨æ–¹å¼ï¼Œåé¢ä½¿ç”¨æ—¶ä¼šæœ‰æ‰€ä½“ç°ã€‚</p><h3 id=å£°æ˜-apiservice>å£°æ˜ ApiService</h3><p>å¦‚æœä¸å…³å¿ƒç½‘ç»œçŠ¶æ€å’ŒæœåŠ¡å™¨çŠ¶æ€ï¼Œå¯ä»¥éå¸¸ç®€å•ç²—æš´çš„åˆ›å»ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>interface</span> <span style=color:#50fa7b>ApiService</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    @GET(<span style=color:#f1fa8c>&#34;home/feed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>getHomeFeed</span>(@Query(<span style=color:#f1fa8c>&#34;cityId&#34;</span>) cityId: Int): HomeFeedDataAndResponse
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>åœ¨å‡½æ•°å‰é¢ä½¿ç”¨ <code>suspend</code> å…³é”®å­—è¡¨ç¤ºæŒ‚èµ·å‡½æ•°ï¼Œæ— éœ€ä½¿ç”¨ä»»ä½• CallAdapterï¼ŒRetrofit åœ¨ä½¿ç”¨åç¨‹æ—¶æ”¯æŒè¿”å›å€¼å°±æ˜¯ååºåˆ—åŒ–çš„å®ä½“å¯¹è±¡ã€‚</p><h2 id=å‘èµ·å’Œå¤„ç†è¯·æ±‚>å‘èµ·å’Œå¤„ç†è¯·æ±‚</h2><h3 id=å•ä¸€æ•°æ®æ¨¡æ¿>å•ä¸€æ•°æ®æ¨¡æ¿</h3><p>æ¯ä¸ªæ¥å£å°†æœåŠ¡å™¨è¿”å›çš„å›ºå®šå‚æ•°éƒ½è¦æ”¾åˆ° Bean ä¸­è§£æååˆ†éº»çƒ¦ï¼Œå› æ­¤å¯ä»¥å°†æœåŠ¡å™¨çš„å›ºå®šå‚æ•°åšæˆä¸€ä¸ªå›ºå®šæ¨¡æ¿ç±»ï¼Œå˜åŒ–å­—æ®µé€šè¿‡æ³›å‹æ¥è§£å†³ã€‚</p><p>å‡è®¾æœåŠ¡å™¨çš„å‚æ•°æ¨¡æ¿å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>&#34;code&#34;</span>: <span style=color:#bd93f9>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>&#34;msg&#34;</span>: <span style=color:#f1fa8c>&#34;æˆåŠŸ&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>&#34;data&#34;</span>: {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>å¯ä»¥å®šä¹‰ä¸€ä¸ª XXXResponse çš„æ¨¡æ¿ç±»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>XXXResponse</span>&lt;<span style=color:#ff79c6>out</span> T&gt;(<span style=color:#ff79c6>val</span> code: Int, <span style=color:#ff79c6>val</span> msg: String, <span style=color:#ff79c6>val</span> data: T) : Serializable {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>toString</span>(): String {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>return</span> JSONObject().apply {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            put(<span style=color:#f1fa8c>&#34;code&#34;</span>, code)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            put(<span style=color:#f1fa8c>&#34;msg&#34;</span>, msg)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            put(<span style=color:#f1fa8c>&#34;data&#34;</span>, <span style=color:#ff79c6>data</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>        }.toString()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>ApiService ä¸­çš„è¿”å›å€¼ä¹Ÿå°±ç›¸åº”å˜åŒ–ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>interface</span> <span style=color:#50fa7b>ApiService</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    @GET(<span style=color:#f1fa8c>&#34;home/feed&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>getHomeFeed</span>(@Query(<span style=color:#f1fa8c>&#34;cityId&#34;</span>) cityId: Int): XXXResponse&lt;HomeFeedData&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><h3 id=å®šä¹‰-httpresult>å®šä¹‰ HttpResult</h3><p>å®é™…å¼€å‘ä¸­ View å±‚é€šå¸¸éœ€è¦æ ¹æ®ç½‘ç»œå’ŒæœåŠ¡å™¨è¿”å›å€¼å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼Œä¸ºæ­¤æˆ‘ä»¬æ€»ç»“äº†ä¸‰ç§çŠ¶æ€ã€‚</p><ul><li>æˆåŠŸï¼šä¸€åˆ‡éƒ½å¦‚æˆ‘ä»¬æœŸå¾…çš„çŠ¶æ€</li><li>å¤±è´¥ï¼šç½‘ç»œè¯·æ±‚æˆåŠŸä½†æ˜¯å› ä¸ºä¸šåŠ¡é€»è¾‘é”™è¯¯ç”±åç«¯ä¸»åŠ¨æŠ¥å‡ºçš„å¼‚å¸¸çŠ¶æ€</li><li>é”™è¯¯ï¼šå› ä¸ºç½‘ç»œå’ŒæœåŠ¡å™¨åŸå› é€ æˆçš„ 404ã€502 æˆ–è€… DNS è¯·æ±‚å¤±è´¥ç­‰é”™è¯¯çŠ¶æ€</li></ul><p>ç”±æ­¤å°†æœ€ç»ˆçš„ç½‘ç»œè¯·æ±‚ç»“æœå°è£…ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>sealed</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>HttpResult</span>&lt;<span style=color:#ff79c6>out</span> T : Any&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>data</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Success</span>&lt;<span style=color:#ff79c6>out</span> T : Any&gt;(<span style=color:#ff79c6>val</span> data: T) : HttpResult&lt;T&gt;()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>data</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Failure</span>(<span style=color:#ff79c6>val</span> reason: String) : HttpResult&lt;Nothing&gt;()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>data</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Error</span>(<span style=color:#ff79c6>val</span> exception: Exception) : HttpResult&lt;Nothing&gt;()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>toString</span>(): String {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>when</span> (<span style=color:#ff79c6>this</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#ff79c6>is</span> Success&lt;*&gt; <span style=color:#ff79c6>-&gt;</span> <span style=color:#f1fa8c>&#34;Success[data=</span><span style=color:#f1fa8c>$data</span><span style=color:#f1fa8c>]&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>is</span> Failure <span style=color:#ff79c6>-&gt;</span> <span style=color:#f1fa8c>&#34;Failure[reason=</span><span style=color:#f1fa8c>$reason</span><span style=color:#f1fa8c>]&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>is</span> Error <span style=color:#ff79c6>-&gt;</span> <span style=color:#f1fa8c>&#34;Error[exception=</span><span style=color:#f1fa8c>$exception</span><span style=color:#f1fa8c>]&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>æœªä½¿ç”¨æšä¸¾è€Œé€‰æ‹©å¯†å°ç±»æ˜¯å› ä¸ºä¸åŒçŠ¶æ€ä¸‹æºå¸¦çš„æ•°æ®ç±»å‹ä¸åŒï¼Œæ‰€ä»¥é€šè¿‡å¯†å°ç±»æ¥å°è£…è¿™ä¸‰ç§çŠ¶æ€ã€‚</p><p>æ³¨ï¼šå…¶å®å½“åªæœ‰ä¸€ä¸ªæ•°æ®æ¨¡æ¿æ—¶ HttpResult çš„ <code>Failure</code> èƒ½åŒ…è£…æ›´ç»“æ„åŒ–çš„æ•°æ®ï¼Œæ­¤å¤„ <code>reason</code> ä¸ºå­—ç¬¦ä¸²æ˜¯ä¸ºäº†å¤šå¥—æ•°æ®æ¨¡æ¿æ—¶åŒ…è£… json ä¼ é€’æ›´åŠ é€šç”¨çš„ä¿¡æ¯ã€‚</p><h3 id=å‘èµ·è¯·æ±‚å¹¶å¤„ç†-response>å‘èµ·è¯·æ±‚å¹¶å¤„ç† Response</h3><p>å·²ç»æœ‰äº†åç«¯è¿”å›çš„æ¨¡æ¿ç±»å’Œæœ€ç»ˆæŠ›ç»™ View å±‚çš„ HttpResultï¼Œæ ¹æ®æœ€åˆçš„æ¶æ„åˆ†æï¼Œéœ€è¦åœ¨ Repository ä¸­è¿›è¡Œæ•°æ®è¯·æ±‚å’Œå¤„ç†å°†æ¨¡æ¿ç±»è½¬æ¢æˆ HttpResultã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>XXXRepository</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>executeResponse</span>(response: XXXResponse&lt;T&gt;): HttpResult&lt;T&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>if</span> (response.code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>200</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            <span style=color:#50fa7b>HttpResult</span>.Failure(response.toString())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            <span style=color:#50fa7b>HttpResult</span>.Success(response.<span style=color:#ff79c6>data</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>é€šè¿‡ baseUrl è·å–ç›¸åº”çš„ ApiServiceï¼Œç„¶åå‘èµ·ç½‘ç»œè¯·æ±‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>XXXRepository</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> service = <span style=color:#50fa7b>HttpClient</span>.getService&lt;ApiService&gt;(<span style=color:#f1fa8c>&#34;http://app.demo.com/&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>getHomeFeed</span>(cityId: Int): HttpResult&lt;HomeFeedData&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        <span style=color:#ff79c6>return</span> executeResponse(service.getHomeFeed(cityId))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>åé¢è¯·æ±‚ä¸€æ—¦æ–­ç½‘ä¼šå‘ç°åº”ç”¨å´©æºƒï¼Œå› ä¸ºå‡ºç°ç½‘ç»œé”™è¯¯æ—¶ Retrofit ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ try-catch æ¥æ•è·å¼‚å¸¸å¹¶äº¤ç»™ä¹‹å‰é¢„è®¾çš„ <code>HttpResult.Error</code>ã€‚ä½†æ˜¯æ¯ä¸ªæ¥å£éƒ½ try-catch ä¸ä½†éº»çƒ¦ï¼Œè€Œä¸”ä¸€æ—¦å¿˜è®°å°±å¯èƒ½é€ æˆåº”ç”¨å´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é«˜é˜¶å‡½æ•°æ¥å°è£…è°ƒç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>XXXRepository</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>val</span> service = <span style=color:#50fa7b>HttpClient</span>.getService&lt;ApiService&gt;(<span style=color:#f1fa8c>&#34;http://app.demo.com/&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>call</span>(request: <span style=color:#ff79c6>suspend</span> () <span style=color:#ff79c6>-&gt;</span> XXXResponse&lt;T&gt;): HttpResult&lt;T&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            executeResponse(request())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        } <span style=color:#ff79c6>catch</span> (e: Exception) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#50fa7b>HttpResult</span>.Error(e)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>executeResponse</span>(response: XXXResponse&lt;T&gt;): HttpResult&lt;T&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>if</span> (response.code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>200</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            <span style=color:#50fa7b>HttpResult</span>.Failure(response.toString())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            <span style=color:#50fa7b>HttpResult</span>.Success(response.<span style=color:#ff79c6>data</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>getHomeFeed</span>(cityId: Int): HttpResult&lt;HomeFeedData&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>return</span> call { service.getHomeFeed(cityId) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><h3 id=ä¸åŒæ•°æ®æ¨¡æ¿>ä¸åŒæ•°æ®æ¨¡æ¿</h3><p>å¦‚æœåªæœ‰å•ä¸€æ•°æ®æ¨¡æ¿ï¼Œä¸Šé¢çš„å°è£…éƒ¨åˆ†å°±å·²ç»å®Œæˆäº†ï¼Œä½†æ˜¯æˆ‘ä»¬é‡åˆ°äº†ç¬¬äºŒä¸ªé—®é¢˜ï¼šæ•°æ®æ¨¡æ¿ä¸åŒã€‚å‡è®¾æˆ‘ä»¬æœ‰ç¬¬äºŒå¥—ä¸åŒçš„å›ºå®šå‚æ•°æ¨¡æ¿å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#ff79c6>&#34;data&#34;</span>: {},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>&#34;error&#34;</span>: {}<span style=color:#6272a4>//å½“ä¸šåŠ¡å‡ºç°é”™è¯¯æ—¶ä¼šè¿”å›
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span>}
</span></span></code></pre></div><p>çœŸå®åœºæ™¯ä¸­æ— è®ºæ˜¯æ¨¡æ¿è¿˜æ˜¯è§„åˆ™éƒ½å¾ˆå¤æ‚ï¼Œéš¾ä»¥ç³…åˆæˆä¸€å¥—æ¨¡æ¿ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©æ¯å¥—æ¨¡æ¿å¯¹åº”ä¸€å¥—å¤„ç†é€»è¾‘ã€‚æ ¹æ®æ¯å¥—æ¨¡æ¿å®šä¹‰ XXXResponse å’Œ YYYResponse ï¼ŒåŒæ—¶å¯¹åº” XXXRepository å’Œ YYYRepository ï¼Œç›¸ä¼¼ä»£ç ä¸å†èµ˜è¿°ã€‚</p><p>ç„¶åæ˜¯æŠ½è±¡å‡ºå…¬å…±éƒ¨åˆ†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>abstract</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>BaseRepository</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>suspend</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>call</span>(request: <span style=color:#ff79c6>suspend</span> () <span style=color:#ff79c6>-&gt;</span> Any): HttpResult&lt;T&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            executeResponse(request())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        } <span style=color:#ff79c6>catch</span> (e: Exception) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#50fa7b>HttpResult</span>.Error(e)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>abstract</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>executeResponse</span>(response: Any): HttpResult&lt;T&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>å…¶ä¸­ <code>executeResponse</code> æ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œå¿…é¡»è¢«å­ç±»å®ç°ã€‚æœ€åæ˜¯å„è‡ªçš„å®ç°ç±»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>object</span> <span style=color:#50fa7b>XXXRepository</span> : BaseRepository() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    @Suppress(<span style=color:#f1fa8c>&#34;UNCHECKED_CAST&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> &lt;<span style=color:#50fa7b>T</span> : <span style=color:#50fa7b>Any</span>&gt; <span style=color:#50fa7b>executeResponse</span>(response: Any): HttpResult&lt;T&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>if</span> ((response <span style=color:#ff79c6>as</span> XXXResponse&lt;T&gt;).code <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>200</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#50fa7b>HttpResult</span>.Failure(response.toString())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#50fa7b>HttpResult</span>.Success(response.<span style=color:#ff79c6>data</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><h2 id=ä½¿ç”¨>ä½¿ç”¨</h2><p>è‡³æ­¤ï¼Œå¯¹äºç½‘ç»œè¯·æ±‚çš„å°è£…å°±ç»“æŸäº†ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ï¼š</p><p>åœ¨ ViewModel ä¸­è°ƒç”¨å¹¶ä½¿ç”¨ LiveData æ‰¿è½½è¿”å›ç»“æœï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// ViewModel
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>val</span> homeFeed = MutableLiveData&lt;HttpResult&lt;HomeFeedData&gt;&gt;()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>getHomeFeed</span>(cityId: Int) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>return</span> viewModelScope.launch {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        homeFeed.<span style=color:#ff79c6>value</span> = <span style=color:#50fa7b>XXXRepository</span>.getHomeFeed(cityId)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>åœ¨ View å±‚è°ƒç”¨å’Œè§‚å¯Ÿ LiveData å³å¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>viewModel.getHomeFeed(cityId)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>viewModel.homeFeed.observe(<span style=color:#ff79c6>this</span>) { result <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>when</span> (result) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>is</span> <span style=color:#50fa7b>HttpResult</span>.Success <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#50fa7b>Log</span>.d(TAG, <span style=color:#f1fa8c>&#34;homeFeed Success: </span><span style=color:#f1fa8c>${result.data}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>is</span> <span style=color:#50fa7b>HttpResult</span>.Failure <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#50fa7b>Log</span>.w(TAG, <span style=color:#f1fa8c>&#34;homeFeed Failure: </span><span style=color:#f1fa8c>${result.reason}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>is</span> <span style=color:#50fa7b>HttpResult</span>.Error <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#50fa7b>Log</span>.e(TAG, <span style=color:#f1fa8c>&#34;homeFeed Error: </span><span style=color:#f1fa8c>${result.exception}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><h3 id=tips>Tips</h3><p>åœ¨ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>viewModelScope</code> å¯åŠ¨çš„åç¨‹ï¼Œè€Œéæœ€åˆä½¿ç”¨çš„ <code>GlobalScope</code>ï¼Œå› ä¸º <code>viewModelScope</code> å¯ä»¥å’Œ ViewModel çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³è”ï¼Œå½“ ViewModel è°ƒç”¨ <code>clear()</code> æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨å–æ¶ˆåç¨‹ã€‚ä½¿ç”¨ <code>viewModelScope</code> æ˜¯ä¸ºäº†å‡å°‘æ ·æ¿ä»£ç ï¼Œå¦‚æœä½¿ç”¨è‡ªå·±æ„é€ çš„ CoroutineScopeï¼ŒåŒæ ·éœ€è¦åœ¨ ViewModel çš„ <code>onCleared()</code> ä¸­è‡ªè¡Œå–æ¶ˆåç¨‹ï¼Œå¦åˆ™å¯èƒ½é€ æˆå†…å­˜æ³„æ¼ã€‚</p><p>å¦å¤–å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæ ¹æ® <code>viewModelScope</code> çš„æºç ï¼Œåç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹å¯åŠ¨çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>val</span> ViewModel.viewModelScope: CoroutineScope
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>        <span style=color:#ff79c6>get</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>            <span style=color:#ff79c6>val</span> scope: CoroutineScope? = <span style=color:#ff79c6>this</span>.getTag(JOB_KEY)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            <span style=color:#ff79c6>if</span> (scope <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>                <span style=color:#ff79c6>return</span> scope
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>            <span style=color:#ff79c6>return</span> setTagIfAbsent(JOB_KEY,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>                CloseableCoroutineScope(SupervisorJob() + <span style=color:#50fa7b>Dispatchers</span>.<span style=color:#50fa7b>Main</span>.immediate))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>        }
</span></span></code></pre></div><p>ä½†æ˜¯è°ƒç”¨æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ <code>withContext(Dispatchers.IO)</code> åˆ‡æ¢åˆ° IO çº¿ç¨‹ï¼ŒåŸå› å…¶å®æ¥è‡ªäº Retrofit çš„åç¨‹é€‚é…å®ç°ï¼Œè™½ç„¶çœ‹ä¼¼æ˜¯åŒæ­¥å†™æ³•ï¼Œä½†æ˜¯æœ€ç»ˆå®ç°æ˜¯è°ƒç”¨ <code>enqueue()</code> è¿›è¡Œå¼‚æ­¥è¯·æ±‚ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ <code>enqueue()</code> æ˜¯åœ¨çº¿ç¨‹æ± ä¸­å®Œæˆè¯·æ±‚å¹¶å›è°ƒå›ä¸»çº¿ç¨‹ï¼Œå¯ä»¥åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æœ€åæ€»ç»“ä¸€ä¸‹æ ¹æ®åº”ç”¨æ¶æ„æŒ‡å—å°è£…ä¹‹åçš„è°ƒç”¨å›¾ï¼š</p><p><img alt=æ¶æ„è°ƒç”¨å¯¹ç…§å›¾ title src=https://static.fori.fun/blog/posts/static/architecture_request_contrast.svg></p><p>æ ¹æ® Google çš„åº”ç”¨æ¶æ„æŒ‡å—å¯ä»¥åšåˆ°å±‚æ¬¡æ¸…æ™°ï¼Œç‰¹åˆ«æ˜¯å¾—ç›Šäº ViewModel å’Œ LiveData å¯¹äºç”Ÿå‘½å‘¨æœŸçš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œæ— éœ€ä¸»åŠ¨å–æ¶ˆç½‘ç»œè¯·æ±‚æˆ–è€…å…¶ä»–æ–¹æ¡ˆçš„è§£æ³¨å†Œå´ä¸ç”¨æ‹…å¿ƒé€ æˆ View å±‚çš„å†…å­˜æ³„éœ²ã€‚åç¨‹ä½¿å¾—å¼‚æ­¥è¯·æ±‚å¦‚åŒæ­¥èˆ¬ä½¿ç”¨ï¼Œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œè¯·æ±‚å¹¶åœ¨ä¸»çº¿ç¨‹è¿”å›ç½‘ç»œè¯·æ±‚çš„ç»“æœï¼Œæ‰€ä»¥æœ€å View å±‚æ˜¯åœ¨ä¸»çº¿ç¨‹è§‚å¯Ÿçš„ LiveDataï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒç½‘ç»œè¯·æ±‚ä¼šé˜»å¡ UI çº¿ç¨‹ã€‚</p><p>é™¤åç¨‹ä¹‹å¤–æœ¬æ–‡å°è£…ä¹Ÿç”¨åˆ°äº†å¾ˆå¤š Kotlin çš„é«˜çº§è¯­æ³•ï¼Œæ¯”å¦‚ï¼šé«˜é˜¶å‡½æ•°ã€HashMap çš„æ‰©å±•æ–¹æ³•ã€<code>reified</code> æ³›å‹å®åŒ–ã€å¯†å°ç±»ç­‰ï¼Œè¿™äº›é«˜çº§è¯­æ³•è®©æˆ‘ä»¬çš„å°è£…å’Œè°ƒç”¨éƒ½ç®€æ´æ˜äº†äº†å¾ˆå¤šã€‚</p><p>å¦å¤–æœ¬æ–‡ä¸»è¦é’ˆå¯¹ä½¿ç”¨ Retrofit ç½‘ç»œè¯·æ±‚éƒ¨åˆ†è¿›è¡Œå°è£…ï¼Œæ ¹æ® Google çš„åº”ç”¨æ¶æ„æŒ‡å— Repository ä¸­è¿˜ä¼šä½¿ç”¨ Room è¿›è¡Œæœ¬åœ°ç¼“å­˜ï¼Œè™½ä¸æœ¬æ–‡æ— å…³è€ŒæœªåŠ å…¥ï¼Œä½†æ˜¯å› ä¸ºåˆ†å±‚æ¶æ„çš„æ¸…æ™°ï¼Œå¾ˆå®¹æ˜“åŠ å…¥ç›¸å…³åŠŸèƒ½ã€‚</p><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/6fn7/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>æ·±å…¥æºç æ’æŸ¥ FLAG_ACTIVITY_NEW_TASK å¯¼è‡´çš„ Activity æ— æ³•æ­£å¸¸å¯åŠ¨</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/53aj/>æ—¶é—´æ ¼å¼åŒ–çš„è¶£äº‹ï¼šYYYY ç¤ºå¹´<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#å‰è¨€>å‰è¨€</a></li><li><a href=#åº”ç”¨æ¶æ„æŒ‡å—>åº”ç”¨æ¶æ„æŒ‡å—</a></li><li><a href=#äº†è§£åç¨‹>äº†è§£åç¨‹</a><ul><li><a href=#åç¨‹çš„æ„æˆå’ŒåŸºæœ¬ä½¿ç”¨>åç¨‹çš„æ„æˆå’ŒåŸºæœ¬ä½¿ç”¨</a></li><li><a href=#åç¨‹çš„åŸç†å’Œä½œç”¨>åç¨‹çš„åŸç†å’Œä½œç”¨</a></li></ul></li><li><a href=#ä½¿ç”¨-retrofit>ä½¿ç”¨ Retrofit</a><ul><li><a href=#æ„å»º-okhttp>æ„å»º OkHttp</a></li><li><a href=#æ„å»º-retrofit>æ„å»º Retrofit</a></li><li><a href=#å£°æ˜-apiservice>å£°æ˜ ApiService</a></li></ul></li><li><a href=#å‘èµ·å’Œå¤„ç†è¯·æ±‚>å‘èµ·å’Œå¤„ç†è¯·æ±‚</a><ul><li><a href=#å•ä¸€æ•°æ®æ¨¡æ¿>å•ä¸€æ•°æ®æ¨¡æ¿</a></li><li><a href=#å®šä¹‰-httpresult>å®šä¹‰ HttpResult</a></li><li><a href=#å‘èµ·è¯·æ±‚å¹¶å¤„ç†-response>å‘èµ·è¯·æ±‚å¹¶å¤„ç† Response</a></li><li><a href=#ä¸åŒæ•°æ®æ¨¡æ¿>ä¸åŒæ•°æ®æ¨¡æ¿</a></li></ul></li><li><a href=#ä½¿ç”¨>ä½¿ç”¨</a><ul><li><a href=#tips>Tips</a></li></ul></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>