<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=stylesheet href=/css/style.css><script type=text/javascript src=/js/main.js></script><title>从阿里规约谈起 - HashMap 初始化和扩容相关</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=/posts>归档</a></li><li><a href=/about>关于</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>从阿里规约谈起 - HashMap 初始化和扩容相关</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2019-08-30</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#series"/></svg><a href=/series/%E9%98%BF%E9%87%8C%E8%A7%84%E7%BA%A6/ class=text-gray-500>阿里规约</a></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=/tags/java/ class="text-gray-500 mr-1">Java</a></div></div></div></header><h2 id=引言>引言</h2><p>日常开发中使用 HashMap 方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span> Object<span style=color:#ff79c6>&gt;</span> HashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span></code></pre></div><p>但是阿里规约会提示有问题：</p><p><img alt=未指定初始化容量 title src=https://static.fori.fun/blog/posts/static/p3c_hashmap_error.png></p><p>由此我们可以看一下 HashMap 初始化和扩容相关。</p><p>注：本文涉及了少许 HashMap 基础，由于与主线无关，不详讲。源码均加了些注释，注释无法解释清楚的地方放在源码之后论述。</p><h2 id=new>new</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>HashMap</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadFactor</span> <span style=color:#ff79c6>=</span> DEFAULT_LOAD_FACTOR<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>HashMap</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> initialCapacity<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>float</span> loadFactor<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#6272a4>//判断异常
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>//初始化负载因子
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>loadFactor</span> <span style=color:#ff79c6>=</span> loadFactor<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//初始化阈值
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>threshold</span> <span style=color:#ff79c6>=</span> tableSizeFor<span style=color:#ff79c6>(</span>initialCapacity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>//十分精巧地实现了求一个数的最近的 2 的幂
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>tableSizeFor</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> cap<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#8be9fd>int</span> n <span style=color:#ff79c6>=</span> cap <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>2</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>4</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>8</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>16</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>&gt;=</span> MAXIMUM_CAPACITY<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> MAXIMUM_CAPACITY <span style=color:#ff79c6>:</span> n <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>出人（我自己）意料的是默认构造函数初始化极其简单，只给负载因子赋值，除了直接传入 map 的构造函数外，最复杂的两个参数的构造函数也只是给负载因子和阈值赋值。并未初始化 bucket 数组。</p><p>那么什么时候初始化 bucket 数组的呢？</p><p>很容易想到初始化完 HashMap 我们直接使用 <code>put()</code> 操作。</p><h2 id=put>put</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> V <span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>K key<span style=color:#ff79c6>,</span> V value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>return</span> putVal<span style=color:#ff79c6>(</span>hash<span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>),</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>final</span> V <span style=color:#50fa7b>putVal</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> hash<span style=color:#ff79c6>,</span> K key<span style=color:#ff79c6>,</span> V value<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> onlyIfAbsent<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> evict<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[]</span> tab<span style=color:#ff79c6>;</span> Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> p<span style=color:#ff79c6>;</span> <span style=color:#8be9fd>int</span> n<span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>//当第一次 put 时，table 尚未初始化，所以 tab 为 null，进行一次 resize() 操作
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//后续 put 一般不再走该分支
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>tab <span style=color:#ff79c6>=</span> table<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>=</span> tab<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        n <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>tab <span style=color:#ff79c6>=</span> resize<span style=color:#ff79c6>()).</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#6272a4>//确定当前 key 在数组中的下标
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//此处就是经典的当 n 为 2 的幂时，(n - 1) &amp; hash == hash % n 的技巧
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//如下部分为碰撞和非碰撞时的储存过程，与本文主题不相关，不再详细论述
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>p <span style=color:#ff79c6>=</span> tab<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>n <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;</span> hash<span style=color:#ff79c6>])</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        tab<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> newNode<span style=color:#ff79c6>(</span>hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> e<span style=color:#ff79c6>;</span> K k<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>((</span>k <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>k<span style=color:#ff79c6>))))</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            e <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p <span style=color:#ff79c6>instanceof</span> TreeNode<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            e <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>TreeNode<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;)</span>p<span style=color:#ff79c6>).</span><span style=color:#50fa7b>putTreeVal</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> tab<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> binCount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span> <span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>binCount<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>e <span style=color:#ff79c6>=</span> p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                    p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> newNode<span style=color:#ff79c6>(</span>hash<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>binCount <span style=color:#ff79c6>&gt;=</span> TREEIFY_THRESHOLD <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#6272a4>// -1 for 1st
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span>                        treeifyBin<span style=color:#ff79c6>(</span>tab<span style=color:#ff79c6>,</span> hash<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                    <span style=color:#ff79c6>break</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                    <span style=color:#ff79c6>((</span>k <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>key</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>k<span style=color:#ff79c6>))))</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                    <span style=color:#ff79c6>break</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                p <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// existing mapping for key
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#6272a4></span>            V oldValue <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>value</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>onlyIfAbsent <span style=color:#ff79c6>||</span> oldValue <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>value</span> <span style=color:#ff79c6>=</span> value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            afterNodeAccess<span style=color:#ff79c6>(</span>e<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#ff79c6>return</span> oldValue<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#ff79c6>++</span>modCount<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    <span style=color:#6272a4>//size 为所有键值对的数量，threshold = capacity * loadFactor
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//也就是当键值对数量超过了 capacity 的 0.75 倍时，调用 resize() 扩容
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(++</span>size <span style=color:#ff79c6>&gt;</span> threshold<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        resize<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    afterNodeInsertion<span style=color:#ff79c6>(</span>evict<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#6272a4>//hash 值并非 key 的 hashCode，而是 hashCode 高低 16 位的异或
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4>//这样做是为了高低位进行扰动，使得这个 hashCode 能够全部参与对数组索引的计算
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#6272a4>//进一步降低碰撞的概率
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4>//本文后续提及的 hash 均指 hash(Object key) 之后的值
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>hash</span><span style=color:#ff79c6>(</span>Object key<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#8be9fd>int</span> h<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>key <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>(</span>h <span style=color:#ff79c6>=</span> key<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hashCode</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>^</span> <span style=color:#ff79c6>(</span>h <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>16</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>通过 <code>putVal()</code> 我们可知，当第一次执行 put 操作时才会调用 <code>resize()</code> 真正初始化 bucket 数组，当键值对超过了 <code>capacity</code> 的 0.75 倍时，调用 <code>resize()</code> 扩容。</p><h2 id=resize>resize</h2><p>那我们就来看看 <code>resize()</code> 是如何扩容的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>final</span> Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[]</span> <span style=color:#50fa7b>resize</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[]</span> oldTab <span style=color:#ff79c6>=</span> table<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> oldCap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>oldTab <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>:</span> oldTab<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>int</span> oldThr <span style=color:#ff79c6>=</span> threshold<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd>int</span> newCap<span style=color:#ff79c6>,</span> newThr <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#6272a4>//当 table 不为 null 时 oldCap 大于 0，也就是非初始化，单纯扩容
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldCap <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#6272a4>//超过最大值时直接把阈值设成 Integer.MAX_VALUE，不再扩容
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>//此时可以继续 put 进键值对，因为键相同 hash 值的不同键值对可以继续以链表形式加入存储
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldCap <span style=color:#ff79c6>&gt;=</span> MAXIMUM_CAPACITY<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            threshold <span style=color:#ff79c6>=</span> Integer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MAX_VALUE</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>return</span> oldTab<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#6272a4>//否则就扩容 2 倍
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>newCap <span style=color:#ff79c6>=</span> oldCap <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&lt;</span> MAXIMUM_CAPACITY <span style=color:#ff79c6>&amp;&amp;</span> oldCap <span style=color:#ff79c6>&gt;=</span> DEFAULT_INITIAL_CAPACITY<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            newThr <span style=color:#ff79c6>=</span> oldThr <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span> <span style=color:#6272a4>// double threshold
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#6272a4>//oldCap == 0，但是 oldThr &gt; 0，一般情况下表示带参构造函数初始化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldThr <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#6272a4>// initial capacity was placed in threshold
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span>        newCap <span style=color:#ff79c6>=</span> oldThr<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#6272a4>//oldCap == 0，oldThr == 0，表示无参构造函数初始化
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// zero initial threshold signifies using defaults
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>        newCap <span style=color:#ff79c6>=</span> DEFAULT_INITIAL_CAPACITY<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        newThr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>)(</span>DEFAULT_LOAD_FACTOR <span style=color:#ff79c6>*</span> DEFAULT_INITIAL_CAPACITY<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#6272a4>//初始化新阈值
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>newThr <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#8be9fd>float</span> ft <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>)</span>newCap <span style=color:#ff79c6>*</span> loadFactor<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        newThr <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>newCap <span style=color:#ff79c6>&lt;</span> MAXIMUM_CAPACITY <span style=color:#ff79c6>&amp;&amp;</span> ft <span style=color:#ff79c6>&lt;</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>)</span>MAXIMUM_CAPACITY <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>)</span>ft <span style=color:#ff79c6>:</span> Integer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MAX_VALUE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    threshold <span style=color:#ff79c6>=</span> newThr<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    @SuppressWarnings<span style=color:#ff79c6>({</span><span style=color:#f1fa8c>&#34;rawtypes&#34;</span><span style=color:#ff79c6>,</span><span style=color:#f1fa8c>&#34;unchecked&#34;</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[]</span> newTab <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;[])</span><span style=color:#ff79c6>new</span> Node<span style=color:#ff79c6>[</span>newCap<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    table <span style=color:#ff79c6>=</span> newTab<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldTab <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#6272a4>//将原来的 bucket 数组元素转移至新 bucket 数组中
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span> j <span style=color:#ff79c6>&lt;</span> oldCap<span style=color:#ff79c6>;</span> <span style=color:#ff79c6>++</span>j<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>e <span style=color:#ff79c6>=</span> oldTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>])</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                oldTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                <span style=color:#6272a4>//当 bucket 只存在一个键值对时，直接计算下标索引到新的数组中
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>                    newTab<span style=color:#ff79c6>[</span>e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>(</span>newCap <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>)]</span> <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>                <span style=color:#6272a4>//当 bucket 存在红黑树时，拆分然后映射（涉及红黑树，不做详解）
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>e <span style=color:#ff79c6>instanceof</span> TreeNode<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>                    <span style=color:#ff79c6>((</span>TreeNode<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;)</span>e<span style=color:#ff79c6>).</span><span style=color:#50fa7b>split</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> newTab<span style=color:#ff79c6>,</span> j<span style=color:#ff79c6>,</span> oldCap<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>                <span style=color:#6272a4>//当 bucket 存在一条链表时，切分成两条链，需要进一步分析
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span> <span style=color:#6272a4>// preserve order
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#6272a4></span>                    Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> loHead <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> loTail <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                    Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> hiHead <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> hiTail <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                    Node<span style=color:#ff79c6>&lt;</span>K<span style=color:#ff79c6>,</span>V<span style=color:#ff79c6>&gt;</span> next<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>                    <span style=color:#ff79c6>do</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>                        next <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>                        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>e<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>&amp;</span> oldCap<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>                            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>loTail <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                                loHead <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                            <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                                loTail<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                            loTail <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>                        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>                            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>hiTail <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>                                hiHead <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>                            <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                                hiTail<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                            hiTail <span style=color:#ff79c6>=</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>                    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>((</span>e <span style=color:#ff79c6>=</span> next<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                    <span style=color:#6272a4>//低链下标不变
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span><span style=color:#6272a4></span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>loTail <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                        loTail<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>                        newTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> loHead<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>                    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>                    <span style=color:#6272a4>//高链下标为原下标+原 bucket 数组长度
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span><span style=color:#6272a4></span>                    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>hiTail <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>                        hiTail<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>                        newTab<span style=color:#ff79c6>[</span>j <span style=color:#ff79c6>+</span> oldCap<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> hiHead<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>                    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#ff79c6>return</span> newTab<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>reszie()</code> 操作对于扩容分为了三种情况</p><ol><li>bucket 只有一个键值对时，直接计算新的索引位置并插入键值对</li><li>bucket 是红黑树时，调用 <code>split</code> 方法处理。</li><li>bucket 是链表时，分成了两条链表，低位链表插入原位置，高位链表插入原索引+原 bucket 数组长度处</li></ol><p>详讲第三种：</p><p>首先要认知一件事：<strong>当 bucket 成链表时，链表每个节点的 hash 值不一定相同</strong>，它们成为一条链表只因为该 key 的 hash 值取模后得到的值相同。</p><p>第三种情况发生后，有一个特别的优化：<code>(e.hash & oldCap) == 0</code></p><p>当 <code>(e.hash & oldCap) == 0</code> 时插入到原下标位置，否则插入原下标+原 bucket 数组长度处，为何如此插入？如下例子希望可以理解：</p><p>扩容前数组长度 n=16，扩容后 n=32。</p><p>现在有两个 hash：</p><ul><li>hash1=1111 1111 1111 1111 1111 0000 0101</li><li>hash2=1111 1111 1111 1111 1111 0001 0101</li></ul><table><thead><tr><th></th><th style=text-align:right>扩容前</th><th style=text-align:right>扩容后</th></tr></thead><tbody><tr><td>n</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0001 0000</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0010 0000</td></tr><tr><td>n-1</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0000 <font color=green>1111</font></td><td style=text-align:right>0000 0000 0000 0000 0000 0000 000<font color=red>1</font> <font color=green>1111</font></td></tr><tr><td>hash1</td><td style=text-align:right>1111 1111 1111 1111 1111 1111 0000 <font color=green>0101</font></td><td style=text-align:right>1111 1111 1111 1111 1111 1111 000<font color=red>0</font> <font color=green>0101</font></td></tr><tr><td>数组下标<br>hash1&(n-1)</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0000 <font color=green>0101</font><br>=5</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 000<font color=red>0</font> <font color=green>0101</font><br>=5</td></tr></tbody></table><table><thead><tr><th></th><th style=text-align:right>扩容前</th><th style=text-align:right>扩容后</th></tr></thead><tbody><tr><td>n</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0001 0000</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0010 0000</td></tr><tr><td>n-1</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0000 <font color=green>1111</font></td><td style=text-align:right>0000 0000 0000 0000 0000 0000 000<font color=red>1</font> <font color=green>1111</font></td></tr><tr><td>hash2</td><td style=text-align:right>1111 1111 1111 1111 1111 1111 0001 <font color=green>0101</font></td><td style=text-align:right>1111 1111 1111 1111 1111 1111 000<font color=red>1</font> <font color=green>0101</font></td></tr><tr><td>数组下标<br>hash2&(n-1)</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 0000 <font color=green>0101</font><br>=5</td><td style=text-align:right>0000 0000 0000 0000 0000 0000 000<font color=red>1</font> <font color=green>0101</font><br>=5+16（原下标+原 bucket 数组长度）</td></tr></tbody></table><p>绿色为参与运算的位，红色为由于扩容而增加参与运算的位。</p><p>当扩容以后，数组的长度的高位多了一位 <code>1</code> 参与计算索引下标，所以只需要计算 <code>n&hash</code>，如果为 <code>0</code> 时，扩容导致的新增最高位不影响原下标计算结果，否则新下标为原下标+原 bucket 数组长度。使用该算法后不必每个节点都重新计算下标，大大提高了性能。</p><h2 id=总结>总结</h2><ul><li>HashMap 初始化时不会初始化 bucket 数组，当第一次 put 时才会初始化，而且会初始化为离传入值的最近的 2 的幂。</li><li>当数据量大于 bucket 数组的 75%时，扩容为原来的 2 倍。</li><li>扩容+数据移动是耗费资源的操作，所以我们一开始应该初始化合适的值，防止多次扩容。合适值阿里规约中已经给出：<code>initialCapacity =（需要存储的元素个数 / 负载因子）+ 1</code>。</li><li>计算阈值的 <code>tableSizeFor()</code>、计算下标的 <code>hash&(n-1)</code> 取模、扩容时高低链表分别插入的 <code>(e.hash & oldCap) == 0</code> 和计算插入下标<strong>设计十分精妙</strong>，观之感叹不已！！！</li></ul><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=/posts/23af/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>从阿里规约谈起 - Arrays.asList 三坑</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=/posts/28aj/>从阿里规约谈起 - 禁用 Executors 创建线程池<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#new>new</a></li><li><a href=#put>put</a></li><li><a href=#resize>resize</a></li><li><a href=#总结>总结</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>