<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>ğŸ§‘â€ğŸ’»</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>ä»é˜¿é‡Œè§„çº¦è°ˆèµ· - HashMap åˆå§‹åŒ–å’Œæ‰©å®¹ç›¸å…³</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>å½’æ¡£</a></li><li><a href=https://blog.io01.xyz/about>å…³äº</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>ä»é˜¿é‡Œè§„çº¦è°ˆèµ· - HashMap åˆå§‹åŒ–å’Œæ‰©å®¹ç›¸å…³</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg>
<span class=text-gray-500>2019-08-30</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#series"/></svg>
<a href=https://blog.io01.xyz/series/%E9%98%BF%E9%87%8C%E8%A7%84%E7%BA%A6/ class=text-gray-500>é˜¿é‡Œè§„çº¦</a></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg>
<a href=https://blog.io01.xyz/tags/java/ class="text-gray-500 mr-1">Java
</a><a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">æºç </a></div></div></div></header><h2 id=å¼•è¨€>å¼•è¨€</h2><p>æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨ HashMap æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> HashMap <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span></code></pre></div><p>ä½†æ˜¯é˜¿é‡Œè§„çº¦ä¼šæç¤ºæœ‰é—®é¢˜ï¼š</p><p><img alt=æœªæŒ‡å®šåˆå§‹åŒ–å®¹é‡ title src=https://static.fori.fun/blog/posts/static/p3c_hashmap_error.png></p><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ HashMap åˆå§‹åŒ–å’Œæ‰©å®¹ç›¸å…³ã€‚</p><p>æ³¨ï¼šæœ¬æ–‡æ¶‰åŠäº†å°‘è®¸ HashMap åŸºç¡€ï¼Œç”±äºä¸ä¸»çº¿æ— å…³ï¼Œä¸è¯¦è®²ã€‚æºç å‡åŠ äº†äº›æ³¨é‡Šï¼Œæ³¨é‡Šæ— æ³•è§£é‡Šæ¸…æ¥šçš„åœ°æ–¹æ”¾åœ¨æºç ä¹‹åè®ºè¿°ã€‚</p><h2 id=new>new</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>HashMap</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>loadFactor</span> <span style=color:#ff79c6>=</span> DEFAULT_LOAD_FACTOR;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>HashMap</span>(<span style=color:#8be9fd>int</span> initialCapacity, <span style=color:#8be9fd>float</span> loadFactor) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#6272a4>//åˆ¤æ–­å¼‚å¸¸</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>//åˆå§‹åŒ–è´Ÿè½½å› å­</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>loadFactor</span> <span style=color:#ff79c6>=</span> loadFactor;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#6272a4>//åˆå§‹åŒ–é˜ˆå€¼</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>threshold</span> <span style=color:#ff79c6>=</span> tableSizeFor(initialCapacity);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4>//ååˆ†ç²¾å·§åœ°å®ç°äº†æ±‚ä¸€ä¸ªæ•°çš„æœ€è¿‘çš„ 2 çš„å¹‚</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>tableSizeFor</span>(<span style=color:#8be9fd>int</span> cap) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#8be9fd>int</span> n <span style=color:#ff79c6>=</span> cap <span style=color:#ff79c6>-</span> 1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> 1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> 2;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> 4;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> 8;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    n <span style=color:#ff79c6>|=</span> n <span style=color:#ff79c6>&gt;&gt;&gt;</span> 16;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>return</span> (n <span style=color:#ff79c6>&lt;</span> 0) <span style=color:#ff79c6>?</span> 1 : (n <span style=color:#ff79c6>&gt;=</span> MAXIMUM_CAPACITY) <span style=color:#ff79c6>?</span> MAXIMUM_CAPACITY : n <span style=color:#ff79c6>+</span> 1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><p>å‡ºäººï¼ˆ<del>æˆ‘è‡ªå·±</del>ï¼‰æ„æ–™çš„æ˜¯é»˜è®¤æ„é€ å‡½æ•°åˆå§‹åŒ–æå…¶ç®€å•ï¼Œåªç»™è´Ÿè½½å› å­èµ‹å€¼ï¼Œé™¤äº†ç›´æ¥ä¼ å…¥ map çš„æ„é€ å‡½æ•°å¤–ï¼Œæœ€å¤æ‚çš„ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ä¹Ÿåªæ˜¯ç»™è´Ÿè½½å› å­å’Œé˜ˆå€¼èµ‹å€¼ã€‚å¹¶æœªåˆå§‹åŒ– bucket æ•°ç»„ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™åˆå§‹åŒ– bucket æ•°ç»„çš„å‘¢ï¼Ÿ</p><p>å¾ˆå®¹æ˜“æƒ³åˆ°åˆå§‹åŒ–å®Œ HashMap æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>put()</code> æ“ä½œã€‚</p><h2 id=put>put</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> V <span style=color:#50fa7b>put</span>(K key, V value) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>return</span> putVal(hash(key), key, value, <span style=color:#ff79c6>false</span>, <span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>final</span> V <span style=color:#50fa7b>putVal</span>(<span style=color:#8be9fd>int</span> hash, K key, V value, <span style=color:#8be9fd>boolean</span> onlyIfAbsent, <span style=color:#8be9fd>boolean</span> evict) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;[]</span> tab; Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> p; <span style=color:#8be9fd>int</span> n, i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#6272a4>//å½“ç¬¬ä¸€æ¬¡ put æ—¶ï¼Œtable å°šæœªåˆå§‹åŒ–ï¼Œæ‰€ä»¥ tab ä¸º nullï¼Œè¿›è¡Œä¸€æ¬¡ resize() æ“ä½œ</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>//åç»­ put ä¸€èˆ¬ä¸å†èµ°è¯¥åˆ†æ”¯</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> ((tab <span style=color:#ff79c6>=</span> table) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> (n <span style=color:#ff79c6>=</span> tab.<span style=color:#50fa7b>length</span>) <span style=color:#ff79c6>==</span> 0)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        n <span style=color:#ff79c6>=</span> (tab <span style=color:#ff79c6>=</span> resize()).<span style=color:#50fa7b>length</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#6272a4>//ç¡®å®šå½“å‰ key åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>//æ­¤å¤„å°±æ˜¯ç»å…¸çš„å½“ n ä¸º 2 çš„å¹‚æ—¶ï¼Œ(n - 1) &amp; hash == hash % n çš„æŠ€å·§</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#6272a4>//å¦‚ä¸‹éƒ¨åˆ†ä¸ºç¢°æ’å’Œéç¢°æ’æ—¶çš„å‚¨å­˜è¿‡ç¨‹ï¼Œä¸æœ¬æ–‡ä¸»é¢˜ä¸ç›¸å…³ï¼Œä¸å†è¯¦ç»†è®ºè¿°</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>if</span> ((p <span style=color:#ff79c6>=</span> tab<span style=color:#ff79c6>[</span>i <span style=color:#ff79c6>=</span> (n <span style=color:#ff79c6>-</span> 1) <span style=color:#ff79c6>&amp;</span> hash<span style=color:#ff79c6>]</span>) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        tab<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> newNode(hash, key, value, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> e; K k;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>if</span> (p.<span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            ((k <span style=color:#ff79c6>=</span> p.<span style=color:#50fa7b>key</span>) <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> (key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key.<span style=color:#50fa7b>equals</span>(k))))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            e <span style=color:#ff79c6>=</span> p;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (p <span style=color:#ff79c6>instanceof</span> TreeNode)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            e <span style=color:#ff79c6>=</span> ((TreeNode<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span>)p).<span style=color:#50fa7b>putTreeVal</span>(<span style=color:#ff79c6>this</span>, tab, hash, key, value);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> binCount <span style=color:#ff79c6>=</span> 0; ; <span style=color:#ff79c6>++</span>binCount) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                <span style=color:#ff79c6>if</span> ((e <span style=color:#ff79c6>=</span> p.<span style=color:#50fa7b>next</span>) <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                    p.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> newNode(hash, key, value, <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                    <span style=color:#ff79c6>if</span> (binCount <span style=color:#ff79c6>&gt;=</span> TREEIFY_THRESHOLD <span style=color:#ff79c6>-</span> 1) <span style=color:#6272a4>// -1 for 1st</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                        treeifyBin(tab, hash);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                <span style=color:#ff79c6>if</span> (e.<span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>==</span> hash <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                    ((k <span style=color:#ff79c6>=</span> e.<span style=color:#50fa7b>key</span>) <span style=color:#ff79c6>==</span> key <span style=color:#ff79c6>||</span> (key <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> key.<span style=color:#50fa7b>equals</span>(k))))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>                p <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>if</span> (e <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) { <span style=color:#6272a4>// existing mapping for key</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            V oldValue <span style=color:#ff79c6>=</span> e.<span style=color:#50fa7b>value</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>onlyIfAbsent <span style=color:#ff79c6>||</span> oldValue <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                e.<span style=color:#50fa7b>value</span> <span style=color:#ff79c6>=</span> value;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>            afterNodeAccess(e);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#ff79c6>return</span> oldValue;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#ff79c6>++</span>modCount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    <span style=color:#6272a4>//size ä¸ºæ‰€æœ‰é”®å€¼å¯¹çš„æ•°é‡ï¼Œthreshold = capacity * loadFactor</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    <span style=color:#6272a4>//ä¹Ÿå°±æ˜¯å½“é”®å€¼å¯¹æ•°é‡è¶…è¿‡äº† capacity çš„ 0.75 å€æ—¶ï¼Œè°ƒç”¨ resize() æ‰©å®¹</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>++</span>size <span style=color:#ff79c6>&gt;</span> threshold)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        resize();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    afterNodeInsertion(evict);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#6272a4>//hash å€¼å¹¶é key çš„ hashCodeï¼Œè€Œæ˜¯ hashCode é«˜ä½ 16 ä½çš„å¼‚æˆ–</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4>//è¿™æ ·åšæ˜¯ä¸ºäº†é«˜ä½ä½è¿›è¡Œæ‰°åŠ¨ï¼Œä½¿å¾—è¿™ä¸ª hashCode èƒ½å¤Ÿå…¨éƒ¨å‚ä¸å¯¹æ•°ç»„ç´¢å¼•çš„è®¡ç®—</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#6272a4>//è¿›ä¸€æ­¥é™ä½ç¢°æ’çš„æ¦‚ç‡</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#6272a4>//æœ¬æ–‡åç»­æåŠçš„ hash å‡æŒ‡ hash(Object key) ä¹‹åçš„å€¼</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>hash</span>(Object key) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#8be9fd>int</span> h;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    <span style=color:#ff79c6>return</span> (key <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>?</span> 0 : (h <span style=color:#ff79c6>=</span> key.<span style=color:#50fa7b>hashCode</span>()) <span style=color:#ff79c6>^</span> (h <span style=color:#ff79c6>&gt;&gt;&gt;</span> 16);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>}
</span></span></code></pre></div><p>é€šè¿‡ <code>putVal()</code> æˆ‘ä»¬å¯çŸ¥ï¼Œå½“ç¬¬ä¸€æ¬¡æ‰§è¡Œ put æ“ä½œæ—¶æ‰ä¼šè°ƒç”¨ <code>resize()</code> çœŸæ­£åˆå§‹åŒ– bucket æ•°ç»„ï¼Œå½“é”®å€¼å¯¹è¶…è¿‡äº† <code>capacity</code> çš„ 0.75 å€æ—¶ï¼Œè°ƒç”¨ <code>resize()</code> æ‰©å®¹ã€‚</p><h2 id=resize>resize</h2><p>é‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹ <code>resize()</code> æ˜¯å¦‚ä½•æ‰©å®¹çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>final</span> Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;[]</span> <span style=color:#50fa7b>resize</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;[]</span> oldTab <span style=color:#ff79c6>=</span> table;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#8be9fd>int</span> oldCap <span style=color:#ff79c6>=</span> (oldTab <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>?</span> 0 : oldTab.<span style=color:#50fa7b>length</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>int</span> oldThr <span style=color:#ff79c6>=</span> threshold;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd>int</span> newCap, newThr <span style=color:#ff79c6>=</span> 0;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#6272a4>//å½“ table ä¸ä¸º null æ—¶ oldCap å¤§äº 0ï¼Œä¹Ÿå°±æ˜¯éåˆå§‹åŒ–ï¼Œå•çº¯æ‰©å®¹</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> (oldCap <span style=color:#ff79c6>&gt;</span> 0) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#6272a4>//è¶…è¿‡æœ€å¤§å€¼æ—¶ç›´æ¥æŠŠé˜ˆå€¼è®¾æˆ Integer.MAX_VALUEï¼Œä¸å†æ‰©å®¹</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#6272a4>//æ­¤æ—¶å¯ä»¥ç»§ç»­ put è¿›é”®å€¼å¯¹ï¼Œå› ä¸ºé”®ç›¸åŒ hash å€¼çš„ä¸åŒé”®å€¼å¯¹å¯ä»¥ç»§ç»­ä»¥é“¾è¡¨å½¢å¼åŠ å…¥å­˜å‚¨</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>if</span> (oldCap <span style=color:#ff79c6>&gt;=</span> MAXIMUM_CAPACITY) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            threshold <span style=color:#ff79c6>=</span> Integer.<span style=color:#50fa7b>MAX_VALUE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>return</span> oldTab;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#6272a4>//å¦åˆ™å°±æ‰©å®¹ 2 å€</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> ((newCap <span style=color:#ff79c6>=</span> oldCap <span style=color:#ff79c6>&lt;&lt;</span> 1) <span style=color:#ff79c6>&lt;</span> MAXIMUM_CAPACITY <span style=color:#ff79c6>&amp;&amp;</span> oldCap <span style=color:#ff79c6>&gt;=</span> DEFAULT_INITIAL_CAPACITY)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            newThr <span style=color:#ff79c6>=</span> oldThr <span style=color:#ff79c6>&lt;&lt;</span> 1; <span style=color:#6272a4>// double threshold</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#6272a4>//oldCap == 0ï¼Œä½†æ˜¯ oldThr &gt; 0ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¡¨ç¤ºå¸¦å‚æ„é€ å‡½æ•°åˆå§‹åŒ–</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (oldThr <span style=color:#ff79c6>&gt;</span> 0) <span style=color:#6272a4>// initial capacity was placed in threshold</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        newCap <span style=color:#ff79c6>=</span> oldThr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#6272a4>//oldCap == 0ï¼ŒoldThr == 0ï¼Œè¡¨ç¤ºæ— å‚æ„é€ å‡½æ•°åˆå§‹åŒ–</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// zero initial threshold signifies using defaults</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        newCap <span style=color:#ff79c6>=</span> DEFAULT_INITIAL_CAPACITY;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        newThr <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>int</span>)(DEFAULT_LOAD_FACTOR <span style=color:#ff79c6>*</span> DEFAULT_INITIAL_CAPACITY);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#6272a4>//åˆå§‹åŒ–æ–°é˜ˆå€¼</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>if</span> (newThr <span style=color:#ff79c6>==</span> 0) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#8be9fd>float</span> ft <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>float</span>)newCap <span style=color:#ff79c6>*</span> loadFactor;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        newThr <span style=color:#ff79c6>=</span> (newCap <span style=color:#ff79c6>&lt;</span> MAXIMUM_CAPACITY <span style=color:#ff79c6>&amp;&amp;</span> ft <span style=color:#ff79c6>&lt;</span> (<span style=color:#8be9fd>float</span>)MAXIMUM_CAPACITY <span style=color:#ff79c6>?</span> (<span style=color:#8be9fd>int</span>)ft : Integer.<span style=color:#50fa7b>MAX_VALUE</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    threshold <span style=color:#ff79c6>=</span> newThr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    @SuppressWarnings({<span style=color:#f1fa8c>&#34;rawtypes&#34;</span>,<span style=color:#f1fa8c>&#34;unchecked&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;[]</span> newTab <span style=color:#ff79c6>=</span> (Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;[]</span>)<span style=color:#ff79c6>new</span> Node<span style=color:#ff79c6>[</span>newCap<span style=color:#ff79c6>]</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    table <span style=color:#ff79c6>=</span> newTab;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#ff79c6>if</span> (oldTab <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#6272a4>//å°†åŸæ¥çš„ bucket æ•°ç»„å…ƒç´ è½¬ç§»è‡³æ–° bucket æ•°ç»„ä¸­</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> 0; j <span style=color:#ff79c6>&lt;</span> oldCap; <span style=color:#ff79c6>++</span>j) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            <span style=color:#ff79c6>if</span> ((e <span style=color:#ff79c6>=</span> oldTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>]</span>) <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                oldTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                <span style=color:#6272a4>//å½“ bucket åªå­˜åœ¨ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œç›´æ¥è®¡ç®—ä¸‹æ ‡ç´¢å¼•åˆ°æ–°çš„æ•°ç»„ä¸­</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                <span style=color:#ff79c6>if</span> (e.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>                    newTab<span style=color:#ff79c6>[</span>e.<span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>&amp;</span> (newCap <span style=color:#ff79c6>-</span> 1)<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>                <span style=color:#6272a4>//å½“ bucket å­˜åœ¨çº¢é»‘æ ‘æ—¶ï¼Œæ‹†åˆ†ç„¶åæ˜ å°„ï¼ˆæ¶‰åŠçº¢é»‘æ ‘ï¼Œä¸åšè¯¦è§£ï¼‰</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (e <span style=color:#ff79c6>instanceof</span> TreeNode)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>                    ((TreeNode<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span>)e).<span style=color:#50fa7b>split</span>(<span style=color:#ff79c6>this</span>, newTab, j, oldCap);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>                <span style=color:#6272a4>//å½“ bucket å­˜åœ¨ä¸€æ¡é“¾è¡¨æ—¶ï¼Œåˆ‡åˆ†æˆä¸¤æ¡é“¾ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ†æ</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                <span style=color:#ff79c6>else</span> { <span style=color:#6272a4>// preserve order</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                    Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> loHead <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>, loTail <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>                    Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> hiHead <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>, hiTail <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>                    Node<span style=color:#ff79c6>&lt;</span>K,V<span style=color:#ff79c6>&gt;</span> next;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>                    <span style=color:#ff79c6>do</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>                        next <span style=color:#ff79c6>=</span> e.<span style=color:#50fa7b>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>                        <span style=color:#ff79c6>if</span> ((e.<span style=color:#50fa7b>hash</span> <span style=color:#ff79c6>&amp;</span> oldCap) <span style=color:#ff79c6>==</span> 0) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>                            <span style=color:#ff79c6>if</span> (loTail <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>                                loHead <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                            <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                                loTail.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                            loTail <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>                        <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>                            <span style=color:#ff79c6>if</span> (hiTail <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>                                hiHead <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>                            <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                                hiTail.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                            hiTail <span style=color:#ff79c6>=</span> e;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>                    } <span style=color:#ff79c6>while</span> ((e <span style=color:#ff79c6>=</span> next) <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>                    <span style=color:#6272a4>//ä½é“¾ä¸‹æ ‡ä¸å˜</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>                    <span style=color:#ff79c6>if</span> (loTail <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                        loTail.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>                        newTab<span style=color:#ff79c6>[</span>j<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> loHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>                    <span style=color:#6272a4>//é«˜é“¾ä¸‹æ ‡ä¸ºåŸä¸‹æ ‡+åŸ bucket æ•°ç»„é•¿åº¦</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>                    <span style=color:#ff79c6>if</span> (hiTail <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>                        hiTail.<span style=color:#50fa7b>next</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>                        newTab<span style=color:#ff79c6>[</span>j <span style=color:#ff79c6>+</span> oldCap<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> hiHead;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#ff79c6>return</span> newTab;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>}
</span></span></code></pre></div><p><code>reszie()</code> æ“ä½œå¯¹äºæ‰©å®¹åˆ†ä¸ºäº†ä¸‰ç§æƒ…å†µ</p><ol><li>bucket åªæœ‰ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œç›´æ¥è®¡ç®—æ–°çš„ç´¢å¼•ä½ç½®å¹¶æ’å…¥é”®å€¼å¯¹</li><li>bucket æ˜¯çº¢é»‘æ ‘æ—¶ï¼Œè°ƒç”¨ <code>split</code> æ–¹æ³•å¤„ç†ã€‚</li><li>bucket æ˜¯é“¾è¡¨æ—¶ï¼Œåˆ†æˆäº†ä¸¤æ¡é“¾è¡¨ï¼Œä½ä½é“¾è¡¨æ’å…¥åŸä½ç½®ï¼Œé«˜ä½é“¾è¡¨æ’å…¥åŸç´¢å¼•+åŸ bucket æ•°ç»„é•¿åº¦å¤„</li></ol><p>è¯¦è®²ç¬¬ä¸‰ç§ï¼š</p><p>é¦–å…ˆè¦è®¤çŸ¥ä¸€ä»¶äº‹ï¼š<strong>å½“ bucket æˆé“¾è¡¨æ—¶ï¼Œé“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹çš„ hash å€¼ä¸ä¸€å®šç›¸åŒ</strong>ï¼Œå®ƒä»¬æˆä¸ºä¸€æ¡é“¾è¡¨åªå› ä¸ºè¯¥ key çš„ hash å€¼å–æ¨¡åå¾—åˆ°çš„å€¼ç›¸åŒã€‚</p><p>ç¬¬ä¸‰ç§æƒ…å†µå‘ç”Ÿåï¼Œæœ‰ä¸€ä¸ªç‰¹åˆ«çš„ä¼˜åŒ–ï¼š<code>(e.hash & oldCap) == 0</code></p><p>å½“ <code>(e.hash & oldCap) == 0</code> æ—¶æ’å…¥åˆ°åŸä¸‹æ ‡ä½ç½®ï¼Œå¦åˆ™æ’å…¥åŸä¸‹æ ‡+åŸ bucket æ•°ç»„é•¿åº¦å¤„ï¼Œä¸ºä½•å¦‚æ­¤æ’å…¥ï¼Ÿå¦‚ä¸‹ä¾‹å­å¸Œæœ›å¯ä»¥ç†è§£ï¼š</p><p>æ‰©å®¹å‰æ•°ç»„é•¿åº¦ n=16ï¼Œæ‰©å®¹å n=32ã€‚</p><p>ç°åœ¨æœ‰ä¸¤ä¸ª hashï¼š</p><ul><li>hash1 = <font face=monospace>1111 1111 0000 0101</font></li><li>hash2 = <font face=monospace>1111 1111 0001 0101</font></li></ul><table><thead><tr><th></th><th style=text-align:right>æ‰©å®¹å‰</th><th style=text-align:right>æ‰©å®¹å</th></tr></thead><tbody><tr><td>n</td><td style=text-align:right><font face=monospace>0000 0000 0001 0000</font></td><td style=text-align:right><font face=monospace>0000 0000 0010 0000</font></td></tr><tr><td>n-1</td><td style=text-align:right><font face=monospace>0000 0000 0000 <font color=green>1111</font></font></td><td style=text-align:right><font face=monospace>0000 0000 000<font color=red>1</font> <font color=green>1111</font></font></td></tr><tr><td>hash1</td><td style=text-align:right><font face=monospace>1111 1111 0000 <font color=green>0101</font></font></td><td style=text-align:right><font face=monospace>1111 1111 000<font color=red>0</font> <font color=green>0101</font></font></td></tr><tr><td>æ•°ç»„ä¸‹æ ‡<br>hash1&(n-1)</td><td style=text-align:right><font face=monospace>0000 0000 0000 <font color=green>0101</font><br>=5</font></td><td style=text-align:right><font face=monospace>0000 0000 000<font color=red>0</font> <font color=green>0101</font><br>=5</font></td></tr></tbody></table><table><thead><tr><th></th><th style=text-align:right>æ‰©å®¹å‰</th><th style=text-align:right>æ‰©å®¹å</th></tr></thead><tbody><tr><td>n</td><td style=text-align:right><font face=monospace>0000 0000 0001 0000</font></td><td style=text-align:right><font face=monospace>0000 0000 0010 0000</font></td></tr><tr><td>n-1</td><td style=text-align:right><font face=monospace>0000 0000 0000 <font color=green>1111</font></font></td><td style=text-align:right><font face=monospace>0000 0000 000<font color=red>1</font> <font color=green>1111</font></font></td></tr><tr><td>hash2</td><td style=text-align:right><font face=monospace>1111 1111 0001 <font color=green>0101</font></font></td><td style=text-align:right><font face=monospace>1111 1111 000<font color=red>1</font> <font color=green>0101</font></font></td></tr><tr><td>æ•°ç»„ä¸‹æ ‡<br>hash2&(n-1)</td><td style=text-align:right><font face=monospace>0000 0000 0000 <font color=green>0101</font><br>=5</font></td><td style=text-align:right><font face=monospace>0000 0000 000<font color=red>1</font> <font color=green>0101</font><br>=5+16</font></td></tr></tbody></table><p>ç»¿è‰²ä¸ºå‚ä¸è¿ç®—çš„ä½ï¼Œçº¢è‰²ä¸ºç”±äºæ‰©å®¹è€Œå¢åŠ å‚ä¸è¿ç®—çš„ä½ã€‚</p><p>å½“æ‰©å®¹ä»¥åï¼Œæ•°ç»„çš„é•¿åº¦çš„é«˜ä½å¤šäº†ä¸€ä½ <code>1</code> å‚ä¸è®¡ç®—ç´¢å¼•ä¸‹æ ‡ï¼Œæ‰€ä»¥åªéœ€è¦è®¡ç®— <code>n&amp;hash</code>ï¼Œå¦‚æœä¸º <code>0</code> æ—¶ï¼Œæ‰©å®¹å¯¼è‡´çš„æ–°å¢æœ€é«˜ä½ä¸å½±å“åŸä¸‹æ ‡è®¡ç®—ç»“æœï¼Œå¦åˆ™æ–°ä¸‹æ ‡ä¸ºåŸä¸‹æ ‡+åŸ bucket æ•°ç»„é•¿åº¦ã€‚ä½¿ç”¨è¯¥ç®—æ³•åä¸å¿…æ¯ä¸ªèŠ‚ç‚¹éƒ½é‡æ–°è®¡ç®—ä¸‹æ ‡ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><ul><li>HashMap åˆå§‹åŒ–æ—¶ä¸ä¼šåˆå§‹åŒ– bucket æ•°ç»„ï¼Œå½“ç¬¬ä¸€æ¬¡ put æ—¶æ‰ä¼šåˆå§‹åŒ–ï¼Œè€Œä¸”ä¼šåˆå§‹åŒ–ä¸ºç¦»ä¼ å…¥å€¼çš„æœ€è¿‘çš„ 2 çš„å¹‚ã€‚</li><li>å½“æ•°æ®é‡å¤§äº bucket æ•°ç»„çš„ 75% æ—¶ï¼Œæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€ã€‚</li><li>æ‰©å®¹+æ•°æ®ç§»åŠ¨æ˜¯è€—è´¹èµ„æºçš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å¼€å§‹åº”è¯¥åˆå§‹åŒ–åˆé€‚çš„å€¼ï¼Œé˜²æ­¢å¤šæ¬¡æ‰©å®¹ã€‚åˆé€‚å€¼é˜¿é‡Œè§„çº¦ä¸­å·²ç»ç»™å‡ºï¼š<code>initialCapacity =ï¼ˆéœ€è¦å­˜å‚¨çš„å…ƒç´ ä¸ªæ•° / è´Ÿè½½å› å­ï¼‰+ 1</code>ã€‚</li><li>è®¡ç®—é˜ˆå€¼çš„ <code>tableSizeFor()</code>ã€è®¡ç®—ä¸‹æ ‡çš„ <code>hash&(n-1)</code> å–æ¨¡ã€æ‰©å®¹æ—¶é«˜ä½é“¾è¡¨åˆ†åˆ«æ’å…¥çš„ <code>(e.hash & oldCap) == 0</code> å’Œè®¡ç®—æ’å…¥ä¸‹æ ‡<strong>è®¾è®¡ååˆ†ç²¾å¦™</strong>ï¼Œè§‚ä¹‹æ„Ÿå¹ä¸å·²ï¼ï¼ï¼</li></ul><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/23af/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>
ä»é˜¿é‡Œè§„çº¦è°ˆèµ· - Arrays.asList ä¸‰å‘</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/28aj/>ä»é˜¿é‡Œè§„çº¦è°ˆèµ· - ç¦ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± <svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#å¼•è¨€>å¼•è¨€</a></li><li><a href=#new>new</a></li><li><a href=#put>put</a></li><li><a href=#resize>resize</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2024
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a>
</span></span><span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a>
</span><span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>