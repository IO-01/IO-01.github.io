<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>ğŸ§‘â€ğŸ’»</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>å­çº¿ç¨‹æ›´æ–° UI å…¨è§£</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>å½’æ¡£</a></li><li><a href=https://blog.io01.xyz/about>å…³äº</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>å­çº¿ç¨‹æ›´æ–° UI å…¨è§£</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2022-01-06</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/android/ class="text-gray-500 mr-1">Android</a>
<a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">æºç </a></div></div></div></header><h2 id=å­çº¿ç¨‹æ›´æ–°-ui-å¼‚å¸¸è®¾è®¡ç†å¿µåŠç®€å•æºç è§£æ>å­çº¿ç¨‹æ›´æ–° UI å¼‚å¸¸è®¾è®¡ç†å¿µåŠç®€å•æºç è§£æ</h2><p>åˆå­¦è€…å¯èƒ½ä¼šçŠ¯åœ¨å­çº¿ç¨‹æ›´æ–° UI çš„é”™è¯¯ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span></code></pre></div><p>ä¸€æ—¦è¿è¡Œï¼Œåº”ç”¨ä¼šç›´æ¥å´©æºƒå¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ Android å¼€å‘çš„ä¸€æ¡é“å¾‹ï¼š<em>åœ¨å­çº¿ç¨‹ä¸­ä¸èƒ½æ›´æ–° UI</em>ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆ Android ä¸è®©å­çº¿ç¨‹æ›´æ–° UI å‘¢ï¼ŸåŸå› åœ¨äºç°åœ¨å±å¹•åˆ·æ–°ç‡æœ€ä½æ˜¯ 60Hzï¼Œæ„å‘³ç€æœ€å¤šæ¯ 16ms å°±ä¼šåˆ·æ–°ä¸€æ¬¡å±å¹•ï¼Œæ‰€ä»¥ UI æ›´æ–°è¦å°½å¯èƒ½å¿«é€Ÿï¼Œå¦åˆ™ä¼šä¸¢å¸§å¯¼è‡´å¡é¡¿ã€‚é‚£ä¹ˆ UI æ›´æ–°æ“ä½œå°±ä¸èƒ½åŠ é”ï¼Œé¢‘ç¹çš„åŠ é”é‡Šæ”¾é”å¯èƒ½ä¼šå»¶é•¿ UI æ¸²æŸ“æ—¶é—´ï¼Œä½†æ˜¯ä¸åŠ é”å¦‚æœå…è®¸å­çº¿ç¨‹æ›´æ–° UI ä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹å¯¹ UI åŒæ—¶æ›´æ–°ï¼Œé€ æˆçº¿ç¨‹ä¸å®‰å…¨è€Œå¯¼è‡´ UI æœ€ç»ˆæ•ˆæœæ— æ³•æƒ³è±¡ï¼Œæ‰€ä»¥ Android ç›´æ¥é™åˆ¶äº†å­çº¿ç¨‹æ›´æ–° UIï¼Œå®é™…ä¸Šä¸åªæ˜¯ Android æœ‰è¿™ç§é™åˆ¶ï¼Œå¸¸è§çš„ UI æ¡†æ¶åŸºæœ¬éƒ½æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚</p><p>äº†è§£äº†è®¾è®¡ç†å¿µï¼Œæˆ‘ä»¬ä»æºç çš„è§’åº¦æ¥åˆ†æä¸€ä¸‹ï¼Œæœ¬æ–‡ Framework æºç å‡æ¥è‡ª Android 11 ç‰ˆæœ¬ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å…ˆä» Log çš„è§’åº¦åˆ†æï¼Œé”™è¯¯æ—¥å¿—æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl$CalledFromWrongThreadException</span><span style=color:#ff79c6>:</span> Only the original thread that created a view hierarchy can touch its views<span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>checkThread</span><span style=color:#ff79c6>(</span>ViewRootImpl<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>8798</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>(</span>ViewRootImpl<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>1606</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>View</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>25390</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>View</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setBackgroundColor</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>23617</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ä»<code>View#setBackgroundColor()</code>èµ·å±‚å±‚è°ƒç”¨ä¹‹åä¼šåˆ°è¾¾<code>ViewRootImpl#checkThread()</code>ï¼Œç„¶åæŠ›å‡ºäº†å¼‚å¸¸ï¼Œ<code>ViewRootImpl#checkThread()</code> æ–¹æ³•æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>checkThreadcheckThread</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mThread <span style=color:#ff79c6>!=</span> Thread<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentThread</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> CalledFromWrongThreadException<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>               <span style=color:#f1fa8c>&#34;Only the original thread that created a view hierarchy can touch its views.&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ä»…æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹è·Ÿ <code>mThread</code> æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±æŠ›å‡ºå¼‚å¸¸ã€‚ç»§è€Œå¯ä»¥çœ‹åˆ° <code>mThread</code> æ˜¯åœ¨ <code>ViewRootImpl</code> æ„é€ æ–¹æ³•ä¸­è¢«åˆå§‹åŒ–çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>(</span>Context context<span style=color:#ff79c6>,</span> Display display<span style=color:#ff79c6>,</span> IWindowSession session<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>      <span style=color:#8be9fd>boolean</span> useSfChoreographer<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   mThread <span style=color:#ff79c6>=</span> Thread<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentThread</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æ‰€ä»¥åŸå› å¾ˆæ¸…æ¥šäº†ï¼šå½“å‰è°ƒç”¨çš„çº¿ç¨‹ä¸æ˜¯ <code>ViewRootImpl</code> çš„æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–çš„çº¿ç¨‹å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä½†æ˜¯è¿™ä»…ä»…çŸ¥å…¶ç„¶ï¼Œæƒ³è¦çŸ¥å…¶æ‰€ä»¥ç„¶è¿˜å¾—ç»§ç»­æ·±å…¥æºç è¿›è¡Œåˆ†æã€‚</p><h2 id=æ·±å…¥æºç è¿½è¸ª>æ·±å…¥æºç è¿½è¸ª</h2><p>ä» <code>imageView.setBackgroundColor()</code> å¼€å§‹ï¼Œæ ¹æ®è°ƒç”¨é“¾å¯ä»¥å¾—åˆ°å¯¹ <code>View#requestLayout()</code> çš„è°ƒç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#setBackgroundDrawable
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>requestLayout<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆé‡ç‚¹çœ‹ä¸€ä¸‹ <code>View#requestLayout()</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mMeasureCache <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> mMeasureCache<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#6272a4>// å¦‚æœ View æ ‘æ­£åœ¨ Layout æµç¨‹æ—¶æœ‰ View è°ƒç”¨ requestLayout()ï¼Œåˆ™å°†æ­¤ View åŠ å…¥åˆ° ViewRootImpl çš„é˜Ÿåˆ—ä¸­
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAttachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#6272a4>// Only trigger request-during-layout logic if this is the view requesting it,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// not the views in its parent hierarchy
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>      ViewRootImpl viewRoot <span style=color:#ff79c6>=</span> getViewRootImpl<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>viewRoot <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> viewRoot<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isInLayout</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>viewRoot<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayoutDuringLayout</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>               <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>   mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>   mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_INVALIDATED<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>   <span style=color:#6272a4>// å¦‚æœå½“å‰ View å­˜åœ¨ ViewParentï¼Œä¸” isLayoutRequested() ä¸º false åˆ™è°ƒç”¨ ViewParent çš„ requestLayout()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAttachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>View çš„ <code>requestLayout()</code> ä¼šè°ƒç”¨å…¶çˆ¶å¸ƒå±€çš„ <code>requestLayout()</code>ï¼ŒViewGrop å¹¶æ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥è¿˜æ˜¯è°ƒç”¨çš„ View çš„ <code>requestLayout()</code>ï¼Œå³ä¸€ç›´é€’å½’åˆ°æœ€ä¸Šå±‚ã€‚æ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æœ€ä¸Šå±‚çš„ View æ˜¯ä»€ä¹ˆã€‚</p><h3 id=activity-çš„é¡¶å±‚-view>Activity çš„é¡¶å±‚ View</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆä» <code>onCreate()</code> ä¸­çš„ <code>setContentView()</code> æ–¹æ³•çœ‹æˆ‘ä»¬åˆ›å»ºçš„å¸ƒå±€çš„çˆ¶ View æ˜¯è°ï¼ˆä¸ºäº†åˆ†æç®€å•ï¼Œæˆ‘ä»¬çš„ Activity ç»§æ‰¿è‡ª <code>android.app.Activity</code>ï¼Œè€Œé <code>androidx.appcompat.app.AppCompatActivity</code>ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.app.Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span>@LayoutRes <span style=color:#8be9fd>int</span> layoutResID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   getWindow<span style=color:#ff79c6>().</span><span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span>layoutResID<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   initWindowDecorActionBar<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>getWindow()</code>å¾—åˆ°çš„æ˜¯ <code>attach()</code>ä¸­åˆ›å»ºçš„ <code>PhoneWindow</code> å¯¹è±¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.app.Activity#attach
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mWindow <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> PhoneWindow<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> window<span style=color:#ff79c6>,</span> activityConfigCallback<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>æ‰€ä»¥å» <code>PhoneWindow</code> çš„ <code>setContentView()</code> ä¸­ä¸€æ¢ç©¶ç«Ÿï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> layoutResID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mContentParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      installDecor<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>hasFeature<span style=color:#ff79c6>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mContentParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>removeAllViews</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>hasFeature<span style=color:#ff79c6>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#6272a4>// å…±äº«å…ƒç´ åŠ¨ç”»ç›¸å…³
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>      <span style=color:#8be9fd;font-style:italic>final</span> Scene newScene <span style=color:#ff79c6>=</span> Scene<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSceneForLayout</span><span style=color:#ff79c6>(</span>mContentParent<span style=color:#ff79c6>,</span> layoutResID<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>               getContext<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      transitionTo<span style=color:#ff79c6>(</span>newScene<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mLayoutInflater<span style=color:#ff79c6>.</span><span style=color:#50fa7b>inflate</span><span style=color:#ff79c6>(</span>layoutResID<span style=color:#ff79c6>,</span> mContentParent<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä¼ å…¥çš„ <code>layoutResID</code> é€šè¿‡ <code>mLayoutInflater.inflate(layoutResID, mContentParent)</code> å°† xml å¸ƒå±€åŠ è½½åˆ° <code>mContentParent</code> ä¸­ï¼Œé‚£ä¹ˆå°±è¦çœ‹çœ‹ <code>mContentParent</code> æ˜¯æ€ä¹ˆåˆ›å»ºå‡ºæ¥çš„ï¼Œå³<code>installDecor()</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>installDecor</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   mForceDecorInstall <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecor <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      mDecor <span style=color:#ff79c6>=</span> generateDecor<span style=color:#ff79c6>(-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setDescendantFocusability</span><span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>FOCUS_AFTER_DESCENDANTS</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIsRootNamespace</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mInvalidatePanelMenuPosted <span style=color:#ff79c6>&amp;&amp;</span> mInvalidatePanelMenuFeatures <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>postOnAnimation</span><span style=color:#ff79c6>(</span>mInvalidatePanelMenuRunnable<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setWindow</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mContentParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mContentParent <span style=color:#ff79c6>=</span> generateLayout<span style=color:#ff79c6>(</span>mDecor<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>é¦–å…ˆéœ€è¦äº†è§£ DecorView æ˜¯ä¸€ä¸ª FrameLayout çš„å­ç±»ï¼Œä¸Šè¿°æºç é€šè¿‡ <code>generateDecor()</code> åˆ›å»ºå‡ºä¸€ä¸ª DecorView èµ‹å€¼ç»™ <code>mDecor</code>ï¼Œç„¶åé€šè¿‡ <code>generateLayout()</code> åˆ›å»ºå‡ºä¸€ä¸ª ViewGroup èµ‹å€¼ç»™ <code>mContentParent</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>protected</span> DecorView <span style=color:#50fa7b>generateDecor</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> featureId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   Context context<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mUseDecorContext<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      Context applicationContext <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>().</span><span style=color:#50fa7b>getApplicationContext</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>applicationContext <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            context <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            context <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DecorContext<span style=color:#ff79c6>(</span>applicationContext<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mTheme <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>               context<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setTheme</span><span style=color:#ff79c6>(</span>mTheme<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      context <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DecorView<span style=color:#ff79c6>(</span>context<span style=color:#ff79c6>,</span> featureId<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> getAttributes<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¤„ç†å®Œ context ä¹‹åå°±ç›´æ¥ new äº†ä¸€ä¸ª DecorView å¯¹è±¡ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ <code>generateLayout()</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>protected</span> ViewGroup <span style=color:#50fa7b>generateLayout</span><span style=color:#ff79c6>(</span>DecorView decor<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#6272a4>// å‰é¢ä¼šæ ¹æ®ä¸åŒçš„ window feature ä½¿ç”¨ä¸åŒçš„å¸ƒå±€æ–‡ä»¶ï¼Œæ¯”å¦‚ FEATURE_NO_TITLE å°±æ˜¯æ²¡æœ‰æ ‡é¢˜æ çš„å¸ƒå±€
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>   mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>onResourcesLoaded</span><span style=color:#ff79c6>(</span>mLayoutInflater<span style=color:#ff79c6>,</span> layoutResource<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   ViewGroup contentParent <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>)</span>findViewById<span style=color:#ff79c6>(</span>ID_ANDROID_CONTENT<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>return</span> contentParent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å‡è®¾é€šè¿‡ä¸Šé¢ feature æ¡ä»¶åˆ¤æ–­æœ€åçš„å¸ƒå±€æ–‡ä»¶æ˜¯ <code>R.layout.screen_simple</code>ï¼Œæºç ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;LinearLayout</span> <span style=color:#50fa7b>xmlns:android=</span><span style=color:#f1fa8c>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#50fa7b>android:fitsSystemWindows=</span><span style=color:#f1fa8c>&#34;true&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>android:orientation=</span><span style=color:#f1fa8c>&#34;vertical&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>&lt;ViewStub</span> <span style=color:#50fa7b>android:id=</span><span style=color:#f1fa8c>&#34;@+id/action_mode_bar_stub&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>              <span style=color:#50fa7b>android:inflatedId=</span><span style=color:#f1fa8c>&#34;@+id/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>              <span style=color:#50fa7b>android:layout=</span><span style=color:#f1fa8c>&#34;@layout/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>              <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>              <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>              <span style=color:#50fa7b>android:theme=</span><span style=color:#f1fa8c>&#34;?attr/actionBarTheme&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>&lt;FrameLayout</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>         <span style=color:#50fa7b>android:id=</span><span style=color:#f1fa8c>&#34;@android:id/content&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>         <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>         <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>         <span style=color:#50fa7b>android:foregroundInsidePadding=</span><span style=color:#f1fa8c>&#34;false&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>         <span style=color:#50fa7b>android:foregroundGravity=</span><span style=color:#f1fa8c>&#34;fill_horizontal|top&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>         <span style=color:#50fa7b>android:foreground=</span><span style=color:#f1fa8c>&#34;?android:attr/windowContentOverlay&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¯¥å¸ƒå±€æ˜¯ä¸€ä¸ª LinearLayout å¸ƒå±€ï¼ŒåŒ…æ‹¬ä¸€ä¸ª id ä¸º <code>action_mode_bar_stub</code> çš„ ç”¨ ViewStub å¼•ç”¨çš„ ActionBarï¼Œä¸€ä¸ª id ä¸º <code>@android:id/content</code> çš„ FrameLayoutã€‚</p><p>ç»§ç»­è·Ÿè¸ª <code>onResourcesLoaded()</code> æ–¹æ³•ï¼Œçœ‹çœ‹å¸ƒå±€æ–‡ä»¶å’Œ DecorView çš„å…³ç³»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onResourcesLoaded</span><span style=color:#ff79c6>(</span>LayoutInflater inflater<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> layoutResource<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> View root <span style=color:#ff79c6>=</span> inflater<span style=color:#ff79c6>.</span><span style=color:#50fa7b>inflate</span><span style=color:#ff79c6>(</span>layoutResource<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecorCaptionView <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecorCaptionView<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParent</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            addView<span style=color:#ff79c6>(</span>mDecorCaptionView<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                  <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      mDecorCaptionView<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>               <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MarginLayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#6272a4>// Put it below the color views.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>      addView<span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   mContentRoot <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>)</span> root<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>   initializeElevation<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å°†å¸ƒå±€æ–‡ä»¶åŠ è½½æˆ View ç„¶åæ·»åŠ åˆ° DecorView ä¸­ã€‚ç„¶åç»§ç»­çœ‹ <code>generateLayout()</code> å‰©ä¸‹çš„ä»£ç æ˜¯ <code>findViewById(ID_ANDROID_CONTENT)</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.Window
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T <span style=color:#8be9fd;font-style:italic>extends</span> View<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>findViewById</span><span style=color:#ff79c6>(</span>@IdRes <span style=color:#8be9fd>int</span> id<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>return</span> getDecorView<span style=color:#ff79c6>().</span><span style=color:#50fa7b>findViewById</span><span style=color:#ff79c6>(</span>id<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>ID_ANDROID_CONTENT</code> çš„å€¼æ˜¯ <code>com.android.internal.R.id.content</code>ï¼Œè¿™ä¸ª id å®é™…å¯¹åº”çš„å°±æ˜¯ä¸Šé¢ xml æ–‡ä»¶ä¸­çš„ id ä¸º <code>@android:id/content</code> çš„ FrameLayoutï¼Œæ‰€ä»¥ <code>mContentParent</code> å°±æ˜¯é‚£ä¸ª LinearLayout çš„å­ Viewï¼Œè‡³æ­¤æˆ‘ä»¬å®Œæˆäº†å¯¹ Activity ä¸­ View çˆ¶å¸ƒå±€çš„å®Œæ•´é“¾è·¯è¿½è¸ªã€‚</p><p>View é€’å½’çˆ¶å¸ƒå±€å°ç»“ï¼šå¼€å‘è€…çš„ xml ç”Ÿæˆçš„å¸ƒå±€ -> mContentParentï¼ˆFragmentLayoutï¼‰-> ç³»ç»Ÿå†…ç½®å¸ƒå±€æ–‡ä»¶ç”Ÿæˆçš„ Viewï¼ˆLinearLayoutï¼‰-> mDecorï¼ˆDecorViewï¼‰ã€‚</p><h3 id=decorview-çš„-viewparent>DecorView çš„ ViewParent</h3><p>è™½ç„¶æˆ‘ä»¬å·²ç»å¾—åˆ° DecorView æ˜¯é¡¶å±‚ Viewï¼Œä½†æ˜¯é—®é¢˜æ²¡æœ‰çœŸæ­£è§£å†³ï¼šå¦‚æœ DecorView æ²¡æœ‰çˆ¶ Viewï¼Œæœ€åé€’å½’ <code>requestLayout()</code> å²‚ä¸æ˜¯å°±æ­¤ç»ˆç»“ç›¸å½“äºä»€ä¹ˆéƒ½æ²¡å¹²ï¼Ÿå…¶å®æˆ‘ä»¬ä¸€ç›´è¯´é€’å½’æŸ¥æ‰¾çˆ¶ <em>View</em> çš„è¯´æ³•æ˜¯ä¸å‡†ç¡®çš„ï¼Œåº”è¯¥è¯´é€’å½’æŸ¥æ‰¾ <em>ViewParent</em>ï¼ŒDecorView è™½ç„¶æ²¡æœ‰çˆ¶ <em>View</em> äº†ï¼Œä½†æ˜¯å®ƒä¾ç„¶æœ‰ <em>ViewParent</em>ã€‚ä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸èƒ½åƒä¸Šé¢é‚£æ ·è‡ªä¸‹è€Œä¸Šè¿½æº¯ï¼Œè€Œæ˜¯è‡ªä¸Šè€Œä¸‹å…ˆäº†è§£äº† Activity ç”Ÿå‘½å‘¨æœŸçš„æµç¨‹æ‰èƒ½å¾—åˆ°ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>ActivityThread#handleResumeActivity()</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.app.ActivityThread
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>handleResumeActivity</span><span style=color:#ff79c6>(</span>IBinder token<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> finalStateRequest<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> isForward<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      String reason<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> ActivityClientRecord r <span style=color:#ff79c6>=</span> performResumeActivity<span style=color:#ff79c6>(</span>token<span style=color:#ff79c6>,</span> finalStateRequest<span style=color:#ff79c6>,</span> reason<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> Activity a <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>activity</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#8be9fd>boolean</span> willBeVisible <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mStartedActivity</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mFinished</span> <span style=color:#ff79c6>&amp;&amp;</span> willBeVisible<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span> <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>activity</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWindow</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      View decor <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDecorView</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      decor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setVisibility</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>INVISIBLE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      ViewManager wm <span style=color:#ff79c6>=</span> a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWindowManager</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      WindowManager<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> l <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAttributes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mVisibleFromClient</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mWindowAdded</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>               a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mWindowAdded</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>               wm<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>decor<span style=color:#ff79c6>,</span> l<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>è¿™äº›ä»£ç çœŸæ­£éœ€è¦æˆ‘ä»¬åˆ†æçš„åªæœ‰ä¸€è¡Œï¼š<code>wm.addView(decor, l)</code>ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°† DecorView æ·»åŠ åˆ° WindowManager ä¸­ã€‚æ‰¾åˆ° WindowManager çš„å®ç°ç±»æ˜¯ <code>WindowManagerImpl</code>ï¼Œ<code>addView</code> çš„æºç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.WindowManagerImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>@NonNull View view<span style=color:#ff79c6>,</span> @NonNull ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> params<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   applyDefaultToken<span style=color:#ff79c6>(</span>params<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   mGlobal<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>,</span> params<span style=color:#ff79c6>,</span> mContext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDisplayNoVerify</span><span style=color:#ff79c6>(),</span> mParentWindow<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            mContext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUserId</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ç»§ç»­è¿½è¸ª <code>mGlobal.addview()</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.WindowManagerGlobal
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>View view<span style=color:#ff79c6>,</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> params<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      Display display<span style=color:#ff79c6>,</span> Window parentWindow<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> userId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   ViewRootImpl root<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   View panelParentView <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#ff79c6>(</span>mLock<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      root <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ViewRootImpl<span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getContext</span><span style=color:#ff79c6>(),</span> display<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setLayoutParams</span><span style=color:#ff79c6>(</span>wparams<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      mViews<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mRoots<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      mParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>wparams<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#6272a4>// do this last because it fires off messages to start doing things
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            root<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setView</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>,</span> wparams<span style=color:#ff79c6>,</span> panelParentView<span style=color:#ff79c6>,</span> userId<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>RuntimeException e<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#6272a4>// BadTokenException or InvalidDisplayException, clean up.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>index <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>               removeViewLocked<span style=color:#ff79c6>(</span>index<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#ff79c6>throw</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å®ä¾‹åŒ–äº†ä¸€ä¸ª ViewRootImpl å¯¹è±¡ï¼Œå¹¶ä¸”å°† DecorView ä¼ å…¥äº† <code>setView()</code> ä¸­ï¼Œé‚£ä¹ˆç»§ç»­è¿½è¸ªï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setView</span><span style=color:#ff79c6>(</span>View view<span style=color:#ff79c6>,</span> WindowManager<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> attrs<span style=color:#ff79c6>,</span> View panelParentView<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      <span style=color:#8be9fd>int</span> userId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mView <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>assignParent</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>è¿™ä¸ªæ–¹æ³•éå¸¸é•¿ï¼Œä½†æ˜¯æˆ‘ä»¬åªæ˜¯ä¸ºäº†è¿½è¸ª DecorView çš„ ViewParentï¼Œæ‰€ä»¥åªéœ€è¦è¿½è¸ªä¸€è¡Œ <code>view.assignParent(this)</code>ï¼ŒDecorView æ²¡æœ‰é‡å†™ï¼Œä¸€ç›´è¿½è¸ªåˆ° View çš„è¯¥æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>assignParent</span><span style=color:#ff79c6>(</span>ViewParent parent<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      mParent <span style=color:#ff79c6>=</span> parent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>parent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mParent <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RuntimeException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;view &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; being added, but&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>               <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; it already has a parent&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æ‰€ä»¥é—®é¢˜è§£å†³ï¼ŒDecorView çš„ ViewParent æ˜¯ ViewRootImplã€‚</p><h3 id=viewrootimpl-çš„-requestlayout>ViewRootImpl çš„ requestLayout</h3><p>ç»ˆäºå¯ä»¥å›å½’æ­£é¢˜ï¼Œçœ‹çœ‹ ViewRootImpl çš„ <code>requestLayout()</code> åšäº†äº›ä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mHandlingLayoutInLayoutRequest<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      checkThread<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      mLayoutRequested <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>      scheduleTraversals<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ç»ˆäºçœ‹åˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ <code>checkThread()</code>ï¼Œå›å½’åˆ°æœ€åˆç®€è¦åˆ†ææ—¶çš„ç»“è®ºäº†ï¼šå½“å‰è°ƒç”¨çš„çº¿ç¨‹ä¸æ˜¯ ViewRootImpl çš„æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–çš„çº¿ç¨‹å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p>é‚£ä¹ˆ ViewRootImpl åˆå§‹åŒ–çš„æ–¹æ³•åœ¨ä»€ä¹ˆçº¿ç¨‹å‘¢ï¼Œ<code>ActivityThread#handleResumeActivity()</code> å¯¼è‡´äº† ViewRootImpl çš„åˆå§‹åŒ–ï¼Œåˆå› ä¸º ActivityThread æ‰€åœ¨çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ ViewRootImpl åˆå§‹åŒ–çš„æ–¹æ³•åœ¨ä¸»çº¿ç¨‹ã€‚</p><p>å…¶å®é€šè¿‡æ·±å…¥æºç åˆ†æå¾—åˆ°çš„é“¾è·¯å¾ˆæ¸…æ™°ï¼š</p><ol><li><p>å­çº¿ç¨‹æ›´æ–° View ä¼šè°ƒç”¨ <code>View#requestLayout()</code>ï¼Œç„¶åå¼€å§‹é€’å½’æŸ¥æ‰¾çˆ¶ Viewï¼Œæ‰¾åˆ°äº† Activity çš„é¡¶å±‚ View æ˜¯ DecorViewã€‚</p></li><li><p>DecorView çš„ ViewParent æ˜¯ ViewRootImplï¼Œæ‰€ä»¥è°ƒç”¨äº† <code>ViewRootImpl#requestLayout()</code>ï¼Œç»§è€Œè°ƒç”¨äº† <code>ViewRootImpl#checkThread()</code>ã€‚</p></li><li><p>ViewRootImpl åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–ï¼Œå› æ­¤å­çº¿ç¨‹è°ƒç”¨æ£€æŸ¥çº¿ç¨‹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p></li></ol><h2 id=å­çº¿ç¨‹æ›´æ–°-view-ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µ>å­çº¿ç¨‹æ›´æ–° View ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µ</h2><p>çŸ¥é“äº†å­çº¿ç¨‹æ›´æ–° View å‘ç”Ÿå¼‚å¸¸çš„åŸå› ï¼Œè‡ªç„¶å°±ä¼šæƒ³æ˜¯å¦æœ‰å­çº¿ç¨‹ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µã€‚</p><h3 id=é’ˆå¯¹é€šç”¨-view-çš„æ–¹æ¡ˆ>é’ˆå¯¹é€šç”¨ View çš„æ–¹æ¡ˆ</h3><p>æ ¹æ® <code>View#requestLayout()</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#requestLayout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ä¸¤ä¸ªæ¡ä»¶ï¼š<code>mParent != null</code> å’Œ <code>mParent.isLayoutRequested() == false</code> éƒ½æ»¡è¶³æ‰ä¼šè°ƒç”¨ <code>mParent.requestLayout()</code>ï¼Œæ‰€ä»¥å¯ä»¥æƒ³åŠæ³•æ‰“ç ´è¿™ä¸¤ä¸ªæ¡ä»¶ã€‚</p><h4 id=åœ¨-activityonresume-åŠä»¥å‰æ›´æ–°-view>åœ¨ <code>Activity#onResume()</code> åŠä»¥å‰æ›´æ–° View</h4><p>æœ‰ä¸€æ¡å…³è” Activity ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨é“¾æ˜¯ï¼š<code>ActivityThread#handleResumeActivity()</code> -> <code>ActivityThread#performResumeActivity()</code> -> <code>Activity#performResume()</code> -> <code>Instrumentation#callActivityOnResume()</code> -> <code>Activity#onResume()</code>ï¼Œå› ä¸ºç¯‡å¹…å’Œä¸»é¢˜åŸå› ï¼Œä¸å¤šèµ˜è¿°ã€‚</p><p>ç”±è°ƒç”¨é“¾å¯çŸ¥ ViewRootImpl åœ¨ <code>Activity#onResume()</code> ä¹‹ååˆå§‹åŒ–ï¼Œæ‰€ä»¥å¦‚æœåœ¨æ­¤ä¹‹å‰è°ƒç”¨ <code>View#requestLayout()</code> é€’å½’åˆ° DecorView æ—¶ä¸æ»¡è¶³ <code>mParent != null</code> è€Œä¸ä¼šè°ƒç”¨åˆ° <code>ViewRootImpl#requestLayout()</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.demo.MainActivity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   setContentView(<span style=color:#50fa7b>R</span>.layout.activity_main)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div><h4 id=åœ¨å­çº¿ç¨‹æ›´æ–°-view-ä¹‹å‰å…ˆ-requestlayout>åœ¨å­çº¿ç¨‹æ›´æ–° View ä¹‹å‰å…ˆ requestLayout</h4><p>é¦–å…ˆæ ¹æ® <code>View#isLayoutRequested()</code> çš„æºç å¯å¾—ä¸ <code>mPrivateFlags</code> æ˜¯å¦å­˜åœ¨ <code>PFLAG_FORCE_LAYOUT</code> æœ‰å…³ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>è€Œæ ¹æ® <code>View#requestLayout()</code> çš„æºç ï¼Œå¯å¾—ç¬¬ä¸€å±‚è¯·æ±‚æ—¶å°±ä¼šåœ¨ <code>mPrivateFlags</code> åŠ å…¥ <code>PFLAG_FORCE_LAYOUT</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#requestLayout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_INVALIDATED<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæ˜¯ä»€ä¹ˆæ—¶å€™ <code>mPrivateFlags</code> å»æ‰ <code>PFLAG_FORCE_LAYOUT</code> å‘¢ï¼Ÿæ˜¯åœ¨ <code>View#layout()</code> é‡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#layout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mPrivateFlags <span style=color:#ff79c6>&amp;=</span> <span style=color:#ff79c6>~</span>PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span></code></pre></div><p>å…·ä½“çš„ View å¸ƒå±€æµç¨‹å› ä¸ºç¯‡å¹…åŸå› ç®€å•æ¦‚è¿°ä¸åšæ·±å…¥æºç è¿½è¸ªäº†ï¼š</p><p><code>ViewRootImpl#requestLayout()</code> -> <code>ViewRootImpl#scheduleTraversals()</code> ä¼šæœ€ç»ˆè°ƒç”¨åˆ° <code>ViewRootImpl#performTraversals()</code>ï¼Œä½†å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œè€Œæ˜¯é€šè¿‡ Choreographer ç­‰åˆ°ä¸‹ä¸€ä¸ª VSYNC æ—¶æ‰è°ƒç”¨ï¼Œ<code>ViewRootImpl#performTraversals()</code> -> <code>ViewRootImpl#performLayout()</code> -> <code>View#layout()</code>ï¼Œæ‰€ä»¥ <code>mParent.isLayoutRequested()</code> åœ¨ä¸‹ä¸€ä¸ª VSYNC æ—¶æ‰ä¼šè¢«èµ‹å€¼ä¸º <code>false</code>ï¼Œæ— æ³•å½±å“åˆ°é©¬ä¸Šæ‰§è¡Œçš„å­çº¿ç¨‹æ›´æ–° Viewã€‚</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆä¸»çº¿ç¨‹è°ƒç”¨ä¸€æ¬¡<code>requestLayout()</code>ï¼Œé©¬ä¸Šè°ƒç”¨å­çº¿ç¨‹æ›´æ–° View å°±ä¸ä¼šå‘ç”Ÿå¼‚å¸¸äº†ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.demo.MainActivity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   setContentView(<span style=color:#50fa7b>R</span>.layout.activity_main)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   imageView.setOnClickListener {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>      imageView.requestLayout()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>      thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h4 id=å­çº¿ç¨‹åˆå§‹åŒ–-viewrootimpl>å­çº¿ç¨‹åˆå§‹åŒ– ViewRootImpl</h4><p>æœ¬è´¨ä¸Šä¸æ˜¯å­çº¿ç¨‹ä¸èƒ½æ›´æ–° UIï¼Œè€Œæ˜¯<em>éæ„é€  ViewRootImpl çº¿ç¨‹</em>ä¸èƒ½æ›´æ–° UIï¼Œæ‰€ä»¥å­çº¿ç¨‹æ„é€  ViewRootImplï¼Œçº¿ç¨‹æ£€æŸ¥æ—¶å°±ä¸ä¼šæŠ¥é”™äº†ã€‚ViewRootImpl åˆå§‹åŒ–åœ¨ <code>WindowManagerGlobal#addView()</code> ä¸­ï¼Œå¤–éƒ¨èƒ½è®¿é—®åˆ°çš„æ˜¯ WindowManagerGlobal æ˜¯ WindowManager çš„ä»£ç†ç±»ï¼Œå¤–éƒ¨é€šè¿‡ <code>WindowManager#addView()</code> å»è°ƒç”¨å³å¯ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.demo.MainActivity#onCreate
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>button.setOnClickListener {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   thread {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>         <span style=color:#50fa7b>Looper</span>.prepare()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>         <span style=color:#ff79c6>val</span> imageView = ImageView(<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         windowManager.addView(imageView, <span style=color:#50fa7b>WindowManager</span>.LayoutParams())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#50fa7b>Looper</span>.loop()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>æ³¨æ„è¦åœ¨ <code>Looper.prepare()</code> ä¹‹åè°ƒç”¨ <code>WindowManager#addView()</code>ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š<code>java.lang.RuntimeException: Can't create handler inside thread Thread[xxxx] that has not called Looper.prepare()</code>ã€‚</p><p>åŸå› æ˜¯ ViewRootImpl åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ª Headlerï¼ŒHeadler åˆå§‹åŒ–çš„æ—¶å€™ä¼šä» ThreadLocal ä¸­è·å– Looperï¼Œè·å–ä¸åˆ°å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ <code>Looper.prepare()</code> å°±æ˜¯æ„é€ ä¸ª Looper æ”¾è¿› ThreadLocal ä¸­ã€‚</p><h3 id=é’ˆå¯¹ç‰¹å®š-view-çš„æ–¹æ¡ˆ>é’ˆå¯¹ç‰¹å®š View çš„æ–¹æ¡ˆ</h3><p>æ›´æ–° View ä¸€èˆ¬ä¼šè°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼š<code>View#requestLayout()</code> å’Œ <code>View#invalidate()</code>ï¼Œå¦‚æœåªè°ƒç”¨åè€…æˆ‘ä»¬å¯ä»¥è·Ÿè¸ªä¸€ä¸‹æºç çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidate</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>boolean</span> invalidateCache<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   invalidateInternal<span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> mRight <span style=color:#ff79c6>-</span> mLeft<span style=color:#ff79c6>,</span> mBottom <span style=color:#ff79c6>-</span> mTop<span style=color:#ff79c6>,</span> invalidateCache<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidateInternal</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> l<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> t<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> r<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> b<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> invalidateCache<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#8be9fd>boolean</span> fullInvalidate<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>(</span>PFLAG_DRAWN <span style=color:#ff79c6>|</span> PFLAG_HAS_BOUNDS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>(</span>PFLAG_DRAWN <span style=color:#ff79c6>|</span> PFLAG_HAS_BOUNDS<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>invalidateCache <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_DRAWING_CACHE_VALID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> PFLAG_DRAWING_CACHE_VALID<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_INVALIDATED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> PFLAG_INVALIDATED
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>fullInvalidate <span style=color:#ff79c6>&amp;&amp;</span> isOpaque<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> mLastIsOpaque<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> AttachInfo ai <span style=color:#ff79c6>=</span> mAttachInfo<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> ViewParent p <span style=color:#ff79c6>=</span> mParent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> ai <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> l <span style=color:#ff79c6>&lt;</span> r <span style=color:#ff79c6>&amp;&amp;</span> t <span style=color:#ff79c6>&lt;</span> b<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#8be9fd;font-style:italic>final</span> Rect damage <span style=color:#ff79c6>=</span> ai<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mTmpInvalRect</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            damage<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>l<span style=color:#ff79c6>,</span> t<span style=color:#ff79c6>,</span> r<span style=color:#ff79c6>,</span> b<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invalidateChild</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> damage<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>p.invalidateChild(this, damage)</code> è¡¨ç¤ºä½¿ ViewParent é‡ç»˜è¿™ä¸ª Viewï¼Œæ‰€ä»¥è·Ÿè¸ªä¸€ä¸‹ ViewGroup çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewGroup
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidateChild</span><span style=color:#ff79c6>(</span>View child<span style=color:#ff79c6>,</span> <span style=color:#8be9fd;font-style:italic>final</span> Rect dirty<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> AttachInfo attachInfo <span style=color:#ff79c6>=</span> mAttachInfo<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>attachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> attachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mHardwareAccelerated</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#6272a4>// HW accelerated fast path
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>      onDescendantInvalidated<span style=color:#ff79c6>(</span>child<span style=color:#ff79c6>,</span> child<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>é¦–å…ˆå°±ä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯äº†ç¡¬ä»¶åŠ é€Ÿï¼Œå¦‚æœå¼€å¯äº†ä¼šè¿›å…¥ç¡¬ä»¶åŠ é€Ÿé€»è¾‘ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewGroup
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span>@NonNull View child<span style=color:#ff79c6>,</span> @NonNull View target<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> target<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>åˆæ˜¯å‘ä¸Šé€’å½’ï¼Œæˆ‘ä»¬è½»è½¦ç†Ÿè·¯å»æ‰¾ <code>ViewRootImpl#onDescendantInvalidated()</code> çš„å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span>@NonNull View child<span style=color:#ff79c6>,</span> @NonNull View descendant<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>descendant<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mPrivateFlags</span> <span style=color:#ff79c6>&amp;</span> PFLAG_DRAW_ANIMATION<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      mIsAnimating <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>@UnsupportedAppUsage
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidate</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   mDirty<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> mWidth<span style=color:#ff79c6>,</span> mHeight<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mWillDrawSoon<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      scheduleTraversals<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æœ€åè·Ÿ <code>ViewRootImpl#requestLayout()</code> ä¸€æ ·è°ƒç”¨åˆ°äº† <code>ViewRootImpl#scheduleTraversals()</code>ï¼Œä½†æ˜¯å´æ²¡æœ‰è°ƒç”¨<code>ViewRootImpl#checkThread()</code>ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç»“è®ºï¼šåœ¨ç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µä¸‹åªè°ƒç”¨ <code>View#invalidate()</code> ä¸ä¼šè§¦å‘çº¿ç¨‹æ£€æŸ¥ã€‚</p><p>é‚£ä¹ˆåœ¨éç¡¬ä»¶åŠ é€Ÿçš„æ—¶å€™å‘¢ï¼Ÿè¿˜å¾—è¿”å›å»çœ‹çœ‹ <code>ViewGroup#invalidateChild()</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewGroup#invalidateChild
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>do</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   parent <span style=color:#ff79c6>=</span> parent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invalidateChildInParent</span><span style=color:#ff79c6>(</span>location<span style=color:#ff79c6>,</span> dirty<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>parent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>å¾ªç¯è°ƒç”¨ <code>ViewParent#invalidateChildInParent()</code>ï¼Œæ‰€ä»¥å» <code>ViewRootImpl#invalidateChildInParent()</code> ä¸­ä¸€æ¢ç©¶ç«Ÿï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> ViewParent <span style=color:#50fa7b>invalidateChildInParent</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> location<span style=color:#ff79c6>,</span> Rect dirty<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   checkThread<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ç¬¬ä¸€è¡Œå°±ç›´æ¥æ£€æŸ¥çº¿ç¨‹äº†ï¼Œæ‰€ä»¥éç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µä¸‹åªè°ƒç”¨ <code>View#invalidate()</code> ä¾ç„¶ä¼šè§¦å‘çº¿ç¨‹æ£€æŸ¥ã€‚</p><p>åœ¨æŸäº›ç‰¹å®š View çš„ç‰¹å®šæ›´æ–°æ–¹æ³•æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸‹ä¼šåªè°ƒç”¨ <code>View#invalidate()</code>ï¼Œå¦‚æœå¼€å¯äº†ç¡¬ä»¶åŠ é€Ÿå­çº¿ç¨‹æ›´æ–°å°±ä¸ä¼šå´©æºƒï¼Œè¿™ç§æƒ…å†µéœ€è¦ä¸€ä¸€æ¢ç´¢ï¼Œè€Œä¸”å—é™äºç‰ˆæœ¬ä¸åŒå¯èƒ½ä¼šæœ‰ä¸åŒçš„ç»“æœï¼Œä»…ä»…ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p><h4 id=imageviewsetimagedrawablecolordrawablecolorred><code>imageView.setImageDrawable(ColorDrawable(Color.RED))</code></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.widget.ImageView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setImageDrawable</span><span style=color:#ff79c6>(</span>@Nullable Drawable drawable<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDrawable <span style=color:#ff79c6>!=</span> drawable<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> oldWidth <span style=color:#ff79c6>=</span> mDrawableWidth<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> oldHeight <span style=color:#ff79c6>=</span> mDrawableHeight<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      updateDrawable<span style=color:#ff79c6>(</span>drawable<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldWidth <span style=color:#ff79c6>!=</span> mDrawableWidth <span style=color:#ff79c6>||</span> oldHeight <span style=color:#ff79c6>!=</span> mDrawableHeight<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¦‚æœä¸ä¿®æ”¹ Drawable çš„å›ºæœ‰å®½é«˜ä¸å˜å°±ä¸ä¼šè°ƒç”¨ <code>requestLayout()</code>ã€‚<code>mDrawableWidth</code> å’Œ <code>mDrawableHeight</code> çš„æ”¹å˜åœ¨ <code>updateDrawable()</code>ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span> <span style=color:#6272a4>// android.widget.ImageView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>updateDrawable</span><span style=color:#ff79c6>(</span>Drawable d<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>d <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>       <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>       mDrawableWidth <span style=color:#ff79c6>=</span> d<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getIntrinsicWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>       mDrawableHeight <span style=color:#ff79c6>=</span> d<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getIntrinsicHeight</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>       <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>       mDrawableWidth <span style=color:#ff79c6>=</span> mDrawableHeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span> <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span> <span style=color:#6272a4>// android.graphics.drawable.Drawable
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getIntrinsicWidth</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>      <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getIntrinsicHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>      <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ColorDrawable å¹¶æœªé‡å†™ <code>getIntrinsicWidth()</code> å’Œ <code>getIntrinsicHeight()</code>ï¼Œ <code>mDrawableWidth</code> å’Œ <code>mDrawableHeight</code> ä¸€ç›´éƒ½æ˜¯ <code>-1</code>ï¼Œæ‰€ä»¥å¹¶æœªè°ƒç”¨ <code>requestLayout()</code>ã€‚</p><h4 id=textview-åœ¨å›ºå®šå°ºå¯¸ä¸‹æ›´æ–°æ–‡æœ¬>TextView åœ¨å›ºå®šå°ºå¯¸ä¸‹æ›´æ–°æ–‡æœ¬</h4><p><code>TextView#setText()</code> ä¸­ä¼šè°ƒç”¨ <code>TextView#checkForRelayout()</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.widget.TextView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>checkForRelayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>width</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>WRAP_CONTENT</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>         <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>mMaxWidthMode <span style=color:#ff79c6>==</span> mMinWidthMode <span style=color:#ff79c6>&amp;&amp;</span> mMaxWidth <span style=color:#ff79c6>==</span> mMinWidth<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>         <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mHint <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> mHintLayout <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mRight <span style=color:#ff79c6>-</span> mLeft <span style=color:#ff79c6>-</span> getCompoundPaddingLeft<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> getCompoundPaddingRight<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#6272a4>// ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶ä¸ºï¼š
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// TextView çš„å®½åº¦æ˜¯å›ºå®šçš„
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// æ²¡æœ‰è®¾ç½®æç¤ºæ–‡æœ¬ï¼Œæˆ–è€…æç¤ºæ–‡æœ¬å·²ç»è¢«æ¸²æŸ“å®Œæˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// TextView çš„å®½åº¦å¤§äº 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#8be9fd>int</span> oldht <span style=color:#ff79c6>=</span> mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#8be9fd>int</span> want <span style=color:#ff79c6>=</span> mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#8be9fd>int</span> hintWant <span style=color:#ff79c6>=</span> mHintLayout <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>:</span> mHintLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      makeNewLayout<span style=color:#ff79c6>(</span>want<span style=color:#ff79c6>,</span> hintWant<span style=color:#ff79c6>,</span> UNKNOWN_BORING<span style=color:#ff79c6>,</span> UNKNOWN_BORING<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>               mRight <span style=color:#ff79c6>-</span> mLeft <span style=color:#ff79c6>-</span> getCompoundPaddingLeft<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> getCompoundPaddingRight<span style=color:#ff79c6>(),</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>               <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mEllipsize <span style=color:#ff79c6>!=</span> TextUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>TruncateAt</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>MARQUEE</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>         <span style=color:#6272a4>// ä¸æ˜¯è·‘é©¬ç¯æ¨¡å¼
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>         <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>height</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>WRAP_CONTENT</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>               <span style=color:#ff79c6>&amp;&amp;</span> mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>height</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MATCH_PARENT</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#6272a4>// TextView çš„é«˜åº¦æ˜¯å›ºå®šçš„
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>            autoSizeText<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>         <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>         <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> oldht
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>               <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mHintLayout <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> mHintLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> oldht<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#6272a4>// æ²¡æœ‰æ”¹å˜é«˜åº¦
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span>            autoSizeText<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>         <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>      requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>      nullLayouts<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æ»¡è¶³æºç ä¸­æ³¨é‡Šçš„æ¡ä»¶å°±ä¸ä¼šè§¦å‘ <code>View#requestLayout()</code>ã€‚</p><h4 id=surfaceview-å’Œ-textureview>SurfaceView å’Œ TextureView</h4><p>è¿™ä¸¤ä¸ª View æ˜¯æ ¹çº¢è‹—æ­£ç”¨æ¥å­çº¿ç¨‹æ›´æ–° View çš„ï¼ŒSurfaceView ä½¿ç”¨è‡ªå¸¦ Surface å»åšç”»é¢æ¸²æŸ“ï¼ŒTextureView åŒæ ·å¯ä»¥é€šè¿‡ <code>TextureView#lockCanvas()</code> ä½¿ç”¨ä¸´æ—¶çš„ Surfaceï¼Œæ‰€ä»¥éƒ½ä¸ä¼šè§¦å‘ <code>View#requestLayout()</code>ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦ç€çœ¼äºå­çº¿ç¨‹ä¸èƒ½æ›´æ–° UI å’Œèƒ½æ›´æ–° UI çš„åº•å±‚åŸç†ï¼Œäº†è§£äº† Activity View æ ‘çš„æ„å»ºæµç¨‹ã€æ›´æ–° UI çš„åŸºç¡€æµç¨‹ã€‚ä½†æ˜¯æ ¹æ® Android çš„è®¾è®¡ç†å¿µï¼Œè¿˜æ˜¯ä¸åº”ä½¿ç”¨åœ¨å­çº¿ç¨‹ä¸­æ›´æ–° UIï¼Œå®šåˆ¶åŒ–ç³»ç»Ÿå¸¸å¸¸æ›´æ”¹ç‰¹å®šçš„ API å®ç°æ–¹å¼ä¼šç›´æ¥è®©ä¸Šé¢çš„â€œå¥‡æŠ€æ·«å·§â€æˆä¸ºâ€œä¸å®šæ—¶ç‚¸å¼¹â€ã€‚</p><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/0j3l/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>è‡ªå»ºNASæ–¹æ¡ˆé€‰å‹-ç¡¬ä»¶ç¯‡</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/hq29/>ä½¿ç”¨é˜¿é‡Œäº‘æ•ˆåŒæ­¥ Git ä»“åº“åˆ° Github<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#å­çº¿ç¨‹æ›´æ–°-ui-å¼‚å¸¸è®¾è®¡ç†å¿µåŠç®€å•æºç è§£æ>å­çº¿ç¨‹æ›´æ–° UI å¼‚å¸¸è®¾è®¡ç†å¿µåŠç®€å•æºç è§£æ</a></li><li><a href=#æ·±å…¥æºç è¿½è¸ª>æ·±å…¥æºç è¿½è¸ª</a><ul><li><a href=#activity-çš„é¡¶å±‚-view>Activity çš„é¡¶å±‚ View</a></li><li><a href=#decorview-çš„-viewparent>DecorView çš„ ViewParent</a></li><li><a href=#viewrootimpl-çš„-requestlayout>ViewRootImpl çš„ requestLayout</a></li></ul></li><li><a href=#å­çº¿ç¨‹æ›´æ–°-view-ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µ>å­çº¿ç¨‹æ›´æ–° View ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µ</a><ul><li><a href=#é’ˆå¯¹é€šç”¨-view-çš„æ–¹æ¡ˆ>é’ˆå¯¹é€šç”¨ View çš„æ–¹æ¡ˆ</a></li><li><a href=#é’ˆå¯¹ç‰¹å®š-view-çš„æ–¹æ¡ˆ>é’ˆå¯¹ç‰¹å®š View çš„æ–¹æ¡ˆ</a></li></ul></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>