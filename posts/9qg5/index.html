<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>🧑‍💻</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>子线程更新 UI 全解</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>归档</a></li><li><a href=https://blog.io01.xyz/about>关于</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>子线程更新 UI 全解</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2022-01-06</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/android/ class="text-gray-500 mr-1">Android</a>
<a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">源码</a></div></div></div></header><h2 id=子线程更新-ui-异常设计理念及简单源码解析>子线程更新 UI 异常设计理念及简单源码解析</h2><p>初学者可能会犯在子线程更新 UI 的错误，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span></code></pre></div><p>一旦运行，应用会直接崩溃并抛出异常，这也是我们 Android 开发的一条铁律：<em>在子线程中不能更新 UI</em>。</p><p>那么为什么 Android 不让子线程更新 UI 呢？原因在于现在屏幕刷新率最低是 60Hz，意味着最多每 16ms 就会刷新一次屏幕，所以 UI 更新要尽可能快速，否则会丢帧导致卡顿。那么 UI 更新操作就不能加锁，频繁的加锁释放锁可能会延长 UI 渲染时间，但是不加锁如果允许子线程更新 UI 会导致多个线程对 UI 同时更新，造成线程不安全而导致 UI 最终效果无法想象，所以 Android 直接限制了子线程更新 UI，实际上不只是 Android 有这种限制，常见的 UI 框架基本都是单线程模型。</p><p>了解了设计理念，我们从源码的角度来分析一下，本文 Framework 源码均来自 Android 11 版本。</p><p>首先我们先从 Log 的角度分析，错误日志是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl$CalledFromWrongThreadException</span><span style=color:#ff79c6>:</span> Only the original thread that created a view hierarchy can touch its views<span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>checkThread</span><span style=color:#ff79c6>(</span>ViewRootImpl<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>8798</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>(</span>ViewRootImpl<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>1606</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>View</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>25390</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   at android<span style=color:#ff79c6>.</span><span style=color:#50fa7b>view</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>View</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>setBackgroundColor</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>java</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9>23617</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>可以看到从<code>View#setBackgroundColor()</code>起层层调用之后会到达<code>ViewRootImpl#checkThread()</code>，然后抛出了异常，<code>ViewRootImpl#checkThread()</code> 方法是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>checkThreadcheckThread</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mThread <span style=color:#ff79c6>!=</span> Thread<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentThread</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> CalledFromWrongThreadException<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>               <span style=color:#f1fa8c>&#34;Only the original thread that created a view hierarchy can touch its views.&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>仅有一个功能：判断当前线程跟 <code>mThread</code> 是否一致，如果不一致就抛出异常。继而可以看到 <code>mThread</code> 是在 <code>ViewRootImpl</code> 构造方法中被初始化的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ViewRootImpl</span><span style=color:#ff79c6>(</span>Context context<span style=color:#ff79c6>,</span> Display display<span style=color:#ff79c6>,</span> IWindowSession session<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>      <span style=color:#8be9fd>boolean</span> useSfChoreographer<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   mThread <span style=color:#ff79c6>=</span> Thread<span style=color:#ff79c6>.</span><span style=color:#50fa7b>currentThread</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>所以原因很清楚了：当前调用的线程不是 <code>ViewRootImpl</code> 的构造方法中初始化的线程就会抛出异常。但是这仅仅知其然，想要知其所以然还得继续深入源码进行分析。</p><h2 id=深入源码追踪>深入源码追踪</h2><p>从 <code>imageView.setBackgroundColor()</code> 开始，根据调用链可以得到对 <code>View#requestLayout()</code> 的调用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#setBackgroundDrawable
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>requestLayout<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>那么重点看一下 <code>View#requestLayout()</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mMeasureCache <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> mMeasureCache<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#6272a4>// 如果 View 树正在 Layout 流程时有 View 调用 requestLayout()，则将此 View 加入到 ViewRootImpl 的队列中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAttachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#6272a4>// Only trigger request-during-layout logic if this is the view requesting it,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// not the views in its parent hierarchy
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>      ViewRootImpl viewRoot <span style=color:#ff79c6>=</span> getViewRootImpl<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>viewRoot <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> viewRoot<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isInLayout</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>viewRoot<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayoutDuringLayout</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>               <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>   mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>   mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_INVALIDATED<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>   <span style=color:#6272a4>// 如果当前 View 存在 ViewParent，且 isLayoutRequested() 为 false 则调用 ViewParent 的 requestLayout()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAttachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      mAttachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mViewRequestingLayout</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>View 的 <code>requestLayout()</code> 会调用其父布局的 <code>requestLayout()</code>，ViewGrop 并没有重写这个方法，所以还是调用的 View 的 <code>requestLayout()</code>，即一直递归到最上层。所以我们看一下最上层的 View 是什么。</p><h3 id=activity-的顶层-view>Activity 的顶层 View</h3><p>首先我们先从 <code>onCreate()</code> 中的 <code>setContentView()</code> 方法看我们创建的布局的父 View 是谁（为了分析简单，我们的 Activity 继承自 <code>android.app.Activity</code>，而非 <code>androidx.appcompat.app.AppCompatActivity</code>）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.app.Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span>@LayoutRes <span style=color:#8be9fd>int</span> layoutResID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   getWindow<span style=color:#ff79c6>().</span><span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span>layoutResID<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   initWindowDecorActionBar<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>getWindow()</code>得到的是 <code>attach()</code>中创建的 <code>PhoneWindow</code> 对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.app.Activity#attach
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mWindow <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> PhoneWindow<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> window<span style=color:#ff79c6>,</span> activityConfigCallback<span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>所以去 <code>PhoneWindow</code> 的 <code>setContentView()</code> 中一探究竟：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setContentView</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> layoutResID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mContentParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      installDecor<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>hasFeature<span style=color:#ff79c6>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mContentParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>removeAllViews</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>hasFeature<span style=color:#ff79c6>(</span>FEATURE_CONTENT_TRANSITIONS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#6272a4>// 共享元素动画相关
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>      <span style=color:#8be9fd;font-style:italic>final</span> Scene newScene <span style=color:#ff79c6>=</span> Scene<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSceneForLayout</span><span style=color:#ff79c6>(</span>mContentParent<span style=color:#ff79c6>,</span> layoutResID<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>               getContext<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      transitionTo<span style=color:#ff79c6>(</span>newScene<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mLayoutInflater<span style=color:#ff79c6>.</span><span style=color:#50fa7b>inflate</span><span style=color:#ff79c6>(</span>layoutResID<span style=color:#ff79c6>,</span> mContentParent<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>我们传入的 <code>layoutResID</code> 通过 <code>mLayoutInflater.inflate(layoutResID, mContentParent)</code> 将 xml 布局加载到 <code>mContentParent</code> 中，那么就要看看 <code>mContentParent</code> 是怎么创建出来的，即<code>installDecor()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>installDecor</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   mForceDecorInstall <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecor <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      mDecor <span style=color:#ff79c6>=</span> generateDecor<span style=color:#ff79c6>(-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setDescendantFocusability</span><span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>FOCUS_AFTER_DESCENDANTS</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIsRootNamespace</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mInvalidatePanelMenuPosted <span style=color:#ff79c6>&amp;&amp;</span> mInvalidatePanelMenuFeatures <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>postOnAnimation</span><span style=color:#ff79c6>(</span>mInvalidatePanelMenuRunnable<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setWindow</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mContentParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mContentParent <span style=color:#ff79c6>=</span> generateLayout<span style=color:#ff79c6>(</span>mDecor<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>首先需要了解 DecorView 是一个 FrameLayout 的子类，上述源码通过 <code>generateDecor()</code> 创建出一个 DecorView 赋值给 <code>mDecor</code>，然后通过 <code>generateLayout()</code> 创建出一个 ViewGroup 赋值给 <code>mContentParent</code>，所以我们重点关注这两个方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>protected</span> DecorView <span style=color:#50fa7b>generateDecor</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> featureId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   Context context<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mUseDecorContext<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      Context applicationContext <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>().</span><span style=color:#50fa7b>getApplicationContext</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>applicationContext <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            context <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            context <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DecorContext<span style=color:#ff79c6>(</span>applicationContext<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mTheme <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>               context<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setTheme</span><span style=color:#ff79c6>(</span>mTheme<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      context <span style=color:#ff79c6>=</span> getContext<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DecorView<span style=color:#ff79c6>(</span>context<span style=color:#ff79c6>,</span> featureId<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> getAttributes<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>处理完 context 之后就直接 new 了一个 DecorView 对象，所以继续看 <code>generateLayout()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>protected</span> ViewGroup <span style=color:#50fa7b>generateLayout</span><span style=color:#ff79c6>(</span>DecorView decor<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#6272a4>// 前面会根据不同的 window feature 使用不同的布局文件，比如 FEATURE_NO_TITLE 就是没有标题栏的布局
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>   mDecor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>onResourcesLoaded</span><span style=color:#ff79c6>(</span>mLayoutInflater<span style=color:#ff79c6>,</span> layoutResource<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   ViewGroup contentParent <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>)</span>findViewById<span style=color:#ff79c6>(</span>ID_ANDROID_CONTENT<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>return</span> contentParent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>假设通过上面 feature 条件判断最后的布局文件是 <code>R.layout.screen_simple</code>，源码为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>&lt;LinearLayout</span> <span style=color:#50fa7b>xmlns:android=</span><span style=color:#f1fa8c>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#50fa7b>android:fitsSystemWindows=</span><span style=color:#f1fa8c>&#34;true&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#50fa7b>android:orientation=</span><span style=color:#f1fa8c>&#34;vertical&#34;</span><span style=color:#ff79c6>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>&lt;ViewStub</span> <span style=color:#50fa7b>android:id=</span><span style=color:#f1fa8c>&#34;@+id/action_mode_bar_stub&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>              <span style=color:#50fa7b>android:inflatedId=</span><span style=color:#f1fa8c>&#34;@+id/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>              <span style=color:#50fa7b>android:layout=</span><span style=color:#f1fa8c>&#34;@layout/action_mode_bar&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>              <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>              <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;wrap_content&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>              <span style=color:#50fa7b>android:theme=</span><span style=color:#f1fa8c>&#34;?attr/actionBarTheme&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>&lt;FrameLayout</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>         <span style=color:#50fa7b>android:id=</span><span style=color:#f1fa8c>&#34;@android:id/content&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>         <span style=color:#50fa7b>android:layout_width=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>         <span style=color:#50fa7b>android:layout_height=</span><span style=color:#f1fa8c>&#34;match_parent&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>         <span style=color:#50fa7b>android:foregroundInsidePadding=</span><span style=color:#f1fa8c>&#34;false&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>         <span style=color:#50fa7b>android:foregroundGravity=</span><span style=color:#f1fa8c>&#34;fill_horizontal|top&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>         <span style=color:#50fa7b>android:foreground=</span><span style=color:#f1fa8c>&#34;?android:attr/windowContentOverlay&#34;</span> <span style=color:#ff79c6>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>&lt;/LinearLayout&gt;</span>
</span></span></code></pre></div><p>可以看到该布局是一个 LinearLayout 布局，包括一个 id 为 <code>action_mode_bar_stub</code> 的 用 ViewStub 引用的 ActionBar，一个 id 为 <code>@android:id/content</code> 的 FrameLayout。</p><p>继续跟踪 <code>onResourcesLoaded()</code> 方法，看看布局文件和 DecorView 的关系：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.policy.PhoneWindow
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onResourcesLoaded</span><span style=color:#ff79c6>(</span>LayoutInflater inflater<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> layoutResource<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> View root <span style=color:#ff79c6>=</span> inflater<span style=color:#ff79c6>.</span><span style=color:#50fa7b>inflate</span><span style=color:#ff79c6>(</span>layoutResource<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecorCaptionView <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDecorCaptionView<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getParent</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            addView<span style=color:#ff79c6>(</span>mDecorCaptionView<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                  <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      mDecorCaptionView<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>               <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MarginLayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#6272a4>// Put it below the color views.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>      addView<span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span><span style=color:#ff79c6>(</span>MATCH_PARENT<span style=color:#ff79c6>,</span> MATCH_PARENT<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   mContentRoot <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ViewGroup<span style=color:#ff79c6>)</span> root<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>   initializeElevation<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到将布局文件加载成 View 然后添加到 DecorView 中。然后继续看 <code>generateLayout()</code> 剩下的代码是 <code>findViewById(ID_ANDROID_CONTENT)</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.Window
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>&lt;</span>T <span style=color:#8be9fd;font-style:italic>extends</span> View<span style=color:#ff79c6>&gt;</span> T <span style=color:#50fa7b>findViewById</span><span style=color:#ff79c6>(</span>@IdRes <span style=color:#8be9fd>int</span> id<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>return</span> getDecorView<span style=color:#ff79c6>().</span><span style=color:#50fa7b>findViewById</span><span style=color:#ff79c6>(</span>id<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>ID_ANDROID_CONTENT</code> 的值是 <code>com.android.internal.R.id.content</code>，这个 id 实际对应的就是上面 xml 文件中的 id 为 <code>@android:id/content</code> 的 FrameLayout，所以 <code>mContentParent</code> 就是那个 LinearLayout 的子 View，至此我们完成了对 Activity 中 View 父布局的完整链路追踪。</p><p>View 递归父布局小结：开发者的 xml 生成的布局 -> mContentParent（FragmentLayout）-> 系统内置布局文件生成的 View（LinearLayout）-> mDecor（DecorView）。</p><h3 id=decorview-的-viewparent>DecorView 的 ViewParent</h3><p>虽然我们已经得到 DecorView 是顶层 View，但是问题没有真正解决：如果 DecorView 没有父 View，最后递归 <code>requestLayout()</code> 岂不是就此终结相当于什么都没干？其实我们一直说递归查找父 <em>View</em> 的说法是不准确的，应该说递归查找 <em>ViewParent</em>，DecorView 虽然没有父 <em>View</em> 了，但是它依然有 <em>ViewParent</em>。但是这个过程不能像上面那样自下而上追溯，而是自上而下先了解了 Activity 生命周期的流程才能得到。</p><p>我们先看看 <code>ActivityThread#handleResumeActivity()</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.internal.app.ActivityThread
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>handleResumeActivity</span><span style=color:#ff79c6>(</span>IBinder token<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> finalStateRequest<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> isForward<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      String reason<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> ActivityClientRecord r <span style=color:#ff79c6>=</span> performResumeActivity<span style=color:#ff79c6>(</span>token<span style=color:#ff79c6>,</span> finalStateRequest<span style=color:#ff79c6>,</span> reason<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> Activity a <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>activity</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#8be9fd>boolean</span> willBeVisible <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mStartedActivity</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mFinished</span> <span style=color:#ff79c6>&amp;&amp;</span> willBeVisible<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span> <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>activity</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWindow</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      View decor <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDecorView</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      decor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setVisibility</span><span style=color:#ff79c6>(</span>View<span style=color:#ff79c6>.</span><span style=color:#50fa7b>INVISIBLE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      ViewManager wm <span style=color:#ff79c6>=</span> a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWindowManager</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      WindowManager<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> l <span style=color:#ff79c6>=</span> r<span style=color:#ff79c6>.</span><span style=color:#50fa7b>window</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAttributes</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mVisibleFromClient</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mWindowAdded</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>               a<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mWindowAdded</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>               wm<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>decor<span style=color:#ff79c6>,</span> l<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这些代码真正需要我们分析的只有一行：<code>wm.addView(decor, l)</code>，这个方法的作用是将 DecorView 添加到 WindowManager 中。找到 WindowManager 的实现类是 <code>WindowManagerImpl</code>，<code>addView</code> 的源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.WindowManagerImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>@NonNull View view<span style=color:#ff79c6>,</span> @NonNull ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> params<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   applyDefaultToken<span style=color:#ff79c6>(</span>params<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   mGlobal<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>,</span> params<span style=color:#ff79c6>,</span> mContext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDisplayNoVerify</span><span style=color:#ff79c6>(),</span> mParentWindow<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            mContext<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getUserId</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>继续追踪 <code>mGlobal.addview()</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.WindowManagerGlobal
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addView</span><span style=color:#ff79c6>(</span>View view<span style=color:#ff79c6>,</span> ViewGroup<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> params<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      Display display<span style=color:#ff79c6>,</span> Window parentWindow<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> userId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   ViewRootImpl root<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   View panelParentView <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#ff79c6>(</span>mLock<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      root <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ViewRootImpl<span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getContext</span><span style=color:#ff79c6>(),</span> display<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setLayoutParams</span><span style=color:#ff79c6>(</span>wparams<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      mViews<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      mRoots<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>root<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      mParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>wparams<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#6272a4>// do this last because it fires off messages to start doing things
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#6272a4></span>      <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            root<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setView</span><span style=color:#ff79c6>(</span>view<span style=color:#ff79c6>,</span> wparams<span style=color:#ff79c6>,</span> panelParentView<span style=color:#ff79c6>,</span> userId<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>RuntimeException e<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#6272a4>// BadTokenException or InvalidDisplayException, clean up.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>index <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>               removeViewLocked<span style=color:#ff79c6>(</span>index<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#ff79c6>throw</span> e<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到实例化了一个 ViewRootImpl 对象，并且将 DecorView 传入了 <code>setView()</code> 中，那么继续追踪：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setView</span><span style=color:#ff79c6>(</span>View view<span style=color:#ff79c6>,</span> WindowManager<span style=color:#ff79c6>.</span><span style=color:#50fa7b>LayoutParams</span> attrs<span style=color:#ff79c6>,</span> View panelParentView<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>      <span style=color:#8be9fd>int</span> userId<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mView <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         view<span style=color:#ff79c6>.</span><span style=color:#50fa7b>assignParent</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这个方法非常长，但是我们只是为了追踪 DecorView 的 ViewParent，所以只需要追踪一行 <code>view.assignParent(this)</code>，DecorView 没有重写，一直追踪到 View 的该方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>assignParent</span><span style=color:#ff79c6>(</span>ViewParent parent<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      mParent <span style=color:#ff79c6>=</span> parent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>parent <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      mParent <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RuntimeException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;view &#34;</span> <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>this</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; being added, but&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>               <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; it already has a parent&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>所以问题解决，DecorView 的 ViewParent 是 ViewRootImpl。</p><h3 id=viewrootimpl-的-requestlayout>ViewRootImpl 的 requestLayout</h3><p>终于可以回归正题，看看 ViewRootImpl 的 <code>requestLayout()</code> 做了些什么：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mHandlingLayoutInLayoutRequest<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      checkThread<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      mLayoutRequested <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>      scheduleTraversals<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>终于看到了我们熟悉的 <code>checkThread()</code>，回归到最初简要分析时的结论了：当前调用的线程不是 ViewRootImpl 的构造方法中初始化的线程就会抛出异常。</p><p>那么 ViewRootImpl 初始化的方法在什么线程呢，<code>ActivityThread#handleResumeActivity()</code> 导致了 ViewRootImpl 的初始化，又因为 ActivityThread 所在线程是主线程，所以 ViewRootImpl 初始化的方法在主线程。</p><p>其实通过深入源码分析得到的链路很清晰：</p><ol><li><p>子线程更新 View 会调用 <code>View#requestLayout()</code>，然后开始递归查找父 View，找到了 Activity 的顶层 View 是 DecorView。</p></li><li><p>DecorView 的 ViewParent 是 ViewRootImpl，所以调用了 <code>ViewRootImpl#requestLayout()</code>，继而调用了 <code>ViewRootImpl#checkThread()</code>。</p></li><li><p>ViewRootImpl 在主线程初始化，因此子线程调用检查线程会抛出异常。</p></li></ol><h2 id=子线程更新-view-不发生异常的情况>子线程更新 View 不发生异常的情况</h2><p>知道了子线程更新 View 发生异常的原因，自然就会想是否有子线程不发生异常的情况。</p><h3 id=针对通用-view-的方案>针对通用 View 的方案</h3><p>根据 <code>View#requestLayout()</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#requestLayout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>两个条件：<code>mParent != null</code> 和 <code>mParent.isLayoutRequested() == false</code> 都满足才会调用 <code>mParent.requestLayout()</code>，所以可以想办法打破这两个条件。</p><h4 id=在-activityonresume-及以前更新-view>在 <code>Activity#onResume()</code> 及以前更新 View</h4><p>有一条关联 Activity 生命周期的调用链是：<code>ActivityThread#handleResumeActivity()</code> -> <code>ActivityThread#performResumeActivity()</code> -> <code>Activity#performResume()</code> -> <code>Instrumentation#callActivityOnResume()</code> -> <code>Activity#onResume()</code>，因为篇幅和主题原因，不多赘述。</p><p>由调用链可知 ViewRootImpl 在 <code>Activity#onResume()</code> 之后初始化，所以如果在此之前调用 <code>View#requestLayout()</code> 递归到 DecorView 时不满足 <code>mParent != null</code> 而不会调用到 <code>ViewRootImpl#requestLayout()</code>。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.demo.MainActivity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   setContentView(<span style=color:#50fa7b>R</span>.layout.activity_main)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div><h4 id=在子线程更新-view-之前先-requestlayout>在子线程更新 View 之前先 requestLayout</h4><p>首先根据 <code>View#isLayoutRequested()</code> 的源码可得与 <code>mPrivateFlags</code> 是否存在 <code>PFLAG_FORCE_LAYOUT</code> 有关：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>而根据 <code>View#requestLayout()</code> 的源码，可得第一层请求时就会在 <code>mPrivateFlags</code> 加入 <code>PFLAG_FORCE_LAYOUT</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#requestLayout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>mPrivateFlags <span style=color:#ff79c6>|=</span> PFLAG_INVALIDATED<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isLayoutRequested</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>requestLayout</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>那么是什么时候 <code>mPrivateFlags</code> 去掉 <code>PFLAG_FORCE_LAYOUT</code> 呢？是在 <code>View#layout()</code> 里：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.View#layout
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>mPrivateFlags <span style=color:#ff79c6>&amp;=</span> <span style=color:#ff79c6>~</span>PFLAG_FORCE_LAYOUT<span style=color:#ff79c6>;</span>
</span></span></code></pre></div><p>具体的 View 布局流程因为篇幅原因简单概述不做深入源码追踪了：</p><p><code>ViewRootImpl#requestLayout()</code> -> <code>ViewRootImpl#scheduleTraversals()</code> 会最终调用到 <code>ViewRootImpl#performTraversals()</code>，但并不是直接调用的，而是通过 Choreographer 等到下一个 VSYNC 时才调用，<code>ViewRootImpl#performTraversals()</code> -> <code>ViewRootImpl#performLayout()</code> -> <code>View#layout()</code>，所以 <code>mParent.isLayoutRequested()</code> 在下一个 VSYNC 时才会被赋值为 <code>false</code>，无法影响到马上执行的子线程更新 View。</p><p>因此我们可以先主线程调用一次<code>requestLayout()</code>，马上调用子线程更新 View 就不会发生异常了。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.demo.MainActivity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>override</span> <span style=color:#ff79c6>fun</span> <span style=color:#50fa7b>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   setContentView(<span style=color:#50fa7b>R</span>.layout.activity_main)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   imageView.setOnClickListener {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>      imageView.requestLayout()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>      thread { imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h4 id=子线程初始化-viewrootimpl>子线程初始化 ViewRootImpl</h4><p>本质上不是子线程不能更新 UI，而是<em>非构造 ViewRootImpl 线程</em>不能更新 UI，所以子线程构造 ViewRootImpl，线程检查时就不会报错了。ViewRootImpl 初始化在 <code>WindowManagerGlobal#addView()</code> 中，外部能访问到的是 WindowManagerGlobal 是 WindowManager 的代理类，外部通过 <code>WindowManager#addView()</code> 去调用即可。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.demo.MainActivity#onCreate
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>button.setOnClickListener {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   thread {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>         <span style=color:#50fa7b>Looper</span>.prepare()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>         <span style=color:#ff79c6>val</span> imageView = ImageView(<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         windowManager.addView(imageView, <span style=color:#50fa7b>WindowManager</span>.LayoutParams())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         imageView.setBackgroundColor(<span style=color:#50fa7b>Color</span>.RED)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#50fa7b>Looper</span>.loop()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>注意要在 <code>Looper.prepare()</code> 之后调用 <code>WindowManager#addView()</code>，否则会报错：<code>java.lang.RuntimeException: Can't create handler inside thread Thread[xxxx] that has not called Looper.prepare()</code>。</p><p>原因是 ViewRootImpl 初始化的时候会创建一个 Headler，Headler 初始化的时候会从 ThreadLocal 中获取 Looper，获取不到就会抛出异常， <code>Looper.prepare()</code> 就是构造个 Looper 放进 ThreadLocal 中。</p><h3 id=针对特定-view-的方案>针对特定 View 的方案</h3><p>更新 View 一般会调用两个方法：<code>View#requestLayout()</code> 和 <code>View#invalidate()</code>，如果只调用后者我们可以跟踪一下源码看看会发生什么：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.View
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidate</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>boolean</span> invalidateCache<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   invalidateInternal<span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> mRight <span style=color:#ff79c6>-</span> mLeft<span style=color:#ff79c6>,</span> mBottom <span style=color:#ff79c6>-</span> mTop<span style=color:#ff79c6>,</span> invalidateCache<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidateInternal</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> l<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> t<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> r<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> b<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> invalidateCache<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#8be9fd>boolean</span> fullInvalidate<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>(</span>PFLAG_DRAWN <span style=color:#ff79c6>|</span> PFLAG_HAS_BOUNDS<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>(</span>PFLAG_DRAWN <span style=color:#ff79c6>|</span> PFLAG_HAS_BOUNDS<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>invalidateCache <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_DRAWING_CACHE_VALID<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> PFLAG_DRAWING_CACHE_VALID<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>mPrivateFlags <span style=color:#ff79c6>&amp;</span> PFLAG_INVALIDATED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> PFLAG_INVALIDATED
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>fullInvalidate <span style=color:#ff79c6>&amp;&amp;</span> isOpaque<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> mLastIsOpaque<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> AttachInfo ai <span style=color:#ff79c6>=</span> mAttachInfo<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> ViewParent p <span style=color:#ff79c6>=</span> mParent<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>p <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> ai <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> l <span style=color:#ff79c6>&lt;</span> r <span style=color:#ff79c6>&amp;&amp;</span> t <span style=color:#ff79c6>&lt;</span> b<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#8be9fd;font-style:italic>final</span> Rect damage <span style=color:#ff79c6>=</span> ai<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mTmpInvalRect</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            damage<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span>l<span style=color:#ff79c6>,</span> t<span style=color:#ff79c6>,</span> r<span style=color:#ff79c6>,</span> b<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            p<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invalidateChild</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> damage<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><code>p.invalidateChild(this, damage)</code> 表示使 ViewParent 重绘这个 View，所以跟踪一下 ViewGroup 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewGroup
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidateChild</span><span style=color:#ff79c6>(</span>View child<span style=color:#ff79c6>,</span> <span style=color:#8be9fd;font-style:italic>final</span> Rect dirty<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#8be9fd;font-style:italic>final</span> AttachInfo attachInfo <span style=color:#ff79c6>=</span> mAttachInfo<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>attachInfo <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> attachInfo<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mHardwareAccelerated</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#6272a4>// HW accelerated fast path
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>      onDescendantInvalidated<span style=color:#ff79c6>(</span>child<span style=color:#ff79c6>,</span> child<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>首先就会判断是否开启了硬件加速，如果开启了会进入硬件加速逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewGroup
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span>@NonNull View child<span style=color:#ff79c6>,</span> @NonNull View target<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mParent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      mParent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>,</span> target<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>又是向上递归，我们轻车熟路去找 <code>ViewRootImpl#onDescendantInvalidated()</code> 的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>onDescendantInvalidated</span><span style=color:#ff79c6>(</span>@NonNull View child<span style=color:#ff79c6>,</span> @NonNull View descendant<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>descendant<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mPrivateFlags</span> <span style=color:#ff79c6>&amp;</span> PFLAG_DRAW_ANIMATION<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      mIsAnimating <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>@UnsupportedAppUsage
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invalidate</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   mDirty<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> mWidth<span style=color:#ff79c6>,</span> mHeight<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mWillDrawSoon<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      scheduleTraversals<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到最后跟 <code>ViewRootImpl#requestLayout()</code> 一样调用到了 <code>ViewRootImpl#scheduleTraversals()</code>，但是却没有调用<code>ViewRootImpl#checkThread()</code>。</p><p>所以我们得到了一个结论：在硬件加速的情况下只调用 <code>View#invalidate()</code> 不会触发线程检查。</p><p>那么在非硬件加速的时候呢？还得返回去看看 <code>ViewGroup#invalidateChild()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewGroup#invalidateChild
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>do</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   parent <span style=color:#ff79c6>=</span> parent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>invalidateChildInParent</span><span style=color:#ff79c6>(</span>location<span style=color:#ff79c6>,</span> dirty<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>parent <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>循环调用 <code>ViewParent#invalidateChildInParent()</code>，所以去 <code>ViewRootImpl#invalidateChildInParent()</code> 中一探究竟：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// android.view.ViewRootImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> ViewParent <span style=color:#50fa7b>invalidateChildInParent</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> location<span style=color:#ff79c6>,</span> Rect dirty<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   checkThread<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>第一行就直接检查线程了，所以非硬件加速的情况下只调用 <code>View#invalidate()</code> 依然会触发线程检查。</p><p>在某些特定 View 的特定更新方法满足特定条件下会只调用 <code>View#invalidate()</code>，如果开启了硬件加速子线程更新就不会崩溃，这种情况需要一一探索，而且受限于版本不同可能会有不同的结果，仅仅举几个例子：</p><h4 id=imageviewsetimagedrawablecolordrawablecolorred><code>imageView.setImageDrawable(ColorDrawable(Color.RED))</code></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.widget.ImageView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setImageDrawable</span><span style=color:#ff79c6>(</span>@Nullable Drawable drawable<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mDrawable <span style=color:#ff79c6>!=</span> drawable<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> oldWidth <span style=color:#ff79c6>=</span> mDrawableWidth<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> oldHeight <span style=color:#ff79c6>=</span> mDrawableHeight<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      updateDrawable<span style=color:#ff79c6>(</span>drawable<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>oldWidth <span style=color:#ff79c6>!=</span> mDrawableWidth <span style=color:#ff79c6>||</span> oldHeight <span style=color:#ff79c6>!=</span> mDrawableHeight<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>如果不修改 Drawable 的固有宽高不变就不会调用 <code>requestLayout()</code>。<code>mDrawableWidth</code> 和 <code>mDrawableHeight</code> 的改变在 <code>updateDrawable()</code>中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span> <span style=color:#6272a4>// android.widget.ImageView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>updateDrawable</span><span style=color:#ff79c6>(</span>Drawable d<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>d <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>       <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>       mDrawableWidth <span style=color:#ff79c6>=</span> d<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getIntrinsicWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>       mDrawableHeight <span style=color:#ff79c6>=</span> d<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getIntrinsicHeight</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>       <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>       mDrawableWidth <span style=color:#ff79c6>=</span> mDrawableHeight <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span> <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span> <span style=color:#6272a4>// android.graphics.drawable.Drawable
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span> <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getIntrinsicWidth</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>      <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getIntrinsicHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>      <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ColorDrawable 并未重写 <code>getIntrinsicWidth()</code> 和 <code>getIntrinsicHeight()</code>， <code>mDrawableWidth</code> 和 <code>mDrawableHeight</code> 一直都是 <code>-1</code>，所以并未调用 <code>requestLayout()</code>。</p><h4 id=textview-在固定尺寸下更新文本>TextView 在固定尺寸下更新文本</h4><p><code>TextView#setText()</code> 中会调用 <code>TextView#checkForRelayout()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.widget.TextView
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>checkForRelayout</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>   <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>width</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>WRAP_CONTENT</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>         <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>(</span>mMaxWidthMode <span style=color:#ff79c6>==</span> mMinWidthMode <span style=color:#ff79c6>&amp;&amp;</span> mMaxWidth <span style=color:#ff79c6>==</span> mMinWidth<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>         <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mHint <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> mHintLayout <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mRight <span style=color:#ff79c6>-</span> mLeft <span style=color:#ff79c6>-</span> getCompoundPaddingLeft<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> getCompoundPaddingRight<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#6272a4>// 上述三个条件为：
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// TextView 的宽度是固定的
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// 没有设置提示文本，或者提示文本已经被渲染完成
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// TextView 的宽度大于 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#8be9fd>int</span> oldht <span style=color:#ff79c6>=</span> mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#8be9fd>int</span> want <span style=color:#ff79c6>=</span> mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#8be9fd>int</span> hintWant <span style=color:#ff79c6>=</span> mHintLayout <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>:</span> mHintLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getWidth</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      makeNewLayout<span style=color:#ff79c6>(</span>want<span style=color:#ff79c6>,</span> hintWant<span style=color:#ff79c6>,</span> UNKNOWN_BORING<span style=color:#ff79c6>,</span> UNKNOWN_BORING<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>               mRight <span style=color:#ff79c6>-</span> mLeft <span style=color:#ff79c6>-</span> getCompoundPaddingLeft<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-</span> getCompoundPaddingRight<span style=color:#ff79c6>(),</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>               <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mEllipsize <span style=color:#ff79c6>!=</span> TextUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>TruncateAt</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>MARQUEE</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>         <span style=color:#6272a4>// 不是跑马灯模式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>         <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>height</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>WRAP_CONTENT</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>               <span style=color:#ff79c6>&amp;&amp;</span> mLayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>height</span> <span style=color:#ff79c6>!=</span> LayoutParams<span style=color:#ff79c6>.</span><span style=color:#50fa7b>MATCH_PARENT</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#6272a4>// TextView 的高度是固定的
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#6272a4></span>            autoSizeText<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>         <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>         <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> oldht
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>               <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mHintLayout <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> mHintLayout<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getHeight</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> oldht<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#6272a4>// 没有改变高度
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span>            autoSizeText<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>         <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>      requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>   <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>      nullLayouts<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      requestLayout<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>      invalidate<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>   <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以看到满足源码中注释的条件就不会触发 <code>View#requestLayout()</code>。</p><h4 id=surfaceview-和-textureview>SurfaceView 和 TextureView</h4><p>这两个 View 是根红苗正用来子线程更新 View 的，SurfaceView 使用自带 Surface 去做画面渲染，TextureView 同样可以通过 <code>TextureView#lockCanvas()</code> 使用临时的 Surface，所以都不会触发 <code>View#requestLayout()</code>。</p><h2 id=总结>总结</h2><p>本文主要着眼于子线程不能更新 UI 和能更新 UI 的底层原理，了解了 Activity View 树的构建流程、更新 UI 的基础流程。但是根据 Android 的设计理念，还是不应使用在子线程中更新 UI，定制化系统常常更改特定的 API 实现方式会直接让上面的“奇技淫巧”成为“不定时炸弹”。</p><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/0j3l/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>自建NAS方案选型-硬件篇</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/hq29/>使用阿里云效同步 Git 仓库到 Github<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#子线程更新-ui-异常设计理念及简单源码解析>子线程更新 UI 异常设计理念及简单源码解析</a></li><li><a href=#深入源码追踪>深入源码追踪</a><ul><li><a href=#activity-的顶层-view>Activity 的顶层 View</a></li><li><a href=#decorview-的-viewparent>DecorView 的 ViewParent</a></li><li><a href=#viewrootimpl-的-requestlayout>ViewRootImpl 的 requestLayout</a></li></ul></li><li><a href=#子线程更新-view-不发生异常的情况>子线程更新 View 不发生异常的情况</a><ul><li><a href=#针对通用-view-的方案>针对通用 View 的方案</a></li><li><a href=#针对特定-view-的方案>针对特定 View 的方案</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>