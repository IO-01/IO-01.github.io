<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>ğŸ§‘â€ğŸ’»</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>æ·±å…¥æºç æ’æŸ¥ FLAG_ACTIVITY_NEW_TASK å¯¼è‡´çš„ Activity æ— æ³•æ­£å¸¸å¯åŠ¨</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>å½’æ¡£</a></li><li><a href=https://blog.io01.xyz/about>å…³äº</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>æ·±å…¥æºç æ’æŸ¥ FLAG_ACTIVITY_NEW_TASK å¯¼è‡´çš„ Activity æ— æ³•æ­£å¸¸å¯åŠ¨</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2021-09-16</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">æºç </a></div></div></div></header><h2 id=å¼•è¨€>å¼•è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥ Android ä¸­ Activity æœ‰å››ç§å¯åŠ¨æ¨¡å¼ï¼Œå†³å®šäº†æ˜¯å¦åˆ›å»ºæ–°çš„ Activity å®ä¾‹æˆ–å¤ç”¨å½“å‰å®ä¾‹ã€‚ä½†æ˜¯å®é™…ä¸Š Activity çš„å¯åŠ¨ååˆ†å¤æ‚ï¼Œä¸å•å•æ˜¯ <code>android:launchMode</code> å°±èƒ½å†³å®šçš„ï¼Œå¤šä¸ª Intent Flag éƒ½èƒ½æ”¹å˜å¯åŠ¨çš„è¡Œä¸ºæ¨¡å¼ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜ä¼šæ ¹æ® <code>android:taskAffinity</code> çš„å€¼æ¥åˆ¤æ–­å¯¹åº”ä»»åŠ¡æ ˆæ˜¯å¦å­˜åœ¨ã€‚</p><h3 id=åŸºæœ¬-launchmode-è¡Œä¸ºæ¨¡å¼>åŸºæœ¬ LaunchMode è¡Œä¸ºæ¨¡å¼</h3><p>é¦–å…ˆå¤ä¹ ä¸€ä¸‹æœ€åŸºæœ¬çš„ LaunchMode è¡Œä¸ºæ¨¡å¼ï¼š</p><ul><li><p>standardï¼šé»˜è®¤å€¼ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Activity å®ä¾‹ã€‚</p></li><li><p>singleTopï¼šå¦‚æœå¾…å¯åŠ¨ Activity å¤„äºæ ˆé¡¶åˆ™é‡ç”¨å®ä¾‹å›è°ƒå…¶ <code>onNewIntent()</code> æ–¹æ³•ï¼Œå¦åˆ™æ–°å»ºå®ä¾‹ã€‚</p></li><li><p>singleTaskï¼šå¦‚æœå·²æœ‰ä»»åŠ¡æ ˆä¸­å­˜åœ¨è¯¥ Activity å®ä¾‹ï¼Œåˆ™å°†å®ä¾‹ä¹‹ä¸Šçš„å…¶ä»– Activity æ¸…ç©ºå¹¶å›è°ƒå®ä¾‹çš„ <code>onNewIntent()</code> æ–¹æ³•ï¼Œå¦åˆ™æ–°å»ºæ ˆåˆ›å»º Activity å®ä¾‹ã€‚</p></li><li><p>singleInstanceï¼šåœ¨å•ç‹¬ä¸€ä¸ªæ ˆä¸­åˆ›å»ºï¼Œè¯¥æ ˆä¸ä¼šå†åˆ›å»ºå…¶ä»– Activityï¼Œå½“ç³»ç»Ÿä¸­å­˜åœ¨å®ä¾‹æ—¶å›è°ƒå®ä¾‹çš„ <code>onNewIntent()</code> æ–¹æ³•ã€‚</p></li></ul><p>è¿™æ˜¯æˆ‘ä»¬æœ€ç†ŸçŸ¥çš„å¯åŠ¨æ¨¡å¼ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸Šè¿°è¡Œä¸ºæ¨¡å¼ä»…é™äºæœªæ·»åŠ ä»»ä½• Flagï¼Œå¹¶ä¸”æ²¡æœ‰æ”¹å˜ taskAffinity çš„å‰æä¸‹ã€‚</p><h3 id=service-å¯åŠ¨-activity>Service å¯åŠ¨ Activity</h3><p>å¦‚å‰æ‰€è¿°ï¼Œå¦‚æœå•çº¯çš„ Activity å¯åŠ¨ Activiy ä¸”ä¸æ·»åŠ ä»»ä½• Flag æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨ Service å¯åŠ¨ Activity å°±ä¼šé‡åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼Œåœ¨ Frameworkï¼ˆæœ¬æ–‡ Framework æºç å‡æ¥è‡ª Android 11 ç‰ˆæœ¬ï¼‰çš„æºç ä¸­ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.app.ContextImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>@Override
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>startActivity</span><span style=color:#ff79c6>(</span>Intent intent<span style=color:#ff79c6>,</span> Bundle options<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>intent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFlags</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&amp;</span> Intent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>FLAG_ACTIVITY_NEW_TASK</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>targetSdkVersion <span style=color:#ff79c6>&lt;</span> Build<span style=color:#ff79c6>.</span><span style=color:#50fa7b>VERSION_CODES</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>N</span> <span style=color:#ff79c6>||</span> targetSdkVersion <span style=color:#ff79c6>&gt;=</span> Build<span style=color:#ff79c6>.</span><span style=color:#50fa7b>VERSION_CODES</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>P</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>options <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> ActivityOptions<span style=color:#ff79c6>.</span><span style=color:#50fa7b>fromBundle</span><span style=color:#ff79c6>(</span>options<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getLaunchTaskId</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> AndroidRuntimeException<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                <span style=color:#f1fa8c>&#34;Calling startActivity() from outside of an Activity &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; context requires the FLAG_ACTIVITY_NEW_TASK flag.&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; Is this really what you want?&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æ‰€ä»¥åœ¨ Service ä¸­å¯åŠ¨ Activity å¿…é¡»æ·»åŠ  <code>FLAG_ACTIVITY_NEW_TASK</code>ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ¯ä¸ª Activity å¯åŠ¨éƒ½éœ€è¦ä¸€ä¸ªä»»åŠ¡æ ˆï¼Œé Activity çš„ context å­˜åœ¨åå°å¯åŠ¨çš„å¯èƒ½ï¼Œè€Œæ­¤æ—¶å‰å°æ˜¯å…¶ä»– App çš„ä»»åŠ¡æ ˆï¼Œç”šè‡³æˆ‘ä»¬çš„ App æ ¹æœ¬æ²¡æœ‰åˆ›å»ºè¿‡ä»»åŠ¡æ ˆï¼Œä¸ºäº†é˜²æ­¢è¿™äº›æ— æ³•é¢„æ–™çš„æƒ…å†µå‡ºç°ï¼Œè¢«å¼ºåˆ¶è¦æ±‚æ·»åŠ è¿™ä¸ª Flagã€‚</p><p><code>standard</code> æ˜¯å››ç§å¯åŠ¨æ¨¡å¼ä¸­æœ€ç®€å•ä¹Ÿæœ€å¸¸è§çš„ï¼Œå…¶ä»–ä¸‰ç§å„æœ‰å„çš„æµç¨‹ï¼Œå”¯ç‹¬ <code>standard</code> ç›´æ¥ç®€å•ç²—æš´åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹æ”¾åˆ°æ ˆé¡¶ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ˜¯å¦æ‰€æœ‰çš„ <code>standard</code> éƒ½èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹å‘¢ï¼Ÿ</p><h2 id=æ— æ³•å¯åŠ¨çš„-standard-activity>æ— æ³•å¯åŠ¨çš„ <code>standard</code> Activity</h2><h3 id=å¤ç°æµç¨‹>å¤ç°æµç¨‹</h3><p>å°†æ‰€æœ‰ä¸å½±å“å¼‚å¸¸çš„ä¸šåŠ¡ä»£ç åˆ é™¤ä¹‹åå¾—åˆ°çš„æœ€ç²¾ç®€å¤ç°æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>Service é™„åŠ  <code>FLAG_ACTIVITY_NEW_TASK</code> å¯åŠ¨ A_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity å¯åŠ¨ B_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>Service é™„åŠ  <code>FLAG_ACTIVITY_NEW_TASK</code> å¯åŠ¨ A_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li></ol><p>ä¼šå‘ç° A_Activity æ— æ³•è¢«å¯åŠ¨ï¼ŒA_Activity å’Œ B_Activity å‡æœªå›è°ƒ <code>onCreate</code>ã€<code>onResume</code> æˆ–è€… <code>onNewIntent</code> ç­‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½• Crash æˆ–è€… ANR çš„æ—¥å¿—å‘ç”Ÿï¼Œç‚¹å‡» B_Activity å¯ä»¥æ­£å¸¸æ“ä½œã€‚</p><h3 id=åŸå› æ¨æµ‹>åŸå› æ¨æµ‹</h3><p>é¦–å…ˆæ’é™¤ Service çš„ Context çš„åŸå› ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹æµç¨‹ï¼Œå®éªŒä¼šå‘ç° A_Activity ä¾ç„¶æ— æ³•å¯åŠ¨ï¼š</p><ol><li><p>MainActivity ä¸­å…ˆ <code>finish</code> åé™„åŠ  <code>FLAG_ACTIVITY_NEW_TASK</code> å¯åŠ¨ A_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>finish()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity å¯åŠ¨ B_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>B_Activity é™„åŠ  <code>FLAG_ACTIVITY_NEW_TASK</code> å¯åŠ¨ A_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li></ol><p>é‚£ä¹ˆä»ä½¿ç”¨æ’é™¤æ³•å¾—åˆ° <code>FLAG_ACTIVITY_NEW_TASK</code> æœ‰å¯èƒ½æ˜¯åŸå› äº†ã€‚å¦å¤–ç»†å¿ƒè§‚å¯Ÿä¸Šé¢çš„æ­¥éª¤ï¼Œä¼šå‘ç°ç¬¬ä¸€æ­¥å…ˆ <code>finish</code> å† <code>startActivity</code>ï¼Œå¦‚æœå»æ‰ <code>finish</code> åšå®éªŒä¼šå‘ç°å…¶å®å¯ä»¥æˆåŠŸå¯åŠ¨ A_Activityï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªåŸå› åº”è¯¥å°±æ˜¯ <code>finish</code> äº†ã€‚</p><h3 id=æºç è¿½è¸ª>æºç è¿½è¸ª</h3><h4 id=startactivityinner>startActivityInner</h4><p>Framework çš„ Activity å¯åŠ¨æºç éå¸¸ç¹æ‚ï¼Œä½†æ˜¯çœŸæ­£å¯¹ Activity æ ˆè¿›è¡Œæ“ä½œçš„å‡½æ•°æ˜¯ <code>ActivityStarter#startActivityInner</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ç€é‡åˆ†æè¿™ä¸ªæ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>startActivityInner</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord r<span style=color:#ff79c6>,</span> ActivityRecord sourceRecord<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        IVoiceInteractionSession voiceSession<span style=color:#ff79c6>,</span> IVoiceInteractor voiceInteractor<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#8be9fd>int</span> startFlags<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> doResume<span style=color:#ff79c6>,</span> ActivityOptions options<span style=color:#ff79c6>,</span> Task inTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#8be9fd>boolean</span> restrictedBgActivity<span style=color:#ff79c6>,</span> NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    setInitialState<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> options<span style=color:#ff79c6>,</span> inTask<span style=color:#ff79c6>,</span> doResume<span style=color:#ff79c6>,</span> startFlags<span style=color:#ff79c6>,</span> sourceRecord<span style=color:#ff79c6>,</span> voiceSession<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            voiceInteractor<span style=color:#ff79c6>,</span> restrictedBgActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#6272a4>// è®¡ç®— Activity çš„å¯åŠ¨ Flag
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    computeLaunchingTaskFlags<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>// ç¡®å®šæ˜¯å¦å°†æ–° Activity æ’å…¥ç°æœ‰ä»»åŠ¡æ ˆä¸­ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›å¯¹åº”çš„ ActivityRecordï¼Œå¦åˆ™è¿”å› null
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd;font-style:italic>final</span> Task reusedTask <span style=color:#ff79c6>=</span> getReusableTask<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#6272a4>// è®¡ç®—æ˜¯å¦å­˜åœ¨å¯ç”¨çš„ä»»åŠ¡æ ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd;font-style:italic>final</span> Task targetTask <span style=color:#ff79c6>=</span> reusedTask <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> reusedTask <span style=color:#ff79c6>:</span> computeTargetTask<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>boolean</span> newTask <span style=color:#ff79c6>=</span> targetTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    mTargetTask <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    computeLaunchParams<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> sourceRecord<span style=color:#ff79c6>,</span> targetTask<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#6272a4>// æ£€æŸ¥æ˜¯å¦å…è®¸åœ¨ç»™å®šä»»åŠ¡æ ˆæˆ–è€…æ–°æ ˆä¸Šå¯åŠ¨ Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span> startResult <span style=color:#ff79c6>=</span> isAllowedToStart<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> newTask<span style=color:#ff79c6>,</span> targetTask<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord targetTaskTop <span style=color:#ff79c6>=</span> newTask <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>:</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#6272a4>// ä¸ºäº†è¿™æ¬¡å¯åŠ¨å›æ”¶ç›®æ ‡ä»»åŠ¡æ ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4></span>        startResult <span style=color:#ff79c6>=</span> recycleTask<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> targetTaskTop<span style=color:#ff79c6>,</span> reusedTask<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>ç”±äº <code>startActivityInner</code> æ–¹æ³•ä¾ç„¶æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥å°†åªçœ‹å‡ ä¸ªå¯èƒ½äº§ç”Ÿå½±å“çš„åœ°æ–¹ï¼Œå¯¹ä»»åŠ¡æ ˆæœ‰å½±å“çš„å…³é”®æ–¹æ³•æ˜¯ <code>getReusableTask</code> å’Œ <code>recycleTask</code>ã€‚</p><h4 id=getreusabletask>getReusableTask</h4><p>é¦–å…ˆå…ˆçœ‹çœ‹ <code>getReusableTask</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> Task <span style=color:#50fa7b>getReusableTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#6272a4>// æ–° Activity æ”¾åˆ°ç°æœ‰ä»»åŠ¡æ ˆä¸­çš„æ¡ä»¶ï¼š
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 1. Flags åŒ…å« FLAG_ACTIVITY_NEW_TASK ä½†æ˜¯ä¸åŒ…å« FLAG_ACTIVITY_MULTIPLE_TASK
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 2. launchMode æ˜¯ singleInstance æˆ– singleTask
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>boolean</span> putIntoExistingTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_MULTIPLE_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>||</span> isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    putIntoExistingTask <span style=color:#ff79c6>&amp;=</span> mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resultTo</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ActivityRecord intentActivity <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>putIntoExistingTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#6272a4>// singleInstance ç›¸å…³
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span> mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivity</span><span style=color:#ff79c6>(</span>mIntent<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isActivityTypeHome</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#6272a4>// åˆ†å±ç›¸å…³
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span> mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivity</span><span style=color:#ff79c6>(</span>mIntent<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                    <span style=color:#ff79c6>!(</span>LAUNCH_SINGLE_TASK <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#6272a4>// é™¤ä¸Šè¿°æƒ…å†µä¹‹å¤–çš„æƒ…å†µå¯»æ‰¾æœ€åˆé€‚çš„ä»»åŠ¡æ ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                    mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findTask</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span> mPreferredTaskDisplayArea<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>return</span> intentActivity <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> intentActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æ ¹æ®ä¸Šè¿°æºç ï¼Œç”±äºæˆ‘ä»¬çš„ Flags ä¸­åŒ…å« <code>FLAG_ACTIVITY_NEW_TASK</code> ä½†æ˜¯ä¸åŒ…å« <code>FLAG_ACTIVITY_MULTIPLE_TASK</code>ï¼Œæ‰€ä»¥ä¼šä»ç°æœ‰çš„ä»»åŠ¡æ ˆä¸­å¯»æ‰¾ä¸€ä¸ªæœ€åˆé€‚çš„ä»»åŠ¡æ ˆå¹¶å°†å¾…å¯åŠ¨çš„ Activity æ’å…¥å…¶ä¸­ï¼Œåœ¨æˆ‘ä»¬ä¸¾çš„ä¾‹å­ä¸­ï¼Œä¼šè·å–åˆ° B_Activity æ‰€åœ¨çš„ä»»åŠ¡æ ˆã€‚</p><h4 id=recycletask>recycleTask</h4><p>æ¥ç€æ¥çœ‹çœ‹ <code>recycleTask</code> çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>recycleTask</span><span style=color:#ff79c6>(</span>Task targetTask<span style=color:#ff79c6>,</span> ActivityRecord targetTaskTop<span style=color:#ff79c6>,</span> Task reusedTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#6272a4>// ä¸åŒç”¨æˆ·ä¸‹ä¸å›æ”¶ä»»åŠ¡æ ˆï¼Œç›´æ¥å¯åŠ¨ Activity å¹¶æ·»åŠ åˆ°ä»»åŠ¡æ ˆä¸­
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mUserId</span> <span style=color:#ff79c6>!=</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mUserId</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        mTargetStack <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStack</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#6272a4>// ç¬¬ä¸€å¤„ return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_SUCCESS<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    setTargetStackIfNeeded<span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#6272a4>// START_FLAG_ONLY_IF_NEEDED è¡¨ç¤ºå¯åŠ¨å’Œè¢«å¯åŠ¨è€…æ˜¯åŒä¸€ä¸ª
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mStartFlags <span style=color:#ff79c6>&amp;</span> START_FLAG_ONLY_IF_NEEDED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mMovedToFront <span style=color:#ff79c6>&amp;&amp;</span> mDoResume<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>moveToFront</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;intentActivityFound&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        resumeTargetStackIfNeeded<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#6272a4>// ç¬¬äºŒå¤„ return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_RETURN_INTENT_TO_CALLER<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    complyActivityFlags<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            reusedTask <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> reusedTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAddingToTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#6272a4>// ç¬¬ä¸‰å¤„ return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_SUCCESS<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    resumeTargetStackIfNeeded<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    mLastStartActivityRecord <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>finishing</span> <span style=color:#ff79c6>?</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> targetTaskTop<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#6272a4>// ç¬¬å››å¤„ return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> mMovedToFront <span style=color:#ff79c6>?</span> START_TASK_TO_FRONT <span style=color:#ff79c6>:</span> START_DELIVERED_TO_TOP<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>æ ¹æ®å•æ­¥è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>recycleTask</code> è¿”å›çš„ç»“æœæ˜¯ <code>START_DELIVERED_TO_TOP</code>ï¼Œåœ¨ <code>startActivityInner</code> ä¸­ <code>recycleTask</code> éƒ¨åˆ†çš„ç›¸å…³ä»£ç æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter#startActivityInner
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>startResult <span style=color:#ff79c6>=</span> recycleTask<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> targetTaskTop<span style=color:#ff79c6>,</span> reusedTask<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å³æ ¹æœ¬æ²¡æœ‰è¿è¡Œ <code>startActivityInner</code> ååŠéƒ¨åˆ†ä»£ç ï¼Œå¯åŠ¨å¤±è´¥åŸå› å°±åœ¨äºæ­¤ï¼Œå› æ­¤ä¸å†é€ä¸€è§£æ <code>recycleTask</code>ï¼Œè€Œæ˜¯ç€çœ¼äºä¸ºä½•æ²¡æœ‰è¿”å› <code>START_SUCCESS</code>ï¼Œå¯ä»¥é€ä¸€å¯»æ‰¾ <code>recycleTask</code> ä¸­æ‰€æœ‰ <code>return</code> çš„åœ°æ–¹ï¼š</p><ol><li>åŒä¸€ç”¨æˆ·ç¯å¢ƒä¸‹ï¼Œå› æ­¤ä¸ä¼šè¿”å› <code>START_SUCCESS</code></li><li><code>START_FLAG_ONLY_IF_NEEDED</code> è¡¨ç¤ºå¯åŠ¨å’Œè¢«å¯åŠ¨è€…æ˜¯åŒä¸€ä¸ª Activityï¼Œå› æ­¤ä¸ä¼šè¿”å› <code>START_RETURN_INTENT_TO_CALLER</code></li><li>æ ¹æ® <code>mAddingToTask</code> æ˜¯å¦ä¸º <code>true</code> æ¥ç¡®å®šæ˜¯å¦è¿”å› <code>START_SUCCESS</code>ï¼Œå…³è”æ–¹æ³•æ˜¯ <code>complyActivityFlags</code>ï¼Œæ­¤å¤„éœ€è¦åˆ†æä¸€ä¸‹ä¸ºä½• <code>mAddingToTask</code> ä¸º <code>false</code></li><li>æ ¹æ® <code>mMovedToFront</code> åˆ¤æ–­è¿”å›ä¸º <code>START_TASK_TO_FRONT</code> è¿˜æ˜¯ <code>START_DELIVERED_TO_TOP</code>ï¼Œå…³è”çš„æ–¹æ³•æ˜¯ <code>setTargetStackIfNeeded</code>ï¼Œç”±äºä¸Šä¸€æ­¥å·²ç»æ–­ç»äº†è¿”å› <code>START_SUCCESS</code> çš„å¯èƒ½ï¼Œæ— æ³•æ­£å¸¸åˆ›å»ºä¸€ä¸ª Activity å®ä¾‹äº†ï¼Œå°±ä¸å†åˆ†ææ­¤æ–¹æ³•ã€‚</li></ol><h4 id=complyactivityflags>complyActivityFlags</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>complyActivityFlags</span><span style=color:#ff79c6>(</span>Task targetTask<span style=color:#ff79c6>,</span> ActivityRecord reusedActivity<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ActivityRecord targetTaskTop <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>boolean</span> resetTask <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            reusedActivity <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>resetTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        targetTaskTop <span style=color:#ff79c6>=</span> mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resetTaskIfNeeded</span><span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>(</span>FLAG_ACTIVITY_NEW_TASK <span style=color:#ff79c6>|</span> FLAG_ACTIVITY_CLEAR_TASK<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>(</span>FLAG_ACTIVITY_NEW_TASK <span style=color:#ff79c6>|</span> FLAG_ACTIVITY_CLEAR_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#6272a4>// å¦‚æœè®¾ç½®äº† FLAG_ACTIVITY_NEW_TASK å’Œ FLAG_ACTIVITY_CLEAR_TASK
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// æ¸…é™¤ç›®æ ‡ä»»åŠ¡æ ˆä¸Šæ‰€æœ‰çš„ Activityï¼Œå¹¶å°†å¾…å¯åŠ¨ Activity çš„ intent ä¿¡æ¯è®¾ç½®ç»™ç›®æ ‡ä»»åŠ¡æ ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>performClearTaskLocked</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>||</span> isDocumentLaunchesIntoExisting<span style=color:#ff79c6>(</span>mLaunchFlags<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#ff79c6>||</span> isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#6272a4>// å¦‚æœè®¾ç½®äº† FLAG_ACTIVITY_CLEAR_TOPï¼›android:documentLaunchModeï¼ˆæœ€è¿‘ä»»åŠ¡åˆ—è¡¨ç›¸å…³å±æ€§ï¼‰çš„å€¼æ˜¯ intoExistingï¼Œä»£è¡¨ Activity é‡å¤ä½¿ç”¨æ–‡æ¡£çš„ç°æœ‰ä»»åŠ¡ï¼›launchMode æ˜¯ singleInstance æˆ– singleTask
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// æ¸…é™¤å¾…å¯åŠ¨ Activity åœ¨ä»»åŠ¡æ ˆä¹‹ä¸Šçš„æ‰€æœ‰ Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord top <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>performClearTaskForReuseLocked</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                mLaunchFlags<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addChild</span><span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>top <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>top<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isRootOfTask</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                top<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>top<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStack</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                mTargetStack <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>                        getLaunchStack<span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span> mLaunchFlags<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span> <span style=color:#6272a4>/* task */</span><span style=color:#ff79c6>,</span> mOptions<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addChild</span><span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>!</span>mLaunchTaskBehind <span style=color:#6272a4>/* toTop */</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                        <span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>flags</span> <span style=color:#ff79c6>&amp;</span> FLAG_SHOW_FOR_ALL_USERS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mAddingToTask
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_REORDER_TO_FRONT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        <span style=color:#6272a4>// å¦‚æœè®¾ç½®äº† FLAG_ACTIVITY_REORDER_TO_FRONTã€æ²¡æœ‰è®¾ç½® FLAG_ACTIVITY_CLEAR_TOP ä¸”å¾…å¯åŠ¨ Activity å·²ç»åœ¨è¿è¡Œä¸­
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// å°†å¾…å¯åŠ¨ Activity æåˆ°æ ˆé¡¶å¹¶å›è°ƒ onNewIntent
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord act <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivityInHistory</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>act <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>            <span style=color:#8be9fd;font-style:italic>final</span> Task task <span style=color:#ff79c6>=</span> act<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>            task<span style=color:#ff79c6>.</span><span style=color:#50fa7b>moveActivityToFrontLocked</span><span style=color:#ff79c6>(</span>act<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>            act<span style=color:#ff79c6>.</span><span style=color:#50fa7b>updateOptionsLocked</span><span style=color:#ff79c6>(</span>mOptions<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>act<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>            mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mLastPausedActivity</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>realActivity</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        <span style=color:#6272a4>// å¾…å¯åŠ¨ Activity çš„å®Œæ•´ç»„ä»¶åå¦‚æœå’Œç›®æ ‡æ ˆå¯åŠ¨æ ˆçš„ Activity ç›¸åŒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask <span style=color:#ff79c6>==</span> mInTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#6272a4>// ç›®æ ‡ä»»åŠ¡æ ˆå’ŒæŒ‡å®šä»»åŠ¡æ ˆç›¸åŒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// ä¸æ–°å»º Activity å®ä¾‹
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_SINGLE_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                        <span style=color:#ff79c6>||</span> LAUNCH_SINGLE_TOP <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                <span style=color:#ff79c6>&amp;&amp;</span> targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>                <span style=color:#ff79c6>&amp;&amp;</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resultTo</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>            <span style=color:#6272a4>// singleTop æ¨¡å¼ä¸‹
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// å›è°ƒ onNewIntent
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isRootOfTask</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isSameIntentFilter</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>            <span style=color:#6272a4>// ç›®æ ‡ä»»åŠ¡æ ˆå’Œå¾…å¯åŠ¨ Activity çš„ Intent Filter ä¸åŒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// æ–°å»º Activity å®ä¾‹
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span><span style=color:#6272a4></span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>reusedActivity <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>            <span style=color:#6272a4>// æ²¡ç”¨å¤ç”¨çš„ Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// æ–°å»º Activity å®ä¾‹
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#6272a4></span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>resetTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>        <span style=color:#6272a4>// ä¸€èˆ¬ä»å¿«æ·å›¾æ ‡æˆ–é€šçŸ¥ä¸­å¯åŠ¨
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// éœ€è¦æ·»åŠ æ–°çš„ Activity åˆ° Task æœ€ä¸Šé¢
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span><span style=color:#6272a4></span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rootWasReset</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span>        <span style=color:#6272a4>// å¸Œæœ›æŠŠå¾…å¯åŠ¨ Activity æ”¾åˆ°ç›®æ ‡ä»»åŠ¡æ ˆåº•éƒ¨ï¼Œä½†æ˜¯ç°åœ¨çš„ä»£ç ç»“æ„åšä¸åˆ°ï¼ŒåªæŠŠå¾…å¯åŠ¨ Activity çš„ Intent è®¾ç½®ç»™ç›®æ ‡ä»»åŠ¡æ ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span><span style=color:#6272a4></span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>å½“æˆ‘ä»¬å•æ­¥è°ƒè¯•è¿› <code>complyActivityFlags</code> ä¼šå‘ç°ï¼Œåªè®¾ç½®äº† <code>FLAG_ACTIVITY_NEW_TASK</code>ï¼Œæ²¡æœ‰è®¾ç½® <code>FLAG_ACTIVITY_CLEAR_TASK</code>ã€<code>FLAG_ACTIVITY_CLEAR_TOP</code>ã€<code>FLAG_ACTIVITY_REORDER_TO_FRONT</code>ï¼›å¯åŠ¨æ¨¡å¼æ˜¯ <code>standard</code>ï¼›è™½ç„¶å¾…å¯åŠ¨ Activity çš„å®Œæ•´ç»„ä»¶åå¦‚æœå’Œç›®æ ‡æ ˆå¯åŠ¨æ ˆçš„ Activity ç›¸åŒï¼Œä½†æ˜¯å´åˆä¸ç¬¦åˆä¸‹é¢çš„æ‰€æœ‰åˆ¤æ–­ï¼›è™½ç„¶å¯ä»¥è¿›å…¥ <code>!resetTask</code> çš„åˆ†æ”¯å´è¢«ä¸Šä¸€ä¸ªåˆ†æ”¯æˆªèƒ¡â€¦â€¦æ€»ä¹‹å®Œç¾é¿è¿‡äº†æ‰€æœ‰èƒ½æ­£å¸¸å¯åŠ¨çš„ caseã€‚</p><h4 id=resumetopactivityinnerlocked>resumeTopActivityInnerLocked</h4><p>é‚£ä¹ˆä¸èƒ½åˆ›å»ºæ–°çš„ Activity å®ä¾‹ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Œè¿™å°±éœ€è¦å…³æ³¨ <code>recycleTask</code> ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼š<code>resumeTargetStackIfNeeded</code>ï¼Œä½äº <code>complyActivityFlags</code> ä¹‹åï¼Œç”¨äºå°†ç›®æ ‡è¿”å›æ ˆæ ˆé¡¶çš„ Activity å›è°ƒ <code>onResume</code> æ–¹æ³•ï¼Œå³è™½ç„¶æ²¡æœ‰å¯åŠ¨ A_Activityï¼Œä½†æ˜¯æŠŠ B_Activity ç»™é‡æ–°å¯è§äº†ã€‚ç”±äºè°ƒç”¨é“¾è·¯è¿‡é•¿ä¸å¤šåˆ†æï¼Œä½†æ˜¯å±‚å±‚è°ƒç”¨åæœ‰ä¸€ç‚¹éœ€è¦å…³æ³¨ï¼Œåœ¨ <code>ActivityStack#resumeTopActivityInnerLocked</code> ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStack#resumeTopActivityInnerLocked
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mResumedActivity <span style=color:#ff79c6>==</span> next <span style=color:#ff79c6>&amp;&amp;</span> next<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isState</span><span style=color:#ff79c6>(</span>RESUMED<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>&amp;&amp;</span> taskDisplayArea<span style=color:#ff79c6>.</span><span style=color:#50fa7b>allResumedActivitiesComplete</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    executeAppTransition<span style=color:#ff79c6>(</span>options<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>DEBUG_STATES<span style=color:#ff79c6>)</span> Slog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>d</span><span style=color:#ff79c6>(</span>TAG_STATES<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            <span style=color:#f1fa8c>&#34;resumeTopActivityLocked: Top activity resumed &#34;</span> <span style=color:#ff79c6>+</span> next<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>B_Activity æœ¬èº«å°±æ˜¯ <code>RESUMED</code> çŠ¶æ€ï¼Œæ‰€ä»¥ä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œä¸å†ç»§ç»­ <code>resumeTopActivityInnerLocked</code> åé¢çš„å›è°ƒ <code>onResume</code> é€»è¾‘ç›´æ¥è¿”å›ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä½• B_Activity æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸå˜åŒ–ã€‚</p><h3 id=åŸå› æ€»ç»“>åŸå› æ€»ç»“</h3><p>æˆ‘ä»¬åŸå› æ¨æµ‹æ—¶çŒœæƒ³ <code>FLAG_ACTIVITY_NEW_TASK</code> å¯ä»¥å¾—åˆ°è¯å®ï¼Œé‚£ä¹ˆçŒœæƒ³ MainActivity çš„ <code>finish</code> æ˜¯åœ¨å“ªé‡Œé€ æˆå½±å“çš„å‘¢ï¼Ÿå…¶å®æ˜¯ <code>complyActivityFlags</code> çš„åˆ†æ”¯é¡ºåºï¼Œå¦‚æœä¸ finishï¼Œç›®æ ‡ä»»åŠ¡æ ˆå¯åŠ¨æ ˆçš„ Activity æ˜¯ MainActivityï¼Œè·Ÿ A_Activity ä¸åŒåï¼Œæ‰€ä»¥ä¼šè¿›å…¥ <code>!resetTask</code> åˆ†æ”¯ï¼Œä½†æ˜¯å¦‚æœ finish æ‰ MainActivityï¼Œç›®æ ‡ä»»åŠ¡æ ˆå¯åŠ¨æ ˆçš„ Activity å°±æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨çš„ A_Activityï¼Œä¼šè¢«æˆªèƒ¡è€Œæ— æ³•è¿›å…¥ <code>!resetTask</code> åˆ†æ”¯ã€‚</p><p>ç®€å•æ€»ç»“ä¸€ä¸‹å°±æ˜¯å› ä¸ºå¯åŠ¨ Flagï¼Œå¯åŠ¨æ¨¡å¼ï¼Œç°æœ‰æ ˆçš„æƒ…å†µç§ç§æœºç¼˜å·§åˆï¼Œè®©åˆ†æ”¯é€ä¸€è½ç©ºå¯¼è‡´æ²¡æœ‰ä»»ä½• Activity è¢«å¯åŠ¨ï¼Œæ—¢ä¸ä¼šå›è°ƒ <code>onNewIntent</code> ä¹Ÿä¸ä¼šæ–°å»ºä¸€ä¸ª Activity å®ä¾‹ã€‚åŸæœ¬ä¼šå°†ç›®æ ‡è¿”å›æ ˆæ ˆé¡¶çš„ Activityï¼ˆå³ B_Activityï¼‰é‡æ–° resumeï¼Œä½†æ˜¯å·§åˆçš„æ˜¯ B_Activity æœ¬æ¥å°±æ˜¯ <code>RESUMED</code> çŠ¶æ€ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ä¼šå›è°ƒ B_Activity çš„ <code>onResume</code>ã€‚ç§ç§å·§åˆä¹‹ä¸‹çš„ç»“æœå°±æ˜¯çœ‹ä¸Šå»ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿï¼Œæ–°å¯åŠ¨çš„ Activity æ²¡æœ‰å¯åŠ¨ï¼Œä¸Šä¸€ä¸ª Activity çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><h3 id=è§£å†³åŠæ³•>è§£å†³åŠæ³•</h3><p>æ¢³ç†æ¸…æ¥šäº†æµç¨‹è§£å†³æ–¹æ¡ˆå°±å¾ˆç®€å•äº†ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æœ‰èƒ½æ‰“ç ´è¿™ç§å¥‡è‘© case çš„å¯èƒ½ï¼Œè®© <code>startActivityInner</code> æ­£å¸¸è¿›è¡Œåé¢çš„é€»è¾‘å¤„ç†ï¼Œä»…åˆ—ä¸¾å‡ ä¸ªç®€å•çš„æ–¹æ³•ï¼Œæ ¹æ®è‡ªèº«çš„ä¸šåŠ¡è‡ªè¡Œå¤„ç†ï¼š</p><ul><li><p>ä½¿å¾— <code>getReusableTask</code> ä¸­ <code>putIntoExistingTask</code> ä¸º <code>false</code>ï¼šæ¯”å¦‚è®¾ç½®ç¬¬äºŒæ¬¡å¯åŠ¨ A_Activity çš„ Flag ä¸º <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_MULTIPLE_TASK</code>ï¼›æˆ–è€…å¦‚æœåœ¨å…è®¸çš„æ¡ä»¶ä¸‹ï¼ˆæ¯”å¦‚ä¸æ˜¯å¤ç°æµç¨‹æ—¶çš„ Service ä¸­å¯åŠ¨ï¼‰ï¼Œç›´æ¥å»æ‰ <code>FLAG_ACTIVITY_NEW_TASK</code> å³å¯ã€‚</p></li><li><p>åªè¦è®© <code>complyActivityFlags</code> èƒ½è¿›å…¥ <code>mAddingToTask</code> ä¸º <code>true</code> çš„ case ï¼Œè¿™é‡Œåˆ†æ”¯éå¸¸å¤šï¼Œæ‰€ä»¥æ–¹æ¡ˆä¹Ÿæ›´å¤šï¼šæ¯”å¦‚è®¾ç½®ç¬¬äºŒæ¬¡å¯åŠ¨ A_Activity çš„ Flag ä¸º <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK</code>ï¼›æˆ–è€…å°±åƒå‰é¢åˆ†æ <code>finish</code> çš„å½±å“ï¼Œæ³¨æ„æ ˆçš„æƒ…å†µä¸è¦ä½¿å¾—å¯åŠ¨æ ˆçš„ Activity å’Œå¾…å¯åŠ¨çš„ Activity ç›¸åŒã€‚</p></li></ul><h2 id=å†ç°å¼‚å¸¸>å†ç°å¼‚å¸¸</h2><h3 id=å¤ç°æµç¨‹-1>å¤ç°æµç¨‹</h3><p>æ ¹æ®æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ol><li><p>Service é™„åŠ  <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK</code> å¯åŠ¨ A_Activityï¼ŒA_Activity çš„ launchMode ä¸º <code>singleInstance</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK or <span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_CLEAR_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity å¯åŠ¨ B_Activityï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>åŒæ­¥éª¤ 1 å¯åŠ¨ A_Activityã€‚</p></li><li><p>åŒæ­¥éª¤ 2 å¯åŠ¨ B_Activityã€‚</p></li></ol><p>æ­¤æ—¶ä¼šå‡ºç° B_Activity æ²¡æœ‰æ–°å»ºå®ä¾‹ï¼Œè€Œæ˜¯ä¼šå›è°ƒ <code>onRestart</code> å¯åŠ¨äº†ç¬¬ä¸€æ¬¡åˆ›å»ºçš„ B_Activityã€‚</p><h3 id=æºç è¿½è¸ª-1>æºç è¿½è¸ª</h3><p>æ ¹æ®ä¸Šé¢çš„åˆ†ææˆ‘ä»¬è½»è½¦ç†Ÿè·¯äº†ï¼Œè¿™åˆæ˜¯æŸäº› case ä¸‹æ²¡æœ‰åˆ›å»º B_Activity çš„å®ä¾‹è€Œç›´æ¥å›è°ƒçš„ <code>onResume</code> å¯¼è‡´çš„ã€‚ä½†æ˜¯ä¹‹å‰æ— æ³•å¯åŠ¨ A_Activity æ˜¯å› ä¸ºæ·»åŠ äº† <code>FLAG_ACTIVITY_NEW_TASK</code>ï¼Œç„¶è€Œç°åœ¨å¯åŠ¨ B_Activity å¯ä»€ä¹ˆ Flag éƒ½æ²¡åŠ ï¼Œå°±æ˜¯æœ€ç®€å•çš„ <code>startActivity</code>ï¼ŒB_Activity çš„ launchMode ä¹Ÿæ˜¯æœ€åŸºæœ¬çš„ <code>standard</code>ã€‚</p><p>å…¶å®åŸå› ä¾ç„¶éšè—åœ¨æºç ä¸­ï¼Œ<code>startActivityInner</code> ä¼šè°ƒç”¨ <code>computeLaunchingTaskFlags</code> æ¥è®¡ç®—å¯åŠ¨æ—¶çš„ Flagï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>computeLaunchingTaskFlags</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    â€¦â€¦
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mSourceRecord <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                Slog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>w</span><span style=color:#ff79c6>(</span>TAG<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;startActivity called from non-Activity context; forcing &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                        <span style=color:#f1fa8c>&#34;Intent.FLAG_ACTIVITY_NEW_TASK for: &#34;</span> <span style=color:#ff79c6>+</span> mIntent<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mSourceRecord<span style=color:#ff79c6>.</span><span style=color:#50fa7b>launchMode</span> <span style=color:#ff79c6>==</span> LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>åœ¨ä¸æŒ‡å®šå¯åŠ¨æ ˆæ—¶ï¼Œä¸‰ç§æƒ…å†µä¸‹ç³»ç»Ÿä¼šé»˜è®¤ç»™ Flag åŠ ä¸Š <code>FLAG_ACTIVITY_NEW_TASK</code>:</p><ol><li>æ²¡æœ‰æº Activityï¼ˆæ¯”å¦‚ A å¯åŠ¨ Bï¼Œåˆ™ A ä¸ºæº Activityï¼‰</li><li>æº Activity çš„ launchMode æ˜¯ <code>singleInstance</code></li><li>å¾…å¯åŠ¨ Activity çš„ launchMode æ˜¯ <code>singleInstance</code> æˆ– <code>singleTask</code></li></ol><p>åŸå› å°±æ˜¾è€Œæ˜“è§äº†ï¼Œæˆ‘ä»¬çš„ A_Activity çš„ launchMode æ˜¯ <code>singleInstance</code>ï¼Œæ‰€ä»¥ç³»ç»Ÿç»™ Flag åŠ ä¸Šäº† <code>FLAG_ACTIVITY_NEW_TASK</code>ï¼Œäºæ˜¯åˆå›åˆ°äº†ä¹‹å‰åˆ†æçš„åœºæ™¯ä¸­ã€‚</p><h3 id=è§£å†³åŠæ³•-1>è§£å†³åŠæ³•</h3><p>è§£å†³åŠæ³•ä¸Šä¸€ä¸ªåœºæ™¯ä¸­ä¹Ÿç»™å‡ºäº†ï¼Œå¯åŠ¨ B_Activity æ—¶åŠ ä¸Š <code>FLAG_ACTIVITY_MULTIPLE_TASK</code>å³å¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        .apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_MULTIPLE_TASK) })
</span></span></code></pre></div><h2 id=æ€»ç»“>æ€»ç»“</h2><p>Activity å¯åŠ¨è¿™å—æ˜¯éå¸¸å¤æ‚çš„ï¼Œå½±å“çš„å› ç´ ä¹Ÿéå¸¸å¤šï¼Œä¸Šé¢çš„ä¸¤ä¸ªåœºæ™¯è¿˜æ˜¯å±äºæ¯”è¾ƒç®€å•çš„ï¼Œä»…ä»…æ˜¯ <code>FLAG_ACTIVITY_NEW_TASK</code> å°±é€ æˆäº†è¿™ä¹ˆå¤šçš„é—®é¢˜ï¼Œè€Œä¸”çœ‹èµ·éƒ½éå¸¸è¯¡å¼‚éš¾ä»¥æ’æŸ¥ï¼Œæ›´ä¸ç”¨è¯´å„ç§å¯åŠ¨æ¨¡å¼å’Œ Flag å åŠ æ—¶å¯èƒ½ä¼šé‡åˆ°æ›´å¤šçš„å‘ç‚¹ï¼Œä¸è¿‡ä¸€æ—¦é‡åˆ°äº†è¿™äº›ç¥å‘ï¼Œå…¶å®æ·±å…¥æºç å»ç ”ç©¶æœ‰æ—¶å€™åè€Œèƒ½æ›´å¿«å¾—åˆ°ç»“è®ºã€‚</p><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/hq29/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>ä½¿ç”¨é˜¿é‡Œäº‘æ•ˆåŒæ­¥ Git ä»“åº“åˆ° Github</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/2aa2/>éµå¾ª Google åº”ç”¨æŒ‡å—çš„ Retrofit + Coroutine å°è£…<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#å¼•è¨€>å¼•è¨€</a><ul><li><a href=#åŸºæœ¬-launchmode-è¡Œä¸ºæ¨¡å¼>åŸºæœ¬ LaunchMode è¡Œä¸ºæ¨¡å¼</a></li><li><a href=#service-å¯åŠ¨-activity>Service å¯åŠ¨ Activity</a></li></ul></li><li><a href=#æ— æ³•å¯åŠ¨çš„-standard-activity>æ— æ³•å¯åŠ¨çš„ <code>standard</code> Activity</a><ul><li><a href=#å¤ç°æµç¨‹>å¤ç°æµç¨‹</a></li><li><a href=#åŸå› æ¨æµ‹>åŸå› æ¨æµ‹</a></li><li><a href=#æºç è¿½è¸ª>æºç è¿½è¸ª</a></li><li><a href=#åŸå› æ€»ç»“>åŸå› æ€»ç»“</a></li><li><a href=#è§£å†³åŠæ³•>è§£å†³åŠæ³•</a></li></ul></li><li><a href=#å†ç°å¼‚å¸¸>å†ç°å¼‚å¸¸</a><ul><li><a href=#å¤ç°æµç¨‹-1>å¤ç°æµç¨‹</a></li><li><a href=#æºç è¿½è¸ª-1>æºç è¿½è¸ª</a></li><li><a href=#è§£å†³åŠæ³•-1>è§£å†³åŠæ³•</a></li></ul></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>