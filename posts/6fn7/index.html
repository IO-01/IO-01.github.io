<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>🧑‍💻</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>深入源码排查 FLAG_ACTIVITY_NEW_TASK 导致的 Activity 无法正常启动</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>归档</a></li><li><a href=https://blog.io01.xyz/about>关于</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>深入源码排查 FLAG_ACTIVITY_NEW_TASK 导致的 Activity 无法正常启动</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2021-09-16</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">源码</a></div></div></div></header><h2 id=引言>引言</h2><p>众所周知 Android 中 Activity 有四种启动模式，决定了是否创建新的 Activity 实例或复用当前实例。但是实际上 Activity 的启动十分复杂，不单单是 <code>android:launchMode</code> 就能决定的，多个 Intent Flag 都能改变启动的行为模式，除此之外还会根据 <code>android:taskAffinity</code> 的值来判断对应任务栈是否存在。</p><h3 id=基本-launchmode-行为模式>基本 LaunchMode 行为模式</h3><p>首先复习一下最基本的 LaunchMode 行为模式：</p><ul><li><p>standard：默认值，每次启动都会创建一个新的 Activity 实例。</p></li><li><p>singleTop：如果待启动 Activity 处于栈顶则重用实例回调其 <code>onNewIntent()</code> 方法，否则新建实例。</p></li><li><p>singleTask：如果已有任务栈中存在该 Activity 实例，则将实例之上的其他 Activity 清空并回调实例的 <code>onNewIntent()</code> 方法，否则新建栈创建 Activity 实例。</p></li><li><p>singleInstance：在单独一个栈中创建，该栈不会再创建其他 Activity，当系统中存在实例时回调实例的 <code>onNewIntent()</code> 方法。</p></li></ul><p>这是我们最熟知的启动模式，但是需要注意的是：上述行为模式仅限于未添加任何 Flag，并且没有改变 taskAffinity 的前提下。</p><h3 id=service-启动-activity>Service 启动 Activity</h3><p>如前所述，如果单纯的 Activity 启动 Activiy 且不添加任何 Flag 是没问题的，但是如果我们使用 Service 启动 Activity 就会遇到一个异常，在 Framework（本文 Framework 源码均来自 Android 11 版本）的源码中会抛出异常：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// android.app.ContextImpl
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>@Override
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>startActivity</span><span style=color:#ff79c6>(</span>Intent intent<span style=color:#ff79c6>,</span> Bundle options<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>intent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getFlags</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>&amp;</span> Intent<span style=color:#ff79c6>.</span><span style=color:#50fa7b>FLAG_ACTIVITY_NEW_TASK</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>targetSdkVersion <span style=color:#ff79c6>&lt;</span> Build<span style=color:#ff79c6>.</span><span style=color:#50fa7b>VERSION_CODES</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>N</span> <span style=color:#ff79c6>||</span> targetSdkVersion <span style=color:#ff79c6>&gt;=</span> Build<span style=color:#ff79c6>.</span><span style=color:#50fa7b>VERSION_CODES</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>P</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>options <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> ActivityOptions<span style=color:#ff79c6>.</span><span style=color:#50fa7b>fromBundle</span><span style=color:#ff79c6>(</span>options<span style=color:#ff79c6>).</span><span style=color:#50fa7b>getLaunchTaskId</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> AndroidRuntimeException<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                <span style=color:#f1fa8c>&#34;Calling startActivity() from outside of an Activity &#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; context requires the FLAG_ACTIVITY_NEW_TASK flag.&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                        <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34; Is this really what you want?&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>所以在 Service 中启动 Activity 必须添加 <code>FLAG_ACTIVITY_NEW_TASK</code>，原因也很简单，每个 Activity 启动都需要一个任务栈，非 Activity 的 context 存在后台启动的可能，而此时前台是其他 App 的任务栈，甚至我们的 App 根本没有创建过任务栈，为了防止这些无法预料的情况出现，被强制要求添加这个 Flag。</p><p><code>standard</code> 是四种启动模式中最简单也最常见的，其他三种各有各的流程，唯独 <code>standard</code> 直接简单粗暴创建一个新的实例放到栈顶。那么问题来了，是否所有的 <code>standard</code> 都能创建一个新的实例呢？</p><h2 id=无法启动的-standard-activity>无法启动的 <code>standard</code> Activity</h2><h3 id=复现流程>复现流程</h3><p>将所有不影响异常的业务代码删除之后得到的最精简复现流程如下：</p><ol><li><p>Service 附加 <code>FLAG_ACTIVITY_NEW_TASK</code> 启动 A_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity 启动 B_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>Service 附加 <code>FLAG_ACTIVITY_NEW_TASK</code> 启动 A_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li></ol><p>会发现 A_Activity 无法被启动，A_Activity 和 B_Activity 均未回调 <code>onCreate</code>、<code>onResume</code> 或者 <code>onNewIntent</code> 等生命周期函数，也没有任何 Crash 或者 ANR 的日志发生，点击 B_Activity 可以正常操作。</p><h3 id=原因推测>原因推测</h3><p>首先排除 Service 的 Context 的原因，因为我们可以构造如下流程，实验会发现 A_Activity 依然无法启动：</p><ol><li><p>MainActivity 中先 <code>finish</code> 后附加 <code>FLAG_ACTIVITY_NEW_TASK</code> 启动 A_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>finish()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity 启动 B_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>B_Activity 附加 <code>FLAG_ACTIVITY_NEW_TASK</code> 启动 A_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK) })
</span></span></code></pre></div></li></ol><p>那么从使用排除法得到 <code>FLAG_ACTIVITY_NEW_TASK</code> 有可能是原因了。另外细心观察上面的步骤，会发现第一步先 <code>finish</code> 再 <code>startActivity</code>，如果去掉 <code>finish</code> 做实验会发现其实可以成功启动 A_Activity，那么另一个原因应该就是 <code>finish</code> 了。</p><h3 id=源码追踪>源码追踪</h3><h4 id=startactivityinner>startActivityInner</h4><p>Framework 的 Activity 启动源码非常繁杂，但是真正对 Activity 栈进行操作的函数是 <code>ActivityStarter#startActivityInner</code>，所以我们将着重分析这个方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>startActivityInner</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord r<span style=color:#ff79c6>,</span> ActivityRecord sourceRecord<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        IVoiceInteractionSession voiceSession<span style=color:#ff79c6>,</span> IVoiceInteractor voiceInteractor<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#8be9fd>int</span> startFlags<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> doResume<span style=color:#ff79c6>,</span> ActivityOptions options<span style=color:#ff79c6>,</span> Task inTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#8be9fd>boolean</span> restrictedBgActivity<span style=color:#ff79c6>,</span> NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    setInitialState<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> options<span style=color:#ff79c6>,</span> inTask<span style=color:#ff79c6>,</span> doResume<span style=color:#ff79c6>,</span> startFlags<span style=color:#ff79c6>,</span> sourceRecord<span style=color:#ff79c6>,</span> voiceSession<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            voiceInteractor<span style=color:#ff79c6>,</span> restrictedBgActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#6272a4>// 计算 Activity 的启动 Flag
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    computeLaunchingTaskFlags<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>// 确定是否将新 Activity 插入现有任务栈中，如果是则返回对应的 ActivityRecord，否则返回 null
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd;font-style:italic>final</span> Task reusedTask <span style=color:#ff79c6>=</span> getReusableTask<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#6272a4>// 计算是否存在可用的任务栈
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd;font-style:italic>final</span> Task targetTask <span style=color:#ff79c6>=</span> reusedTask <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> reusedTask <span style=color:#ff79c6>:</span> computeTargetTask<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>boolean</span> newTask <span style=color:#ff79c6>=</span> targetTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    mTargetTask <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    computeLaunchParams<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> sourceRecord<span style=color:#ff79c6>,</span> targetTask<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#6272a4>// 检查是否允许在给定任务栈或者新栈上启动 Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span> startResult <span style=color:#ff79c6>=</span> isAllowedToStart<span style=color:#ff79c6>(</span>r<span style=color:#ff79c6>,</span> newTask<span style=color:#ff79c6>,</span> targetTask<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord targetTaskTop <span style=color:#ff79c6>=</span> newTask <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>:</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#6272a4>// 为了这次启动回收目标任务栈
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4></span>        startResult <span style=color:#ff79c6>=</span> recycleTask<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> targetTaskTop<span style=color:#ff79c6>,</span> reusedTask<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>由于 <code>startActivityInner</code> 方法依然比较长，所以将只看几个可能产生影响的地方，对任务栈有影响的关键方法是 <code>getReusableTask</code> 和 <code>recycleTask</code>。</p><h4 id=getreusabletask>getReusableTask</h4><p>首先先看看 <code>getReusableTask</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> Task <span style=color:#50fa7b>getReusableTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#6272a4>// 新 Activity 放到现有任务栈中的条件：
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 1. Flags 包含 FLAG_ACTIVITY_NEW_TASK 但是不包含 FLAG_ACTIVITY_MULTIPLE_TASK
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 2. launchMode 是 singleInstance 或 singleTask
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>boolean</span> putIntoExistingTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_MULTIPLE_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            <span style=color:#ff79c6>||</span> isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    putIntoExistingTask <span style=color:#ff79c6>&amp;=</span> mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resultTo</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ActivityRecord intentActivity <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>putIntoExistingTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            <span style=color:#6272a4>// singleInstance 相关
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span> mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivity</span><span style=color:#ff79c6>(</span>mIntent<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isActivityTypeHome</span><span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_LAUNCH_ADJACENT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#6272a4>// 分屏相关
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span> mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivity</span><span style=color:#ff79c6>(</span>mIntent<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                    <span style=color:#ff79c6>!(</span>LAUNCH_SINGLE_TASK <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#6272a4>// 除上述情况之外的情况寻找最合适的任务栈
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>            intentActivity <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                    mRootWindowContainer<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findTask</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span> mPreferredTaskDisplayArea<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>return</span> intentActivity <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> intentActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>根据上述源码，由于我们的 Flags 中包含 <code>FLAG_ACTIVITY_NEW_TASK</code> 但是不包含 <code>FLAG_ACTIVITY_MULTIPLE_TASK</code>，所以会从现有的任务栈中寻找一个最合适的任务栈并将待启动的 Activity 插入其中，在我们举的例子中，会获取到 B_Activity 所在的任务栈。</p><h4 id=recycletask>recycleTask</h4><p>接着来看看 <code>recycleTask</code> 的源码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>recycleTask</span><span style=color:#ff79c6>(</span>Task targetTask<span style=color:#ff79c6>,</span> ActivityRecord targetTaskTop<span style=color:#ff79c6>,</span> Task reusedTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#6272a4>// 不同用户下不回收任务栈，直接启动 Activity 并添加到任务栈中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mUserId</span> <span style=color:#ff79c6>!=</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mUserId</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        mTargetStack <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStack</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#6272a4>// 第一处 return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_SUCCESS<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    setTargetStackIfNeeded<span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#6272a4>// START_FLAG_ONLY_IF_NEEDED 表示启动和被启动者是同一个
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mStartFlags <span style=color:#ff79c6>&amp;</span> START_FLAG_ONLY_IF_NEEDED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>mMovedToFront <span style=color:#ff79c6>&amp;&amp;</span> mDoResume<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>moveToFront</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;intentActivityFound&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        resumeTargetStackIfNeeded<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#6272a4>// 第二处 return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_RETURN_INTENT_TO_CALLER<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    complyActivityFlags<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            reusedTask <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> reusedTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mAddingToTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#6272a4>// 第三处 return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>return</span> START_SUCCESS<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    resumeTargetStackIfNeeded<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    mLastStartActivityRecord <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>finishing</span> <span style=color:#ff79c6>?</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> targetTaskTop<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#6272a4>// 第四处 return
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> mMovedToFront <span style=color:#ff79c6>?</span> START_TASK_TO_FRONT <span style=color:#ff79c6>:</span> START_DELIVERED_TO_TOP<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>根据单步调试，我们可以知道 <code>recycleTask</code> 返回的结果是 <code>START_DELIVERED_TO_TOP</code>，在 <code>startActivityInner</code> 中 <code>recycleTask</code> 部分的相关代码是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter#startActivityInner
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>startResult <span style=color:#ff79c6>=</span> recycleTask<span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> targetTaskTop<span style=color:#ff79c6>,</span> reusedTask<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>startResult <span style=color:#ff79c6>!=</span> START_SUCCESS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>return</span> startResult<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>即根本没有运行 <code>startActivityInner</code> 后半部分代码，启动失败原因就在于此，因此不再逐一解析 <code>recycleTask</code>，而是着眼于为何没有返回 <code>START_SUCCESS</code>，可以逐一寻找 <code>recycleTask</code> 中所有 <code>return</code> 的地方：</p><ol><li>同一用户环境下，因此不会返回 <code>START_SUCCESS</code></li><li><code>START_FLAG_ONLY_IF_NEEDED</code> 表示启动和被启动者是同一个 Activity，因此不会返回 <code>START_RETURN_INTENT_TO_CALLER</code></li><li>根据 <code>mAddingToTask</code> 是否为 <code>true</code> 来确定是否返回 <code>START_SUCCESS</code>，关联方法是 <code>complyActivityFlags</code>，此处需要分析一下为何 <code>mAddingToTask</code> 为 <code>false</code></li><li>根据 <code>mMovedToFront</code> 判断返回为 <code>START_TASK_TO_FRONT</code> 还是 <code>START_DELIVERED_TO_TOP</code>，关联的方法是 <code>setTargetStackIfNeeded</code>，由于上一步已经断绝了返回 <code>START_SUCCESS</code> 的可能，无法正常创建一个 Activity 实例了，就不再分析此方法。</li></ol><h4 id=complyactivityflags>complyActivityFlags</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>complyActivityFlags</span><span style=color:#ff79c6>(</span>Task targetTask<span style=color:#ff79c6>,</span> ActivityRecord reusedActivity<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        NeededUriGrants intentGrants<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ActivityRecord targetTaskTop <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTopNonFinishingActivity</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>boolean</span> resetTask <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            reusedActivity <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>resetTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        targetTaskTop <span style=color:#ff79c6>=</span> mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resetTaskIfNeeded</span><span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>,</span> mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> <span style=color:#ff79c6>(</span>FLAG_ACTIVITY_NEW_TASK <span style=color:#ff79c6>|</span> FLAG_ACTIVITY_CLEAR_TASK<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>(</span>FLAG_ACTIVITY_NEW_TASK <span style=color:#ff79c6>|</span> FLAG_ACTIVITY_CLEAR_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#6272a4>// 如果设置了 FLAG_ACTIVITY_NEW_TASK 和 FLAG_ACTIVITY_CLEAR_TASK
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 清除目标任务栈上所有的 Activity，并将待启动 Activity 的 intent 信息设置给目标任务栈
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4></span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>performClearTaskLocked</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>||</span> isDocumentLaunchesIntoExisting<span style=color:#ff79c6>(</span>mLaunchFlags<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#ff79c6>||</span> isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#6272a4>// 如果设置了 FLAG_ACTIVITY_CLEAR_TOP；android:documentLaunchMode（最近任务列表相关属性）的值是 intoExisting，代表 Activity 重复使用文档的现有任务；launchMode 是 singleInstance 或 singleTask
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 清除待启动 Activity 在任务栈之上的所有 Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord top <span style=color:#ff79c6>=</span> targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>performClearTaskForReuseLocked</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                mLaunchFlags<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addChild</span><span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>top <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>top<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isRootOfTask</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>                top<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>top<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getStack</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>                mTargetStack <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>                        getLaunchStack<span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>,</span> mLaunchFlags<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span> <span style=color:#6272a4>/* task */</span><span style=color:#ff79c6>,</span> mOptions<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addChild</span><span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>!</span>mLaunchTaskBehind <span style=color:#6272a4>/* toTop */</span><span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                        <span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>info</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>flags</span> <span style=color:#ff79c6>&amp;</span> FLAG_SHOW_FOR_ALL_USERS<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_CLEAR_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>mAddingToTask
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>            <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_REORDER_TO_FRONT<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        <span style=color:#6272a4>// 如果设置了 FLAG_ACTIVITY_REORDER_TO_FRONT、没有设置 FLAG_ACTIVITY_CLEAR_TOP 且待启动 Activity 已经在运行中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 将待启动 Activity 提到栈顶并回调 onNewIntent
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#6272a4></span>        <span style=color:#8be9fd;font-style:italic>final</span> ActivityRecord act <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>findActivityInHistory</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>act <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>            <span style=color:#8be9fd;font-style:italic>final</span> Task task <span style=color:#ff79c6>=</span> act<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>            task<span style=color:#ff79c6>.</span><span style=color:#50fa7b>moveActivityToFrontLocked</span><span style=color:#ff79c6>(</span>act<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>            act<span style=color:#ff79c6>.</span><span style=color:#50fa7b>updateOptionsLocked</span><span style=color:#ff79c6>(</span>mOptions<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>act<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>            mTargetStack<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mLastPausedActivity</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>realActivity</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        <span style=color:#6272a4>// 待启动 Activity 的完整组件名如果和目标栈启动栈的 Activity 相同
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTask <span style=color:#ff79c6>==</span> mInTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#6272a4>// 目标任务栈和指定任务栈相同
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 不新建 Activity 实例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_SINGLE_TOP<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>                        <span style=color:#ff79c6>||</span> LAUNCH_SINGLE_TOP <span style=color:#ff79c6>==</span> mLaunchMode<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>                <span style=color:#ff79c6>&amp;&amp;</span> targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>mActivityComponent</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>                <span style=color:#ff79c6>&amp;&amp;</span> mStartActivity<span style=color:#ff79c6>.</span><span style=color:#50fa7b>resultTo</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>            <span style=color:#6272a4>// singleTop 模式下
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 回调 onNewIntent
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isRootOfTask</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>                targetTaskTop<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getTask</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>            deliverNewIntent<span style=color:#ff79c6>(</span>targetTaskTop<span style=color:#ff79c6>,</span> intentGrants<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isSameIntentFilter</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>            <span style=color:#6272a4>// 目标任务栈和待启动 Activity 的 Intent Filter 不同
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 新建 Activity 实例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span><span style=color:#6272a4></span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>reusedActivity <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>            <span style=color:#6272a4>// 没用复用的 Activity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 新建 Activity 实例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#6272a4></span>            mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>resetTask<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>        <span style=color:#6272a4>// 一般从快捷图标或通知中启动
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 需要添加新的 Activity 到 Task 最上面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span><span style=color:#6272a4></span>        mAddingToTask <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>rootWasReset</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span>        <span style=color:#6272a4>// 希望把待启动 Activity 放到目标任务栈底部，但是现在的代码结构做不到，只把待启动 Activity 的 Intent 设置给目标任务栈
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span><span style=color:#6272a4></span>        targetTask<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setIntent</span><span style=color:#ff79c6>(</span>mStartActivity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>当我们单步调试进 <code>complyActivityFlags</code> 会发现，只设置了 <code>FLAG_ACTIVITY_NEW_TASK</code>，没有设置 <code>FLAG_ACTIVITY_CLEAR_TASK</code>、<code>FLAG_ACTIVITY_CLEAR_TOP</code>、<code>FLAG_ACTIVITY_REORDER_TO_FRONT</code>；启动模式是 <code>standard</code>；虽然待启动 Activity 的完整组件名如果和目标栈启动栈的 Activity 相同，但是却又不符合下面的所有判断；虽然可以进入 <code>!resetTask</code> 的分支却被上一个分支截胡……总之完美避过了所有能正常启动的 case。</p><h4 id=resumetopactivityinnerlocked>resumeTopActivityInnerLocked</h4><p>那么不能创建新的 Activity 实例会发生什么呢，这就需要关注 <code>recycleTask</code> 中的一个方法：<code>resumeTargetStackIfNeeded</code>，位于 <code>complyActivityFlags</code> 之后，用于将目标返回栈栈顶的 Activity 回调 <code>onResume</code> 方法，即虽然没有启动 A_Activity，但是把 B_Activity 给重新可见了。由于调用链路过长不多分析，但是层层调用后有一点需要关注，在 <code>ActivityStack#resumeTopActivityInnerLocked</code> 中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStack#resumeTopActivityInnerLocked
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mResumedActivity <span style=color:#ff79c6>==</span> next <span style=color:#ff79c6>&amp;&amp;</span> next<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isState</span><span style=color:#ff79c6>(</span>RESUMED<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#ff79c6>&amp;&amp;</span> taskDisplayArea<span style=color:#ff79c6>.</span><span style=color:#50fa7b>allResumedActivitiesComplete</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    executeAppTransition<span style=color:#ff79c6>(</span>options<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>DEBUG_STATES<span style=color:#ff79c6>)</span> Slog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>d</span><span style=color:#ff79c6>(</span>TAG_STATES<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            <span style=color:#f1fa8c>&#34;resumeTopActivityLocked: Top activity resumed &#34;</span> <span style=color:#ff79c6>+</span> next<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>B_Activity 本身就是 <code>RESUMED</code> 状态，所以会进入这个分支，不再继续 <code>resumeTopActivityInnerLocked</code> 后面的回调 <code>onResume</code> 逻辑直接返回。这就解释了为何 B_Activity 没有生命周期变化。</p><h3 id=原因总结>原因总结</h3><p>我们原因推测时猜想 <code>FLAG_ACTIVITY_NEW_TASK</code> 可以得到证实，那么猜想 MainActivity 的 <code>finish</code> 是在哪里造成影响的呢？其实是 <code>complyActivityFlags</code> 的分支顺序，如果不 finish，目标任务栈启动栈的 Activity 是 MainActivity，跟 A_Activity 不同名，所以会进入 <code>!resetTask</code> 分支，但是如果 finish 掉 MainActivity，目标任务栈启动栈的 Activity 就是第一次启动的 A_Activity，会被截胡而无法进入 <code>!resetTask</code> 分支。</p><p>简单总结一下就是因为启动 Flag，启动模式，现有栈的情况种种机缘巧合，让分支逐一落空导致没有任何 Activity 被启动，既不会回调 <code>onNewIntent</code> 也不会新建一个 Activity 实例。原本会将目标返回栈栈顶的 Activity（即 B_Activity）重新 resume，但是巧合的是 B_Activity 本来就是 <code>RESUMED</code> 状态，所以也就不会回调 B_Activity 的 <code>onResume</code>。种种巧合之下的结果就是看上去什么都没有发生，新启动的 Activity 没有启动，上一个 Activity 的生命周期也不会发生变化。</p><h3 id=解决办法>解决办法</h3><p>梳理清楚了流程解决方案就很简单了，很多地方都有能打破这种奇葩 case 的可能，让 <code>startActivityInner</code> 正常进行后面的逻辑处理，仅列举几个简单的方法，根据自身的业务自行处理：</p><ul><li><p>使得 <code>getReusableTask</code> 中 <code>putIntoExistingTask</code> 为 <code>false</code>：比如设置第二次启动 A_Activity 的 Flag 为 <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_MULTIPLE_TASK</code>；或者如果在允许的条件下（比如不是复现流程时的 Service 中启动），直接去掉 <code>FLAG_ACTIVITY_NEW_TASK</code> 即可。</p></li><li><p>只要让 <code>complyActivityFlags</code> 能进入 <code>mAddingToTask</code> 为 <code>true</code> 的 case ，这里分支非常多，所以方案也更多：比如设置第二次启动 A_Activity 的 Flag 为 <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK</code>；或者就像前面分析 <code>finish</code> 的影响，注意栈的情况不要使得启动栈的 Activity 和待启动的 Activity 相同。</p></li></ul><h2 id=再现异常>再现异常</h2><h3 id=复现流程-1>复现流程</h3><p>根据我们的业务需求，我们选择的方案如下：</p><ol><li><p>Service 附加 <code>FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK</code> 启动 A_Activity，A_Activity 的 launchMode 为 <code>singleInstance</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, AActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java).apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_NEW_TASK or <span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_CLEAR_TASK) })
</span></span></code></pre></div></li><li><p>A_Activity 启动 B_Activity：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java))
</span></span></code></pre></div></li><li><p>同步骤 1 启动 A_Activity。</p></li><li><p>同步骤 2 启动 B_Activity。</p></li></ol><p>此时会出现 B_Activity 没有新建实例，而是会回调 <code>onRestart</code> 启动了第一次创建的 B_Activity。</p><h3 id=源码追踪-1>源码追踪</h3><p>根据上面的分析我们轻车熟路了，这又是某些 case 下没有创建 B_Activity 的实例而直接回调的 <code>onResume</code> 导致的。但是之前无法启动 A_Activity 是因为添加了 <code>FLAG_ACTIVITY_NEW_TASK</code>，然而现在启动 B_Activity 可什么 Flag 都没加，就是最简单的 <code>startActivity</code>，B_Activity 的 launchMode 也是最基本的 <code>standard</code>。</p><p>其实原因依然隐藏在源码中，<code>startActivityInner</code> 会调用 <code>computeLaunchingTaskFlags</code> 来计算启动时的 Flag：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// com.android.server.wm.ActivityStarter
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>computeLaunchingTaskFlags</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ……
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mSourceRecord <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>((</span>mLaunchFlags <span style=color:#ff79c6>&amp;</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> mInTask <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                Slog<span style=color:#ff79c6>.</span><span style=color:#50fa7b>w</span><span style=color:#ff79c6>(</span>TAG<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;startActivity called from non-Activity context; forcing &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>                        <span style=color:#f1fa8c>&#34;Intent.FLAG_ACTIVITY_NEW_TASK for: &#34;</span> <span style=color:#ff79c6>+</span> mIntent<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mSourceRecord<span style=color:#ff79c6>.</span><span style=color:#50fa7b>launchMode</span> <span style=color:#ff79c6>==</span> LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>isLaunchModeOneOf<span style=color:#ff79c6>(</span>LAUNCH_SINGLE_INSTANCE<span style=color:#ff79c6>,</span> LAUNCH_SINGLE_TASK<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            mLaunchFlags <span style=color:#ff79c6>|=</span> FLAG_ACTIVITY_NEW_TASK<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>在不指定启动栈时，三种情况下系统会默认给 Flag 加上 <code>FLAG_ACTIVITY_NEW_TASK</code>:</p><ol><li>没有源 Activity（比如 A 启动 B，则 A 为源 Activity）</li><li>源 Activity 的 launchMode 是 <code>singleInstance</code></li><li>待启动 Activity 的 launchMode 是 <code>singleInstance</code> 或 <code>singleTask</code></li></ol><p>原因就显而易见了，我们的 A_Activity 的 launchMode 是 <code>singleInstance</code>，所以系统给 Flag 加上了 <code>FLAG_ACTIVITY_NEW_TASK</code>，于是又回到了之前分析的场景中。</p><h3 id=解决办法-1>解决办法</h3><p>解决办法上一个场景中也给出了，启动 B_Activity 时加上 <code>FLAG_ACTIVITY_MULTIPLE_TASK</code>即可：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>startActivity(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Intent(<span style=color:#ff79c6>this</span>, BActivity<span style=color:#ff79c6>::</span><span style=color:#ff79c6>class</span>.java)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        .apply { addFlags(<span style=color:#50fa7b>Intent</span>.FLAG_ACTIVITY_MULTIPLE_TASK) })
</span></span></code></pre></div><h2 id=总结>总结</h2><p>Activity 启动这块是非常复杂的，影响的因素也非常多，上面的两个场景还是属于比较简单的，仅仅是 <code>FLAG_ACTIVITY_NEW_TASK</code> 就造成了这么多的问题，而且看起都非常诡异难以排查，更不用说各种启动模式和 Flag 叠加时可能会遇到更多的坑点，不过一旦遇到了这些神坑，其实深入源码去研究有时候反而能更快得到结论。</p><div class="flex flex-row justify-between"><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/hq29/><svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-left"/></svg>使用阿里云效同步 Git 仓库到 Github</a></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/2aa2/>遵循 Google 应用指南的 Retrofit + Coroutine 封装<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#引言>引言</a><ul><li><a href=#基本-launchmode-行为模式>基本 LaunchMode 行为模式</a></li><li><a href=#service-启动-activity>Service 启动 Activity</a></li></ul></li><li><a href=#无法启动的-standard-activity>无法启动的 <code>standard</code> Activity</a><ul><li><a href=#复现流程>复现流程</a></li><li><a href=#原因推测>原因推测</a></li><li><a href=#源码追踪>源码追踪</a></li><li><a href=#原因总结>原因总结</a></li><li><a href=#解决办法>解决办法</a></li></ul></li><li><a href=#再现异常>再现异常</a><ul><li><a href=#复现流程-1>复现流程</a></li><li><a href=#源码追踪-1>源码追踪</a></li><li><a href=#解决办法-1>解决办法</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>