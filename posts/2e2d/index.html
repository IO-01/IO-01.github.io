<!doctype html><html class="scroll-pt-16 scroll-smooth" lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'> <text x='0' y='14'>🧑‍💻</text> </svg>"><link rel=stylesheet href=https://blog.io01.xyz/css/style.css><script type=text/javascript src=https://blog.io01.xyz/js/main.js></script><title>从源码解析一个 SparseArray 线程不安全的崩溃</title></head><body><header class="sticky top-0 z-10 bg-white backdrop-filter backdrop-blur-lg bg-opacity-70 border-b border-gray-200"><nav class="max-w-5xl mx-auto px-4"><div class="flex items-center justify-between h-16"><a href=/ class="text-2xl text-gray-900 font-semibold">IO01 Blog</a><ul class="flex space-x-4 text-gray-900"><li><a href=https://blog.io01.xyz/posts>归档</a></li><li><a href=https://blog.io01.xyz/about>关于</a></li></ul></div></nav></header><div id=content><div class="flex relative justify-center"><article class="w-5/6 md:w-2/3 xl:w-1/2 my-8 px-4 prose max-w-none prose-img:mx-auto"><header class="flex flex-col"><h1 class=text-center>从源码解析一个 SparseArray 线程不安全的崩溃</h1><div class="flex-row mx-auto"><div class=inline-flex><div class="inline-flex items-center not-prose"><svg viewBox="0 0 1 1" class="h-4 mr-1"><use href="#calendar"/></svg><span class=text-gray-500>2023-04-12</span></div><div class="inline-flex items-center ml-2 not-prose"><svg viewBox="0 0 1 1" class="h-4 mx-1"><use href="#tags"/></svg><a href=https://blog.io01.xyz/tags/android/ class="text-gray-500 mr-1">Android</a>
<a href=https://blog.io01.xyz/tags/%E6%BA%90%E7%A0%81/ class="text-gray-500 mr-1">源码</a></div></div></div></header><h2 id=前言>前言</h2><p>工作中遇到一个崩溃，将无关逻辑去掉，最后的崩溃部分是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  Log<span style=color:#ff79c6>.</span><span style=color:#50fa7b>i</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;SparseArray&#34;</span><span style=color:#ff79c6>,</span> sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>).</span><span style=color:#50fa7b>toString</span><span style=color:#ff79c6>());</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>抛出的异常是空指针：<code>java.lang.NullPointerException</code>，其实根据经验也知道是线程安全问题，但是排查的过程中却越来越觉得我们的应用场景中不应该出现 null 的存在。</p><h2 id=排查>排查</h2><h3 id=删除>删除</h3><p>这个问题第一反应是有一个线程从 sparseArray 中删除了对象，然后导致第二次获取成了 <code>null</code>，但是继续排查代码发现并没有任何地方调用过删除（另外根据后面翻阅源码得知 <code>SparseArray#delete()</code> 并不会立刻删除代码，而是先标记为 <code>DELETED</code>）。</p><h3 id=扩容>扩容</h3><p>下一个思路就是类似 HashMap 扩容时搬运数据造成的线程安全问题。但是经检查，所有 <code>sparseArray.put()</code> 的 key 是固定的三个值：0、1、2，甚至都是主线程 put 的，而 SparseArray 初始化的源码可以知道默认构造函数是初始化了两个长度为 10 的数组：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>SparseArray</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>10</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>SparseArray</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> initialCapacity<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>initialCapacity <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        mKeys <span style=color:#ff79c6>=</span> EmptyArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>INT</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        mValues <span style=color:#ff79c6>=</span> EmptyArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>OBJECT</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        mValues <span style=color:#ff79c6>=</span> ArrayUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newUnpaddedObjectArray</span><span style=color:#ff79c6>(</span>initialCapacity<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        mKeys <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[</span>mValues<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    mSize <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><em>有个有趣的点：其中 <code>ArrayUtils.newUnpaddedObjectArray(initialCapacity)</code> 会调用 <code>VMRuntime.getRuntime().newUnpaddedArray(Object.class, minLen)</code> 返回一个至少为 minLen 长度的数组，因为
<a title href=https://en.wikipedia.org/wiki/Data_structure_alignment>数据对齐</a> 可能会分配大于申请的空间使 CPU 读写更加高效，即会有一些 padding 空间，为了不浪费这个空间，直接返回个更大的 array。</em></p><h3 id=重排>重排</h3><p>既然无论如何，都不会有扩容的产生，那么还有什么情况下会造成在某一瞬间会获取到 null 呢？这里需要介绍一下 SparseArray 的基本原理：</p><ul><li>内部结构是两个数组，一个储存 key 的 int 数组，一个储存 value 的 Object 数组。</li><li><code>get()</code> 使用二分查找，所以 key 数组是有序的。</li></ul><p>那么问题就能猜到：会不会是添加数据的时候因为构建有序数组而重排时导致了数据的搬运，我们可以从源码中看一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#6272a4>// android.util.SparseArray
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> key<span style=color:#ff79c6>,</span> E value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span>    <span style=color:#6272a4>// 首先二分查找 key 数组中要插入的 key 的位置，如果存在 key 直接返回 key 的下标，如果不存在，则返回期望插入的位置的取反（参见下面的源码，不详解释）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> ContainerHelpers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span>mKeys<span style=color:#ff79c6>,</span> mSize<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>    <span style=color:#6272a4>// 如果存在 key，直接更新对应的 value 即可
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>&gt;=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span>        mValues<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>        <span style=color:#6272a4>// 如果不存在，则拿到插入期望的位置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#6272a4></span>        i <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>~</span>i<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>        <span style=color:#6272a4>// mSize 是当前实际已插入的数据量，在未调用 gc() 之前包括已经标记为 DELETED 的数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// DELETED 是在 delete() 后并不会立刻删除代码，而是先标记为 DELETED
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 如果期望插入的位置小于 mSize，并且此处是已经被标记删除的数据，则直接更新 kv 两个数组
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>&lt;</span> mSize <span style=color:#ff79c6>&amp;&amp;</span> mValues<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> DELETED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>            mKeys<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> key<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>            mValues<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> value<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>            <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>        <span style=color:#6272a4>// 如果需要垃圾回收并且现在已经插入的数量大于等于 key 数组的长度，则垃圾回收
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mGarbage <span style=color:#ff79c6>&amp;&amp;</span> mSize <span style=color:#ff79c6>&gt;=</span> mKeys<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>            <span style=color:#6272a4>// 将被标记为 DELETED 的位置后面的数据向前搬运来垃圾回收（参见下面的源码，不详解释）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span><span style=color:#6272a4></span>            gc<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>            <span style=color:#6272a4>// 回收后重新查找期望插入的位置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span><span style=color:#6272a4></span>            i <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>~</span>ContainerHelpers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span>mKeys<span style=color:#ff79c6>,</span> mSize<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>        <span style=color:#6272a4>// 通过 System.arraycopy 创建一个插入 i 位置后的递增新数组（参见下面的源码，不详解释）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span><span style=color:#6272a4></span>        mKeys <span style=color:#ff79c6>=</span> GrowingArrayUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insert</span><span style=color:#ff79c6>(</span>mKeys<span style=color:#ff79c6>,</span> mSize<span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>        <span style=color:#6272a4>// 通过 System.arraycopy 创建一个插入 i 位置后的递增新数组
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span><span style=color:#6272a4></span>        mValues <span style=color:#ff79c6>=</span> GrowingArrayUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>insert</span><span style=color:#ff79c6>(</span>mValues<span style=color:#ff79c6>,</span> mSize<span style=color:#ff79c6>,</span> i<span style=color:#ff79c6>,</span> value<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>        <span style=color:#6272a4>// mSize 自增 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span><span style=color:#6272a4></span>        mSize<span style=color:#ff79c6>++;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span><span style=color:#6272a4>// com.android.internal.util.GrowingArrayUtils
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> T<span style=color:#ff79c6>[]</span> <span style=color:#50fa7b>insert</span><span style=color:#ff79c6>(</span>T<span style=color:#ff79c6>[]</span> array<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> currentSize<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> index<span style=color:#ff79c6>,</span> T element<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>    <span style=color:#ff79c6>assert</span> currentSize <span style=color:#ff79c6>&lt;=</span> array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>currentSize <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&lt;=</span> array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arraycopy</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>,</span> index<span style=color:#ff79c6>,</span> array<span style=color:#ff79c6>,</span> index <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> currentSize <span style=color:#ff79c6>-</span> index<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>        array<span style=color:#ff79c6>[</span>index<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> element<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>        <span style=color:#ff79c6>return</span> array<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>    @SuppressWarnings<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;unchecked&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>    T<span style=color:#ff79c6>[]</span> newArray <span style=color:#ff79c6>=</span> ArrayUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>newUnpaddedArray</span><span style=color:#ff79c6>((</span>Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;)</span>array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getComponentType</span><span style=color:#ff79c6>(),</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>            growSize<span style=color:#ff79c6>(</span>currentSize<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arraycopy</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> newArray<span style=color:#ff79c6>,</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> index<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>    newArray<span style=color:#ff79c6>[</span>index<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> element<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>    System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>arraycopy</span><span style=color:#ff79c6>(</span>array<span style=color:#ff79c6>,</span> index<span style=color:#ff79c6>,</span> newArray<span style=color:#ff79c6>,</span> index <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> array<span style=color:#ff79c6>.</span><span style=color:#50fa7b>length</span> <span style=color:#ff79c6>-</span> index<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>    <span style=color:#ff79c6>return</span> newArray<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span><span style=color:#6272a4>// android.util.ContainerHelpers
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> array<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> size<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>    <span style=color:#8be9fd>int</span> lo <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>    <span style=color:#8be9fd>int</span> hi <span style=color:#ff79c6>=</span> size <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>    <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>lo <span style=color:#ff79c6>&lt;=</span> hi<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> mid <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>lo <span style=color:#ff79c6>+</span> hi<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&gt;&gt;&gt;</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>        <span style=color:#8be9fd;font-style:italic>final</span> <span style=color:#8be9fd>int</span> midVal <span style=color:#ff79c6>=</span> array<span style=color:#ff79c6>[</span>mid<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>midVal <span style=color:#ff79c6>&lt;</span> value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>            lo <span style=color:#ff79c6>=</span> mid <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>midVal <span style=color:#ff79c6>&gt;</span> value<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>            hi <span style=color:#ff79c6>=</span> mid <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>        <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>            <span style=color:#ff79c6>return</span> mid<span style=color:#ff79c6>;</span>  <span style=color:#6272a4>// value found
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>~</span>lo<span style=color:#ff79c6>;</span>  <span style=color:#6272a4>// value not present
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span><span style=color:#6272a4>// android.util.SparseArray
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>gc</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>    <span style=color:#8be9fd>int</span> n <span style=color:#ff79c6>=</span> mSize<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>    <span style=color:#8be9fd>int</span> o <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>    <span style=color:#8be9fd>int</span><span style=color:#ff79c6>[]</span> keys <span style=color:#ff79c6>=</span> mKeys<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>    Object<span style=color:#ff79c6>[]</span> values <span style=color:#ff79c6>=</span> mValues<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>;</span> i <span style=color:#ff79c6>&lt;</span> n<span style=color:#ff79c6>;</span> i<span style=color:#ff79c6>++)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>        Object val <span style=color:#ff79c6>=</span> values<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>val <span style=color:#ff79c6>!=</span> DELETED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>!=</span> o<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>                keys<span style=color:#ff79c6>[</span>o<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> keys<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>                values<span style=color:#ff79c6>[</span>o<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> val<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>                values<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>            o<span style=color:#ff79c6>++;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>    mGarbage <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>    mSize <span style=color:#ff79c6>=</span> o<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>源码中影响到 value 数组的操作有 gc 和最后在数组中插入数据。我们的场景不涉及删除，所以不会发生 gc。而且仔细想想这两步，gc 是把后面的数据搬运到被标记为删除的位置；插入元素直接生成新的数组，都不会导致某一时刻 value 数组中曾经的元素为 null。</p><h2 id=原因>原因</h2><p>后面想想其实思路狭隘了，一直考虑的是 value 数组中某个位置的元素在某一时刻变为 null，但是上面的分析来看可能会因为线程不安全造成两次 <code>get()</code> 得到的值不同，但是不会出现其中一次为 null。</p><p>分析 <code>put()</code> 方法最后三行，可以发现 <code>mKeys</code>、<code>mValues</code> 和 <code>mSize</code> 都可能因为多线程执行 <code>get()</code> 导致出现问题，分别对应三种可能：</p><ol><li><code>mKeys</code> 未改变前其他线程 <code>get()</code>。</li><li><code>mValues</code> 未改变前其他线程 <code>get()</code>。</li><li><code>mSize</code> 未改变前其他线程 <code>get()</code>。</li></ol><p>看一下 <code>get()</code> 的源码，非常简单，二分查找 index，从 <code>mValues</code> 数组中取值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd;font-style:italic>public</span> E <span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> key<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#ff79c6>return</span> get<span style=color:#ff79c6>(</span>key<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#8be9fd;font-style:italic>public</span> E <span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> key<span style=color:#ff79c6>,</span> E valueIfKeyNotFound<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> ContainerHelpers<span style=color:#ff79c6>.</span><span style=color:#50fa7b>binarySearch</span><span style=color:#ff79c6>(</span>mKeys<span style=color:#ff79c6>,</span> mSize<span style=color:#ff79c6>,</span> key<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>i <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> mValues<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>==</span> DELETED<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>return</span> valueIfKeyNotFound<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>(</span>E<span style=color:#ff79c6>)</span> mValues<span style=color:#ff79c6>[</span>i<span style=color:#ff79c6>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>为了方便演示，先假设我们的 key 取值为 0、1、2，value 对应取值为"零"、&ldquo;一&rdquo;、&ldquo;二&rdquo;，同时因为数组插入是递增的，涉及到了数组重排，所以我们假设两种场景来：</p><ol><li>新插入的 key 比之前所有的 key 大：假设原有 [0,1] 插入 2。</li><li>新插入的 key 比之前最大的 key 小：假设原有 [0,2] 插入 1。</li></ol><p>那么分析上述三种可能为：</p><ol><li><p><code>mKeys</code> 未改变前相当于还没有执行 <code>put()</code>。</p><ol><li>原有 [0,1] 插入 2：<code>get(1)</code> 会正常返回"一"；<code>get(2)</code> 会因为 <code>binarySearch()</code> 等于 -3，返回默认的 null。</li><li>原有 [0,2] 插入 1：<code>get(1)</code> 会因为 <code>binarySearch()</code> 等于 -2，返回默认的 null；<code>get(2)</code> 会正常返回"二"。</li><li>结论：不可能出现第一次 get 有值但第二次为 null 的情况。</li></ol></li><li><p><code>mValues</code> 未改变前 <code>mKeys</code> 已经插入了新 put 的值。</p><ol><li>原有 [0,1] 插入 2：<code>get(1)</code> 会正常返回"一"；<code>get(2)</code> 会因为 <code>binarySearch()</code> 等于 -3，返回默认的 null。</li><li>原有 [0,2] 插入 1：<code>get(1)</code> 返回“二”；<code>get(2)</code> 会因为 <code>mSize</code> 未改变导致 <code>binarySearch()</code> 等于 -3，返回默认的 null。</li><li>结论：第二种场景出现了没插入前 <code>get(2)</code> 有值，插入之后 <code>get(2)</code> 为 null 的情况。另外值得注意的是此时 <code>get(1)</code> 的返回值也是错误的。</li></ol></li><li><p><code>mSize</code> 未改变前 <code>mKeys</code>和 <code>mValues</code> 都插入了新 put 的值。</p><ol><li>原有 [0,1] 插入 2：<code>get(1)</code>会正常返回"一"；<code>get(2)</code> 会因为 <code>binarySearch()</code> 等于 -3，返回默认的 null。</li><li>原有 [0,2] 插入 1：<code>get(1)</code>会正常返回"一"；<code>get(2)</code> 会因为 <code>binarySearch()</code> 等于 -3，返回默认的 null。</li><li>结论：第二种场景出现了没插入前 <code>get(2)</code> 有值，插入之后 <code>get(2)</code> 为 null 的情况。</li></ol></li></ol><p>所以在发生重排的场景中，有可能因为多线程同时读写出现之前遇到的问题。</p><h2 id=复现>复现</h2><p>既然知道了原因，复现代码还是很简单的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>AtomicBoolean noNull <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AtomicBoolean<span style=color:#ff79c6>(</span><span style=color:#ff79c6>true</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>noNull<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    SparseArray<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;</span> sparseArray <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> SparseArray<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>2</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>new</span> Thread<span style=color:#ff79c6>(()</span> <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>2</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            Log<span style=color:#ff79c6>.</span><span style=color:#50fa7b>d</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;SparseArray&#34;</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;get is null&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            noNull<span style=color:#ff79c6>.</span><span style=color:#50fa7b>set</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>}).</span><span style=color:#50fa7b>start</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>0</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    sparseArray<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>1</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>new</span> Object<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><div class="flex flex-row justify-between"><div class=not-prose></div><div class=not-prose><a class="inline-flex items-center group text-gray-400 hover:text-sky-400" href=https://blog.io01.xyz/posts/6op1/>自建NAS方案选型-基建篇<svg viewBox="0 0 1 1" class="fill-gray-400 group-hover:fill-sky-400 h-4 mx-1"><use href="#angle-right"/></svg></a></div></div></article><aside class="fixed md:left-5/6 xl:left-3/4 hidden md:block top-16 w-1/6 max-h-screen p-4 shadow-md"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#排查>排查</a><ul><li><a href=#删除>删除</a></li><li><a href=#扩容>扩容</a></li><li><a href=#重排>重排</a></li></ul></li><li><a href=#原因>原因</a></li><li><a href=#复现>复现</a></li></ul></nav></aside></div></div><footer><div class="flex justify-center mt-6 mb-2 text-gray-500"><span>&copy;2023
<span class=ml-2><a class=hover:text-sky-400 href=https://blog.io01.xyz>IO01</a></span></span>
<span class=mx-2>|</span>
<span>Powered by
<a class=hover:text-sky-400 href=https://gohugo.io>Hugo</a></span>
<span class=mx-1>&</span>
<span><a class=hover:text-sky-400 href=#>FullMoon</a></span></div></footer></body></html>